<!DOCTYPE html>
<html lang="sw">

<head>
    <title>Alrada</title>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="#">
    <style>
        * {
            vertical-align: baseline;
        }

        body {
            height: 100%;
            margin: 0;
            padding: 0;
            width: 99.708%;
        }

        h4,
        small {
            margin-bottom: 4px;
        }

        small,
        .small,
        #cachedTrans>span {
            font-size: xx-small;
            align-self: center;
        }


        .tunatumaMsg>*>*>.buttonholder {
            display: none;
        }

        li#confirmCachedEntry>div,
        li#confirmTransactionEntry>div {
            width: 100%;
            justify-content: space-between;
        }

        li#confirmCachedEntry>div>div {
            justify-content: space-between;
        }

        li#confirmCachedEntry>div>div>button {

            right: 0px;
            height: 20px;
            width: 30px;
            min-height: unset;
        }

        #loading-text {
            overflow-y: auto;
        }

        #loading-text>code>ul {
            margin-left: 0;
            margin-top: 0;
            padding-left: 0;
            text-align: left;
        }

        #loading-text>code>ul>li {
            overflow-x: auto;
            margin-right: 20px;
            width: 100%;
        }

        li#confirmCachedEntry>div>div>div>a,
        li#confirmTransactionEntry>span>a {
            text-wrap: nowrap;
            text-decoration: none;
            padding-right: 5px;
            width: 100%;
            background: none;
        }

        li#confirmCachedEntry>div>div>div>a {
            color: white;
        }

        span {
            font-weight: bolder;
        }

        li {
            margin-bottom: 1px
        }

        html,
        body,
        button {
            font-size: 11px;
            min-height: 100%;
            width: -webkit-fill-available;
            height: -webkit-fill-available;
        }

        ul {
            padding-left: 0;
            align-items: baseline;
            width: 99%;
        }

        body {
            height: 100%;
            margin: 0;
            padding: 0;
            width: 99.708%
        }

        sub {
            font-weight: 100;
            letter-spacing: 1px;
            text-decoration-line: none;
        }

        h2 {
            margin-block-start: 19px;
            margin-top: 0;
            margin-bottom: 0px;
        }

        #mywebview {
            display: block;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #news_display {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            height: 40px;
            border-bottom: .5px solid lightgray;
        }

        #showTransDate,
        #warehouseName {
            display: -webkit-inline-box;
            -webkit-box-align: center;
            display: flex;
            flex-flow: wrap;
            background: center;
            background-color: none;
            color: black;
            align-items: center;
            max-width: 100px;
            border: none;
            text-align: right;
            font-family: monospace;

        }

        #appState,
        #choose-mode>ul>li {
            border: none;
            border: 1px solid #000000de;
            box-shadow: 0px 0px 4px 2px black;
        }

        #appState:active,
        #choose-mode>ul>li:active {
            box-shadow: inset 0px 0px 4px 2px black;
        }

        #appStates {
            width: 100%;
            border: none;
            font-size: 12pt;

        }

        #appState>span {
            font: icon;
        }

        #warehouseName {
            display: -webkit-inline-box;
            -webkit-box-align: center;
            width: 65px;
            display: flex;
            background: center;
            align-items: center;
        }


        #filter-dialog>div>li {
            border-bottom: 1px solid #a7a7a7;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            width: 100%;
            padding-top: 4px;
            padding-bottom: 4px;
            margin: 0;
        }

        .flex-row,
        li {
            display: flex;
            flex-direction: row;
            margin-bottom: 5px
        }

        .half-row {
            display: flex;
            flex: 0 0 50% !important
        }

        .flex-column {
            display: flex;
            flex-direction: column
        }

        a {
            text-decoration: none;
            border: none;
            display: flex;
            color: inherit;
        }

        #myforms {
            width: 100%;
            display: flex;
            justify-content: center;
            position: absolute;
            top: 0px;
        }

        .wholesale_sale>* button,
        #productsview.wholesale_sale>* li>a>span {
            background-color: #00c853
        }

        .wholesale_sale,
        .wholesale_sale>#news_display>* .highlight-border {
            border-color: #00c853 !important
        }

        .wholesale_purchase_delivered>* button,
        #productsview.wholesale_purchase_delivered>ul>li>a>span {
            background-color: #a200ff;
            color: #fff;
        }

        .wholesale_purchase_delivered,
        #mywebview.wholesale_purchase_delivered>#news_display>* .highlight-border {
            border-color: #a200ff !important
        }

        #mywebview.wholesale_purchase>* button,
        #productsview.wholesale_purchase>ul>li>a>span {
            background-color: #ffc400;
            color: #000
        }

        .wholesale_purchase,
        .wholesale_purchase>#news_display>* .highlight-border {
            border-color: #ffc400 !important
        }


        .sent2_bank>div>* button,
        #productsview.sent2_bank>ul>li>a>span {
            background-color: #d50000;
            color: #fff;
        }

        .sent2_bank,
        .sent2_bank>#news_display>* .highlight-border {
            border-color: #d50000 !important
        }

        .stocktake>div>* button,
        #productsview.stocktake>ul>li>a>span {
            background-color: #e1e1e1;
            color: #000;
        }

        .stocktake,
        .stocktake>#news_display>* .highlight-border {
            border-color: #e1e1e1 !important;
        }

        .products>li,
        .customers>li,
        .suppliers>li {
            border: .2px solid #ccc;
            display: flex;
            flex: 1 0 auto;
            flex-basis: auto;
            flex-grow: 1;
            margin-bottom: 6px;
            text-align: -webkit-center;
        }

        #CustomersList>li>a,
        #results>li>a {
            flex-flow: column;
            place-content: space-between;
            text-decoration: none;
            white-space: nowrap;
            min-height: 60px;
            font-size: 3vw;
            justify-content: center;
            margin: 0;
            width: 100%;
            text-wrap: wrap;
        }

        #CustomersList>li>a>span,
        #results>li>a>span {
            align-self: stretch;
            background-color: #483d8b;
            color: #fffff0;
            font-size: small;
            margin-bottom: 0;
            pointer-events: none;
            display: flex;
            place-content: space-between;
        }

        #results>li:hover {
            opacity: 1 !important;
        }

        #myinputbar input:focus,
        #CustomersList>li>a.pressed,
        #results>li>a:hover,
        #results>li>a.pressed,
        #results>li>a:active,
        .processed,
        #filter-dialog>div>li.selected {
            background-color: #FAF9CB;
            border: 2px solid #a4a4a4;
            border-color: #000;
            padding-top: 0;
        }

        #results>li>a>input {
            display: flex;
            text-align: center;
        }

        li.product.hovering {
            margin: 0;
            order: -1;
            position: sticky;
            min-width: 60%;
            opacity: 1;
            top: 0px;
            z-index: 90;
        }

        .btn {
            align-items: center;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            box-shadow: 0 .2rem .4rem #0006 0 -.3rem .6rem #0003 inset;
            color: var(--color);
            font-family: inherit;
            font-weight: 900;
            justify-content: center;
            padding: .6rem;
            position: relative;
            transition: box-shadow 64ms ease-out;
            --background-color: #d8d8d8;
            --border-color: #c7c7c7;
            --color: #000
        }

        .btn:after {
            background-color: #fff;
            content: "";
            filter: blur(0.15rem);
            height: 12.5%;
            left: 12.5%;
            position: absolute;
            top: .15rem;
            transition: opacity 64ms ease-out;
            width: 75%
        }

        .btn:active {
            box-shadow: 0 0 0 #0006 0 .4rem 1rem #0000004d inset
        }

        .btn:active:after {
            opacity: 0;
        }

        .btn:hover {
            border: 1px solid #000;
        }

        .btn-color-wholesale_sale {
            --background-color: #00c853;
            --border-color: #00a243;
            --color: #fff
        }

        .btn-color-wholesale_sale:active {
            --color: #ececec
        }

        .btn-color-wholesale_purchase {
            --background-color: #ffc400;
            --border-color: #d9a700;
            --color: #3e2723
        }

        .btn-color-wholesale_purchase:active {
            --color: #261815
        }

        .btn-color-sent2_bank {
            --background-color: #d50000;
            --border-color: #af0000;
            --color: #fff
        }

        .btn-color-sent2_bank:active {
            --color: #ececec
        }

        .btn-color-wholesale_purchase_delivered {
            --background-color: #483d8b;
            --border-color: #544b89;
            --color: #fff
        }

        .btn-color-wholesale_purchase_delivered:active {
            --color: #ececec
        }

        .pressed,
        button:active {
            border-color: #817;
            box-shadow: inset 0 0 5px #a9a;
            color: #817;
            text-decoration: overline
        }

        #numberpadfunctions {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            width: 60px
        }

        #istax {
            color: #8b0000;
            display: none;
            font-weight: bolder
        }

        #submitbuttonholder>a {
            height: 61px
        }

        #submitbuttonholder>div {
            display: flex;
            flex-flow: row
        }

        #myinputbar {
            background: #fffaf0;
            justify-content: space-between;
            padding: 0 2px 0;
            position: sticky;
            top: 0;
            min-height: 35px;
        }

        #myinputbar>div {
            display: contents
        }

        #myinputbar>div>div {
            display: inline-flex;
            justify-content: flex-end
        }

        #myinputbar input {
            -moz-box-shadow: 0 -1px .1px 3px #0000003d inset;
            -webkit-box-shadow: 0 -1px .1px 3px #0000003d inset;
            border-left: none;
            border-right: none;
            border-top: none;
            box-shadow: 0 -1px .1px 3px #0000003d inset;
            font-weight: bolder;
            text-align: center;
            width: 100%
        }

        #myinputbar>div>input:active {
            background: bottom;
            border: 2px solid #000;
            border-color: #8b4513
        }

        #myinputbar * span {
            background: #f0f8ff;
            border-color: #deb887;
        }

        #search {
            width: 280% !important
        }

        #feedbackpack>button {
            height: 100%
        }

        .hidden,
        .disabled,
        .hiddenpreview,
        #feedbackpad {
            display: none !important;
            visibility: hidden !important;
            max-height: 0px !important;
            max-width: 0px !important;
        }

        #resultpad {
            background: #f5f5f5;
            display: block;
            min-height: 120px;
            margin: 0;
            margin-top: 3px;
            max-width: 100vw;
            overflow-y: auto;
            padding: 2px;
            position: relative;
        }

        .left {
            text-align: left;
        }

        .right {
            text-align: right;
        }

        #result_display {
            font-family: monospace;
            height: 100%;
            padding-left: 3px;
            text-align: left;
            width: 100%;
            font-size: small;
        }



        div#result_display>ul>li.total {
            position: sticky;
            bottom: 0;
            border-top: 1px solid #efefef;
            background-color: whitesmoke;
            width: 70%;
            font-weight: bold;
        }

        div#result_display>ul>li>div {
            min-width: 245px;
            align-items: baseline;
            font-weight: 100;
        }

        div#result_display>ul>li>div>div>a {
            align-self: center;
        }

        div#result_display>ul>li>div>button {
            border: none;
            background-color: transparent;
            margin-left: 10px;
        }

        div#result_display>ul>li>span>a {
            border-bottom: 1px solid burlywood;
            margin: 3px;
            border-top: 0px;
            background-color: transparent;
            text-decoration: solid;
            padding-top: none;
            font-weight: 100;
        }

        #mywebview2 {
            height: 97%;
            margin: 0;
            padding: 0;
            width: 100%
        }

        .loading-content {
            position: absolute;
            z-index: 100;
        }

        #productsview {
            border: 1px solid #000;
            overflow-x: HIDDEN;
            overflow-y: auto;
            height: -webkit-fill-available;
            position: relative;
        }

        #mysubmitbar,
        li.product>span,
        .mypopupdialog>div>div {
            display: flex;
            place-content: space-between
        }

        #myinputbar.hyper {
            max-height: 21px;
            min-width: 100%;
            position: relative;
        }

        #mywebview3>div>.righthalf>a.btn {
            height: 40%;
            padding: 1%
        }

        #CustomersList,
        #results {
            display: flex;
            flex-wrap: wrap;
            top: 0;
            left: 0;
            padding: 0;
            margin: 0;
            list-style-type: none;
            max-width: 100vw;
            overflow-y: auto;
            overflow-x: none;
            position: sticky;
            max-height: 100%;
        }

        @media (max-width: 400px) {
            #cachedTrans {
                margin-top: -50px !important;
            }
        }

        @media (min-width: 100px) {

            .products>li {
                flex-basis: calc(50% - 10px)
            }

            #results>li>a {
                font-size: 5vw;
                letter-spacing: 2px
            }

            #results>li>a>span {
                margin-top: 2px;
            }
        }

        @media (min-width: 500px) {
            .products>li {
                flex-basis: calc(33.33% - 10px)
            }

            #results>li>a {
                font-size: 3vw
            }
        }

        @media (min-width: 700px) {
            .products>li {
                flex-basis: calc(25% - 10px)
            }
        }

        @media (min-width: 900px) {
            .products>li {
                flex-basis: calc(20% - 10px)
            }
        }

        .mypopupdailog>div>input {
            text-align: justify;
            text-align: center;
            border-left: none;
            border-right: none;
            border-top: none;
            border-width: thin;
            background-color: beige;
        }

        #filter-dialog,
        #processmsg-dialog,
        .mypopupdialog {
            background-color: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 2px 5px #0003;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            position: absolute;
            min-width: 70%;
            z-index: 200;
            align-items: center;
            top: 110px;
        }

        .mypopupdialog>*>li>a {
            border: none;
            text-decoration: none;
            width: 100%;
            justify-content: center;
        }

        #filterCategories {
            overflow-y: auto;
            max-height: 184px;
            border: 1px solid black;
            display: ruby;
        }

        #filterCategories>li,
        #choose-mode>ul>li {
            font-size: larger;
            place-content: center;
            border: .5px solid #b4b0b0;
            margin-left: 4px;
            margin-right: 4px;
            padding-left: 3px;
            padding-right: 2px;
            padding-top: 12px;
            padding-bottom: 12px;
        }

        #choose-mode>ul>li>a {
            height: 63px;
            align-items: center;
        }

        .mypopupdialog>.buttonholder {
            display: flex;
            margin-top: 10px
        }

        #filter-dialog-transDate>div>div>button {
            font-size: large;
            padding-left: 0px;
            padding-right: 0px;
            margin: unset;
        }

        .mypopupdialog>button {
            margin: 3px;
            position: absolute;
            right: 10px;
            top: 10px
        }

        #filter-categories {
            list-style: none;
            padding: 0
        }

        #filter-categories li {
            margin-bottom: 5px
        }

        #filter-categories input[type="checkbox"] {
            margin-left: 5px
        }

        li.product {
            display: none !important;
            width: -moz-fit-content;
            width: fit-content;
            margin-right: 10px;
        }

        li.product.active {
            display: block !important
        }

        #mywebview3 {
            border: 2px solid #000;
            bottom: 0;
            display: flex;
            height: 22px;
            position: fixed;
            width: 99.4%;
        }

        #cachedTrans {
            align-items: center;
            flex-flow: column;
            max-height: 20px;
            max-width: 110px;
            margin-top: -30px;
            text-wrap: wrap;
        }

        #cachedTrans>span {
            width: 100%;
            text-wrap: wrap;
            margin-top: 10px;
        }

        .notbutton,
        .notbutton>* {
            background-color: transparent !important;
            border: none
        }

        .loading-content {
            background-color: #000c;
            border-radius: 10px;
            color: #fff;
            display: flex;
            flex-direction: column;
            height: 60%;
            justify-content: space-around;
            left: 50%;
            padding: 10px;
            position: fixed;
            text-align: center;
            top: 45%;
            transform: translate(-50%, -50%);
            width: 75%
        }



        #btnClose,
        #close-dialog {
            height: 20px;
            position: fixed;
            right: 1px;
            top: 1px;
            width: 20px;
            max-height: 25px;
            min-height: unset;
        }

        #cachedTrans>span>span.part1 {
            background: none;
            border-bottom: none;
            border-left: 1px solid #000;
            border-radius: 4px;
            border-right: 1px solid #000;
            border-top: none;
            font-size: revert;
            margin-left: 10px;
            padding-left: 4px;
            padding-right: 4px;
            width: max-content;
        }

        #myModal {
            margin: auto;
            padding: 0;
            width: 80%;
        }

        #myModal>.editvalues {
            flex-direction: row;
            display: flex;
            position: relative;
            max-height: 25px;
            flex-wrap: wrap;
            padding-bottom: 20px;
            text-align: -webkit-left;
            justify-content: space-between;
        }

        #myModal>.editvalues>* {
            text-wrap: nowrap;
            margin: -3px;
            margin-left: 5px;
            margin-right: 5px;
            margin-top: 3px;
            text-align: center;
            background-color: white;
            color: black;
            width: max-content;
            padding-left: 4px;
            padding-right: 4px;
            font-stretch: ultra-condensed;
        }

        #myModal>.editvalues>.notyet {
            background-color: transparent;
            color: white;
            border: none;
        }

        #edit_multiplier {
            max-width: 60px;
        }

        #myModal>.editvalues>input.disabledfont {
            color: white;
        }

        #myModal>.buttonholder {
            margin-top: 10px;
        }

        .selectproduct {
            border: 1px solid gray;
            height: 200px;
            overflow-y: auto;
            flex-flow: wrap;
        }

        .selectproduct>li>a>input {
            display: none;
        }

        .shownpreview {
            color: yellow;
            background-color: black !important;
        }

        .attentionparent {
            background: tomato;
            border: 1px solid #d50000 !important;
            font-size: x-large !important;
        }

        .attention {
            color: white;
            background-color: #d50000 !important;
        }

        .product.unavailable {
            opacity: 0.15;
        }

        .latestupdate {
            color: gray;
            opacity: 0.5;
            z-index: 9;
            position: fixed;
            bottom: 0;
            left: 0;
            padding-left: 9px;
            padding-top: 12px;
        }
    </style>
</head>
<div id="mywebview" class="wholesale_sale">
    <div id="news_display">
        <div id="appStates" class="flex-column">
            <button id="appState" class="highlight-border">
                <span>üí∞</span><span>MAUZO</span>
            </button>
        </div>
        <button onclick="getwarehouseName()" id="warehouseName">HQ</button>
        <button id="showTransDate" onclick="getShopDate()"><span>29/04/2024</span></button>

    </div>
</div>
<div id="mywebview2" class="flex-column">
    <div id="resultpad" class="flex-column">
        <div id="result_display">
            <ul></ul>
        </div>
    </div>
    <div id="myinputbar" class="flex-row"><input class="" type="text" id="search"
            placeholder="üîç Tafuta Kinwaji" /><input disabled class="disabled highlight-border" type="number"
            id="inputnumber_change" placeholder="Lipa" value="" />
        <button id="filter" class="functionpad">üéöÔ∏è</button>
        <button disabled id="btnSend2Cache" onClick="addTransactionToCache(event)"
            class="functionpad disabled">‚û°Ô∏è</button>
        <button id="cachedTrans" class="flex-row notbutton">
            <span class="hiddenpreview">BADO REPOTI <sub>üëáüèΩ HAIJATUMWA !
                    üëáüèΩ</sub></span>
            <span>
                <span class="part2 highlight-border">-</span>
                <span class="part1 highlight-border">-</span>
            </span>
        </button>
    </div>
    <div id="productsview" class="wholesale_sale">
        <ul id="results" class="products"></ul>
    </div>
    <div class="flex-column">
        <div id="mysubmitbar" class="flex-row hidden">
            <div id="numberpadfunctions"><button id="istax" class="functionpad">T</button></div>
            <div id="submitbuttonholder"><a id="submitbutton" href="/#+"
                    class="submitbutton togglewholesale_sale btn"><span>
                        <span>üí∞</span><span>MAUZO</span>
                    </span><span>Peleka</span></a></div>
        </div>
    </div>
</div>
<div id="myforms">
    <div id="loading-screen" class="hidden">
        <div class="loading-content">
            <h2 id="loading-title" class="sr-only">Tafadhali Subiri</h2>
            <div class="spinner-border" role="status"><small id="loading-subtitle"></small></div>
            <div id="loading-text" class="loading-text">
                ...
            </div>
            <div class="buttonholder"></div>
        </div>
    </div>
    <div id="choose-mode" class="hidden mypopupdialog">
        <h2 id="selectmode">Select Mode</h2>
        <ul>
            <li class="wholesale_sale"><a href="#" onclick="ChangeView('0',event)"><span>üí∞</span><span>MAUZO</span></a>
            </li>
            <li class="wholesale_purchase"> <a href="#"
                    onclick="ChangeView('2',event)"><span>‚ûï</span><span>UPOKEZI</span></a>
            </li>
            <li class="sent2_bank"><a href="#" onclick="ChangeView('1',event)"><span>ü§åüèΩ</span><span>MALIPO</span></a>
            </li>
            <li class="stocktake"><a href="#" onclick="ChangeView('3',event)"><span>#Ô∏è‚É£</span><span>STOCK</span></a>
            </li>
            <li class="hidden"><a href="#" onclick="ChangeView('4',event)"><span>üí±</span><span>MANUNUZI</span></a></li>
        </ul>
        <a id="updateStr" href="#" class="small" onClick="fetchProductUpdate()">update<span> </span> </a>
    </div><textarea id="clipboard" class="hidden" value="Alrada" placeholder="" title="clipboard"></textarea>
    <div id="filter-dialog" class="hidden mypopupdialog"></div>
    <div id="querydialog" class="hidden mypopupdialog"><input id="traditionalQueryInput" title="query" placeholder=""
            type="text" /></div>
    <div id="processmsg-dialog" class="hidden mypopupdialog"></div>
    <div id="filter-dialog-products" class="hidden mypopupdialog">
        <h4>CHAGUA PRODUCT</h4>
        <small>KWA Mfano <i>'Uhai 1.6</i> </small>
        <div>
            <input id="editProductName" title="Edit Product Name" placeholder="Chagua Product" />
        </div>
        <ul id="ProductsList" class="products selectproduct"></ul>
    </div>
    <div id="filter-dialog-products2" class="hidden mypopupdialog">
        <h4>CHUJA AINA PRODUCTS</h4>
        <ul id="filterCategories"></ul>
        <div>
            <label for="financial_nps">Vipaombele NPS </label>
            <input type="range" min="0" max="10" id="financial_nps" value="0">
            <label for="filter_speed">Kasi ya Kutembeya</label>
            <input id="filter_speed" type="range" min="0" max="5">
        </div>
    </div>
    <div id="filter-dialog-customers" class="hidden mypopupdialog">
        <h4>INGIZA JINA LA MTEJA</h4>
        <small>KWA Mfano <i>MAMA ALAN @Majengo</i> </small>
        <div>
            <input id="editCustomerName" placeholder="hq" />
        </div>
        <ul class="selectproduct customers" id="CustomersList"></ul>
    </div>
    <div id="filter-dialog-transDate" class="hidden mypopupdialog">
        <h4>INGIZA TAREHE</h4>
        <small>KWA Mfano <i>31/1/2025</i> </small>
        <div>
            <input id="editTransDate" title="Tarehe" onkeyup="confirmFormEdit(event)" />
            <div><button id="editTransDateleft" class="flex-row">‚¨ÖÔ∏è</button><button id="editTransDateRight">‚û°Ô∏è</button>
                <button id="editTransDateSubmit">Ok</button>
            </div>
        </div>
        <ul></ul>
    </div>
    <div class="latestupdate" onClick="fetchProductUpdate(false)"> - - </div>
</div>

</html>
<script>
    function wait(ms) {
        var start = new Date().getTime();
        var end = start;
        while (end < start + ms) {
            end = new Date().getTime();
        }
    }
    function show(msg, timer = false, clip = true, flash = true) {
        try {
            /* log errors */
            setGlobal("ALDLOG", global("ALDLOG") + "\n<<<>>>\n" + msg);
            if (clip) setClip("show():" + msg, false);
            if (flash) flashLong(msg);
        } catch (e) { }
        if (timer) wait(5000);
        console.log("log: " + msg);
    }
    function goto(location) {
        /* if in tasker*/
        if (typeof createScene !== 'undefined') {
            window.location.href = location;
        } else {
            console.log("goto: " + location);
        }
    }

    try {
        const appStates = ['wholesale_sale', 'sent2_bank', 'wholesale_purchase_delivered', 'stocktake'],
            appStateMarks = ['”ø', '$', '++', '#'],
            AppScriptPostUrl = "https://script.google.com/macros/s/AKfycbz0MTsq8zYg3Fc2sZI9HrsVWLYPhg_BcUbeegi1DwvQ1hnmUT4-ju46CYXNeuahMeZ2/exec";

        var settingsObj = {
            "products": undefined,
            "staff_suppliers_customers": undefined
        },

            eventKeyUpEnter = new KeyboardEvent('keyup', {
                key: "Enter",
                keyCode: 13
            }),

            specialTransType = "", extraTransDetails = "",
            BreakException = {},
            isMultTextArray = {},
            products_jsonString = {},
            suppliers_jsonString = {},
            customers_jsonString = {},
            productsJsonString = undefined,
            isoncurrenttime = true,
            daystakeawayfromcurrent = 0;
        dontsubmit = false,
            currentAppStateIndex = 0,
            keysPressed = [],
            ProductNamesLiWithInput = [],
            ProductNamesLiWithOutInput = [],
            CustomerNamesLiWithoutInput = [],
            categories = {},
            npsValues = {},
            runningSpeedRanges = {},
            partOfDay = "Saa za Kufunga",
            currentTransDateStr = "",
            currentTransDateStr_Official = "",
            ald_lstreply = "",
            writtenInSearch = "",
            editingquery = "",
            productdetails_string = "",
            staffName = (typeof staffName == "undefined") ? "Al" : staffName,
            warehouseName = staffName,
            responseClone = "",
            confirmAddReportToCache = function () { },
            confirmSendReportRightAway = function () { },
            confirmFormYes = function () { },
            confirmFormNo = function () { },
            confirmFormEdit = function () { },
            confirmFormPick = function () { },
            finalResponseMsg = "",
            newlink = "", inputnum = "", iswholesale_purchaseText = "", prefix = "",
            currentFocusedProduct = "", oldFocusedProduct = "",
            tempTransQuery = [],
            tempTransObj = [],
            cachedTransObjectString = [],
            cachedTransObjectJson = [],
            cachedTransCount = [],
            cachedTransCashTotal = [],
            cachedTempTrans2Process = [],
            cachedTransactionQueries = [],
            results = document.getElementById('results');

        if (typeof createScene !== "function") { /* not in tasker*/
            function setGlobal(variableName = "", value = "") {
                const existingValue = localStorage.getItem(variableName);
                if (existingValue !== null) {
                    if (existingValue !== value) {
                        localStorage.setItem(variableName, value);
                    }
                } else {
                    localStorage.setItem(variableName, value);
                }
            }
            function global(variableName = "", par2 = "") {
                var storedValue = localStorage.getItem(variableName);
                return (storedValue != null) ? storedValue : null;
            }
            function setClip(par1 = "", par2 = "", callback = undefined) {
                try {
                    const clipboard = document.getElementById("clipboard");
                    clipboard.value = par1;
                    clipboard.focus();
                    if (typeof callback != "undefined") {
                        navigator.clipboard.writeText(clipboard.value).then(callback);
                    }
                } catch (e) {
                    show("error copying: " + e.message);
                }

            }
            function flashLong(par1 = "", par2 = "") { }
        }


        function updateTime() {
            var timeAppRefreshed = new Date();

            var year = timeAppRefreshed.getFullYear(),
                month = timeAppRefreshed.getMonth() + 1,
                day = timeAppRefreshed.getDate() + daystakeawayfromcurrent,
                hour = (timeAppRefreshed.getUTCHours() + 3),
                minute = timeAppRefreshed.getMinutes(),
                seconds = timeAppRefreshed.getSeconds();

            let partOfDay;

            if (hour >= 5 && hour < 12) {
                partOfDay = "Asubuhi";
            } else if (hour >= 12 && hour < 18) {
                partOfDay = "Mchana";
            } else if (hour >= 18 && hour < 21) {
                partOfDay = "Jioni";
            }

            var formattedDate = `${day}/${month}/${year}`;
            var formattedTime = `${hour}:${minute}:${seconds}`;

            currentTransDateStr = `${formattedDate} ${formattedTime}`;
            currentTransDateStr_Official = `${eval(timeAppRefreshed.getMonth() + 1)}/${timeAppRefreshed.getDate()}/${timeAppRefreshed.getFullYear()} ${formattedTime}`;

            document.querySelector("#showTransDate>span").innerHTML = currentTransDateStr;
            document.getElementById("editTransDate").value = currentTransDateStr;
        }

        updateTime();
        setInterval(updateTime, 1000);

        if (!String.prototype.replaceAll) {
            String.prototype.replaceAll = function (search, replacement) {
                return this.replace(new RegExp(search, 'g'), replacement);
            };
        }

        function getwarehouseName() {
            document.getElementById('filter-dialog-customers').classList.remove('hidden');
            document.querySelector('#filter-dialog-customers>div>input').focus();
        }

        function getShopDate() {
            document.getElementById('filter-dialog-transDate').classList.remove('hidden');
            document.querySelector('#filter-dialog-transDate>div>input').focus();
        }

        try {
            if (global('ALDSETTING')) {
                var settingsObj = JSON.parse(global('ALDSETTING'));
                createProductsView();
                loadCachedTrans();
            }
            else if (settingsObj.products != undefined) {
                createProductsView();
                loadCachedTrans();
            }
            else {
                fetch('https://raw.githubusercontent.com/iamalbertly/AlradaHTM/main/alradasettings.json')
                    .then(response => {
                        responseClone = response.clone();
                        if (!response.ok) {
                            responseClone.text()
                                .then(function (bodyText) {
                                    show("recieved the following: " + bodyText);
                                });
                            return response.text().then(text => {
                                throw new Error('Server response: ' + text, true, true);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        settingsObj = data;
                        setGlobal('ALDSETTING', JSON.stringify(settingsObj));
                        createProductsView();
                        loadCachedTrans();

                    })
                    .catch((error) => { });
            }

            if (global('ALRADAUSER'))
                staffName = global('ALRADAUSER');
            ald_lstreply = global('ALDLSTREPLY');

            staffName = (staffName == "") ? "XX" : staffName;
        } catch (e) {
            show("error laoding defaults: " + e.stack, true);
            ald_lstreply = ".* ,mauzo yako yana kadiriya...";
        }


        function ChangeView(index = "", e = undefined) {
            var oldstate = appStates[currentAppStateIndex];
            if (index == "" && index != 0) {
                currentAppStateIndex++;
            } else {
                currentAppStateIndex = eval(index);
                var local_appstate = appStates[currentAppStateIndex];
            }
            var appStates_btn = document.getElementById("appStates");
            appStates_btn.classList.remove(`btn-color-${oldstate}}`);

            document.getElementById("productsview").className = "";
            clearvalues();
            createProductsView();
            switch (local_appstate) {
                case "wholesale_sale":
                    status_display = "<span>üí∞</span><span> MAUZO</span>";
                    break;
                case "sent2_bank":
                    status_display = "<span>ü§åüèΩ</span><span> MALIPO</span>";
                    break;
                case "wholesale_purchase_delivered":
                    status_display = "<span>‚ûï</span><span> UPOKEZI</span>";
                    break;
                case "wholesale_purchase":
                    status_display = "<span>üí±</span><span> MANUNUZI</span>";
                    break;
                case "stocktake":
                    status_display = "<span>#Ô∏è‚É£</span><span> STOCK</span>";
                    break;
                default:
            }
            if (typeof tempTransQuery[local_appstate] != "undefined" && (tempTransQuery[local_appstate] != "")) {
                productdetails_string = GetProductDetails(tempTransQuery[local_appstate]);
                tempTransObj[appStates[currentAppStateIndex]] = JSON.parse(productdetails_string);

                document.querySelector("#result_display>ul").innerHTML = tempTransObj[appStates[currentAppStateIndex]].finalResponseMsg.replaceAll("\n", "<br/>");
                document.querySelectorAll(".disabled").forEach(el => {
                    el.disabled = false;
                    el.classList.remove("disabled");
                    el.classList.add("enabled");
                });
            } else {
                productdetails_string = "", tempTransObj[appStates[currentAppStateIndex]] = {},
                    document.querySelector("#result_display>ul").innerHTML = "";
            }

            document.getElementById("mywebview").classList.value = "";
            document.getElementById("mywebview").classList.add(local_appstate);
            document.getElementById("productsview").classList.add(local_appstate);
            appStates_btn.classList.add("btn-color-" + local_appstate);
            document.getElementById("appState").innerHTML = status_display;

            document.querySelector("#cachedTrans>span>.part1").innerHTML = ((!cachedTransCount[appStates[currentAppStateIndex]]) ? 0 : cachedTransCount[appStates[currentAppStateIndex]]);
            document.querySelector("#cachedTrans>span>.part2").innerHTML = ((!cachedTransCashTotal[appStates[currentAppStateIndex]]) ? 0 : cachedTransCashTotal[appStates[currentAppStateIndex]].toLocaleString('en-US').replace(/\.00/g, ""));

            closeFilterDialog();
            /*set the view into cache*/
            setGlobal(`ALDSTATE`, currentAppStateIndex);

        }

        function loadCachedTrans() {
            try {
                try {
                    for (const TransType in appStates) {
                        if (global(`ALDTMP${appStates[TransType]}`)) {
                            tempTransQuery[appStates[TransType]] = global(`ALDTMP${appStates[TransType]}`);
                            if (TransType == '0' && typeof tempTransQuery['wholesale_sale'] != "undefined" && (tempTransQuery['wholesale_sale'] != "")) {
                                productdetails_string = GetProductDetails(tempTransQuery['wholesale_sale']);
                                tempTransObj[appStates[currentAppStateIndex]] = JSON.parse(productdetails_string);

                                document.querySelector("#result_display>ul").innerHTML = tempTransObj[appStates[currentAppStateIndex]].finalResponseMsg.replaceAll("\n", "<br/>");
                                document.querySelectorAll(".disabled").forEach(el => {
                                    el.disabled = false;
                                    el.classList.remove("disabled");
                                    el.classList.add("enabled");
                                });
                            }
                        }

                        if (global(`ALDCACHE${appStates[TransType]}`)) {
                            cachedTransactionQueries[appStates[TransType]] = global(`ALDCACHE${appStates[TransType]}`);
                            cachedTransCount[appStates[TransType]] = cachedTransactionQueries[appStates[TransType]].split("||").length;
                            query = cachedTransactionQueries[appStates[TransType]];

                            cachedTransObjectString[appStates[TransType]] = GetProductDetails(query);
                            cachedTransObjectJson[appStates[TransType]] = JSON.parse(cachedTransObjectString[appStates[TransType]]);

                            var total = /TOTAL:\sTZS\s(\d+,{0,1}\d+,{0,1}\d+,{0,1}\d+)/gm.exec(cachedTransObjectJson[appStates[TransType]].finalResponseMsg);

                            if (total != null) cachedTransCashTotal[appStates[TransType]] = eval((total.length > 0) ? eval(total[1].replaceAll(",", "")) : 0);
                        } else {
                            cachedTransCount[appStates[TransType]] = 0;
                            cachedTransCashTotal[appStates[TransType]] = 0;
                        }
                    }
                    document.querySelector("#cachedTrans>span>.part1").innerHTML = cachedTransCount[appStates[0]];
                    document.querySelector("#cachedTrans>span>.part2").innerHTML = cachedTransCashTotal[appStates[0]];
                    document.querySelectorAll(".hiddenpreview").forEach(el => {
                        el.classList.remove("hiddenpreview");
                        el.classList.add("shownpreview");
                    });

                } catch (e) { show(`Error Loading CachedTrans loadCachedTrans(): ${e.stack}`) }
            } catch (e) { show("error loadCachedTrans::" + e.stack, true); }

        }

        function createList(products = ProductNamesLiWithInput, holderElement, hasinput = true) {

            try {
                var products_contents = "";
                products.forEach(productLink => {
                    products_contents += productLink;
                });
                holderElement.innerHTML = products_contents;

                if (holderElement.id == "results") {
                    for (var productlp = 0; productlp < products.length; productlp++) {
                        var el = (typeof holderElement.childNodes[productlp].childNodes[1] != "undefined") ? holderElement.childNodes[productlp].childNodes[1] : holderElement.childNodes[productlp].childNodes[0];

                        if (hasinput && el.parentNode.classList.contains("childHasInput")) {

                            var child = el.childNodes;
                            var input = child[1].localName == "input" ? child[1] : child[2].localName == "input" ? child[2] : child[3].localName == "input" ? child[3] : child[4].localName == "input" ? child[4] : child[5].localName == "input" ? child[5] : "";
                            try {
                                input.classList.remove("pressed");
                                input.removeEventListener('input', function (e) { });
                                input.removeEventListener('keyup', function (e) { });
                                input.removeEventListener('blur', function (e) { });

                                input.addEventListener('blur', function (e) {

                                    if (typeof keysPressed[currentFocusedProduct] == "undefined")
                                        keysPressed[currentFocusedProduct] = "";
                                    var value = e.target.value;
                                    if (value.includes('-')) {
                                        var parts = value.split('-');
                                        var sum = parts.reduce(function (a, b) {
                                            return Number(a) + Number(b);
                                        }, 0);
                                        e.target.value = sum;
                                    }
                                    if (e.target.parentNode.parentNode.parentNode.id == "results") {
                                        /* trigger an enter keyup event */

                                        var parts = keysPressed[currentFocusedProduct].split("-");
                                        var val = parts.reduce(function (a, b) {
                                            if (a == 0)
                                                return b;
                                            return Number(a) + Number(b);
                                        }, 0);
                                        if (!Number.isNaN(val) && val != "") {
                                            document.querySelector(`a[name="${currentFocusedProduct}"]>input`).value = val;

                                            try { document.querySelector("a.product.pressed").parentNode.classList.remove("hovering"); } catch (e) { }
                                            var originalFocusedProduct = currentFocusedProduct;

                                            if (/MATUMIZI_MENGINE|Transport|Food|Pesa/g.test(currentFocusedProduct) && (appStates[currentAppStateIndex] != "stocktake")) {

                                                extraTransDetails = prompt("Elezeya Malipo ya " + currentFocusedProduct, "");
                                                if (extraTransDetails == null || extraTransDetails == "") {
                                                    throw new Error('Lazima Uingize Aina Ya Malipo ');
                                                }
                                                else {
                                                    if (/Pesa/g.test(currentFocusedProduct))
                                                        extraTransDetails = (appStates[currentAppStateIndex] == "wholesale_purchase_delivered") ? "Amelipa " + extraTransDetails : "Hakulipa " + extraTransDetails;

                                                }
                                                var obj = document.querySelector(`a[name="${originalFocusedProduct}"]>input`);
                                                /*  var val = document.querySelector(`a[name="${originalFocusedProduct}"]>input`).value;*/
                                                var query = `${currentFocusedProduct}::${extraTransDetails.trim()}=${document.querySelector(`a[name="${originalFocusedProduct}"]>input`).value}`;
                                            } else
                                                var query = `${currentFocusedProduct.replaceAll("_", " ")}${appStateMarks[currentAppStateIndex]}${e.target.value.replace(/^0/, ".")}`;;

                                            if (!/\d+$/.test(query)) {
                                                if ((appStates[currentAppStateIndex] == "stocktake"))
                                                    query += "0";
                                                else {
                                                    if (/Kony|vant|Valu|Hanson/.test(query))
                                                        query += ".1";
                                                    else
                                                        query += "1";
                                                }
                                            }

                                            if (appStates[currentAppStateIndex] != "stocktake") {
                                                var firstpart = (/\d+\.\d+$/.test(query)) ? /(\d+)\.\d+$/.exec(query)[1] : "";
                                                var secondpart = /\.\d+$/.test(query) ? /\.(\d+)$/.exec(query)[1] : "";
                                                if (firstpart != "" && secondpart != "") {
                                                    var rg = new RegExp("[\+\+|\-|\+|\#|”ø]" + firstpart + "." + secondpart, "g");
                                                    var adding = new RegExp("([\+\+|\-|\+|\#|”ø])" + firstpart + "." + secondpart, "g").exec(query);
                                                    var prd = query.replaceAll(rg, "");
                                                    query = prd + adding[1] + firstpart + "," + prd + adding[1] + "." + secondpart
                                                }
                                            } else {
                                                var newvalue = query.match(/\d{0,}\.{0,1}\d{0,}$/)[0];
                                                var prd = query.match(/(.*)#\d{0,}\.{0,1}\d{0,}$/)[1];
                                                var rgx = new RegExp(`(.*)(\\(${warehouseName.toLowerCase()}\\))(${prd})(@{0,1}\\d+)#(\\d{0,}\\.{0,1}\\d{0,})(.*)`);
                                                var exists = rgx.test(tempTransQuery[appStates[currentAppStateIndex]]);

                                                if (exists) {
                                                    /* find the amount thats already their and add it to */
                                                    var firsthalf = tempTransQuery[appStates[currentAppStateIndex]].replaceAll(/p(\d+)/g, "\.$1").match(rgx);
                                                    if (/\./g.test(firsthalf[5])) {
                                                        var newtotalvalue = eval(firsthalf[5].replace(".", "")) + eval(newvalue.replace(".", ""));
                                                        tempTransQuery[appStates[currentAppStateIndex]] = tempTransQuery[appStates[currentAppStateIndex]].replaceAll(/p(\d+)/g, "\.$1").replace(rgx, `$1$2$3$4#.${newtotalvalue}$6`).replaceAll(/#\.(\d+)/g, "#p$1");
                                                    } else {
                                                        var newtotalvalue = eval(firsthalf[5]) + eval(newvalue);
                                                        tempTransQuery[appStates[currentAppStateIndex]] = tempTransQuery[appStates[currentAppStateIndex]].replace(rgx, `$1$2$3$4#${newtotalvalue}$6`);
                                                    }

                                                    productdetails_string = GetProductDetails(tempTransQuery[appStates[currentAppStateIndex]].replace(/^,/, ""));
                                                    tempTransObj[appStates[currentAppStateIndex]] = JSON.parse(productdetails_string);

                                                    setGlobal(`ALDTMP${appStates[currentAppStateIndex]}`, tempTransObj[appStates[currentAppStateIndex]].finalQuery);
                                                    document.querySelector("#result_display>ul").innerHTML = tempTransObj[appStates[currentAppStateIndex]].finalResponseMsg.replaceAll("\n", "<br/>");
                                                    document.querySelectorAll(".disabled").forEach(el => {
                                                        el.disabled = false;
                                                        el.classList.remove("disabled");
                                                        el.classList.add("enabled");
                                                    });
                                                    return 0;
                                                }
                                            }

                                            query = `(${warehouseName.toLowerCase()})${query}`;
                                            date = new Date();

                                            query = (currentTransDateStr.trim() + " " + query.replaceAll(/\.(\d+)$/gm, "p$1")).trim();
                                            if (!tempTransQuery[appStates[currentAppStateIndex]]) tempTransQuery[appStates[currentAppStateIndex]] = "";
                                            if (appStates[currentAppStateIndex] == "stocktake") {
                                                tempTransQuery[appStates[currentAppStateIndex]] = tempTransQuery[appStates[currentAppStateIndex]].replaceAll(query + ",", "").concat(`,${query}`).replace(/^,/, "");
                                            } else {
                                                tempTransQuery[appStates[currentAppStateIndex]] = tempTransQuery[appStates[currentAppStateIndex]].concat((`,${query}`).replace("undefined", "").replace(/\n/, "").trim());
                                            }
                                            productdetails_string = GetProductDetails(tempTransQuery[appStates[currentAppStateIndex]].replace(/^,/, ""));
                                            tempTransObj[appStates[currentAppStateIndex]] = JSON.parse(productdetails_string);
                                            setGlobal(`ALDTMP${appStates[currentAppStateIndex]}`, tempTransObj[appStates[currentAppStateIndex]].finalQuery);
                                            document.querySelector("#result_display>ul").innerHTML = tempTransObj[appStates[currentAppStateIndex]].finalResponseMsg.replaceAll("\n", "<br/>");
                                            document.querySelectorAll(".disabled").forEach(el => {
                                                el.disabled = false;
                                                el.classList.remove("disabled");
                                                el.classList.add("enabled");
                                            });
                                            document.getElementById("submitbuttonholder").classList.remove("hyper");
                                            document.getElementById("myinputbar").classList.remove("hyper");

                                            if (appStates[currentAppStateIndex] == "stocktake") {
                                                var el = "li.product[name='" + e.target.name.replace("/", "") + "']";
                                                var child = document.querySelector(el).lastChild;

                                                child.classList.add("hidden");
                                            }
                                            document.getElementById('search').value = "";

                                            keysPressed[currentFocusedProduct] = "";
                                            document.querySelector(`a[name="${currentFocusedProduct}"]>input`).value = "";

                                            /*  var nextInput = e.target.parentNode.parentNode.nextElementSibling;
                                              if (nextInput.lastChild) {
                                                  nextInput.lastChild.dispatchEvent(new Event('focus'));
                                              } */
                                        }
                                    }
                                });
                                input.addEventListener('input', function (e) {

                                    var clickedvalue = e.srcElement.getAttribute("name");
                                    var target = e.target.id;
                                    if (typeof keysPressed[currentFocusedProduct] == "undefined")
                                        keysPressed[currentFocusedProduct] = "";

                                    if (!isNaN(e.data) || e.data === '+' || e.data === '-' || e.data === '.') {
                                        keysPressed[currentFocusedProduct] += e.data;
                                    }

                                });

                                input.addEventListener('keyup', function (e) {

                                    var clickedvalue = e.srcElement.getAttribute("name");
                                    var target = e.target.id;
                                    if (typeof keysPressed[currentFocusedProduct] == "undefined")
                                        keysPressed[currentFocusedProduct] = "";

                                    if (e.key === "Backspace") {
                                        keysPressed[currentFocusedProduct] = keysPressed[currentFocusedProduct].slice(0, -1);
                                    }
                                    else if (e.key === 'Enter') {
                                        /* click enter insid 1 of the products in the results productview: submittransacions*/
                                        e.preventDefault();
                                        e.target.blur();
                                    }

                                });
                            } catch (e) { }

                        }

                        el.addEventListener("focus", (e) => {
                            var nm = e.srcElement.getAttribute("name");
                            var target = e.target;

                            if (target.parentNode.parentNode.id == "results") {
                                if (nm != oldFocusedProduct && document.querySelector(`li.product[name='${oldFocusedProduct}']`)) {
                                    document.querySelector(`li.product[name='${oldFocusedProduct}']`).classList.remove("hovering");
                                }

                                currentFocusedProduct = document.querySelector(`li.product[name='${nm}']`);
                                if (currentFocusedProduct) {
                                    if (document.querySelector("li.product.hovering")) document.querySelector("li.product.hovering").classList.remove("hovering");
                                    target.parentNode.classList.add("hovering");
                                    document.getElementById("myinputbar").classList.remove("hyper");
                                    closeFilterDialog();
                                    document.querySelector("li.product[name='" + nm + "']>a>input").select();
                                }
                                currentFocusedProduct = nm;
                                oldFocusedProduct = nm;
                                document.querySelectorAll('a').forEach(el => {
                                    el.classList.remove('pressed');
                                });
                                e.srcElement.classList.add('pressed');
                                document.getElementById("myinputbar").classList.add("hyper");

                                const clickedvalue = e.srcElement.getAttribute('name');
                                const local_appstate = appStates[currentAppStateIndex];
                                const input = document.querySelector(".product.pressed > input:not(.hidden)");
                                isMultTextArray[clickedvalue] = input ? input.value : "";

                                const num = isMultTextArray[clickedvalue] || "1";
                                const newlink = clickedvalue + appStateMarks[currentAppStateIndex] + num;
                                document.getElementById("submitbutton").innerHTML = newlink;
                                document.getElementById("submitbutton").href = "/" + newlink;
                                try { input.focus(); } catch (e) { }
                            }
                        });
                    };
                } else if (holderElement.id == "CustomersList") {
                    document.querySelectorAll("a.product").forEach(el => {
                        el.addEventListener("focus", (e) => {
                            var nm = e.srcElement.getAttribute("name");
                            var target = e.target;
                            if (target.parentNode.parentNode.id == "CustomersList") {
                                document.getElementById("editProductName").value = nm;
                            }
                            else if (target.parentNode.parentNode.id == "results") {
                                if (nm != oldFocusedProduct && document.querySelector(`li.product[name='${oldFocusedProduct}']`)) {
                                    document.querySelector(`li.product[name='${oldFocusedProduct}']`).classList.remove("hovering");
                                }

                                currentFocusedProduct = document.querySelector(`li.product[name='${nm}']`);
                                if (currentFocusedProduct) {
                                    if (document.querySelector("li.product.hovering")) document.querySelector("li.product.hovering").classList.remove("hovering");
                                    target.parentNode.classList.add("hovering");
                                    document.getElementById("myinputbar").classList.remove("hyper");
                                    closeFilterDialog();
                                    document.querySelector("li.product[name='" + nm + "']>a>input").select();
                                }
                                currentFocusedProduct = nm;
                                oldFocusedProduct = nm;
                                document.querySelectorAll('a').forEach(el => {
                                    el.classList.remove('pressed');
                                });
                                e.srcElement.classList.add('pressed');
                                document.getElementById("myinputbar").classList.add("hyper");

                                const clickedvalue = e.srcElement.getAttribute('name');
                                const local_appstate = appStates[currentAppStateIndex];
                                const input = document.querySelector(".product.pressed > input:not(.hidden)");
                                isMultTextArray[clickedvalue] = input ? input.value : "";

                                const num = isMultTextArray[clickedvalue] || "1";
                                const newlink = clickedvalue + appStateMarks[currentAppStateIndex] + num;
                                document.getElementById("submitbutton").innerHTML = newlink;
                                document.getElementById("submitbutton").href = "/" + newlink;
                                try { input.focus(); } catch (e) { show(e.stack + " -- error setting event"); }
                            }
                        });
                    });

                }

            } catch (e) {
                show(e.stack + " -- error creating list");
            }
        }

        function createProductsView() {
            const localAppState = appStates[currentAppStateIndex];
            if (!settingsObj || !settingsObj.data.alradaitemnames) return;
            switch (localAppState) {
                case "wholesale_sale":
                case "wholesale_purchase":
                case "wholesale_purchase_delivered":
                case "stocktake": {
                    products_jsonString = JSON.parse(settingsObj.data.alradaitemnames).slice(1);

                    products_jsonString.sort((a, b) => {

                        if (/Pesa/g.test(a.OfficialName)) {
                            return 1;
                        }

                        /* If a is "Pesa", put b before a */
                        if (/Crate Tupu|Chupa/g.test(a.OfficialName)) return 1;

                        /* Group closely matching OfficialNames together */
                        if (a.OfficialName.includes(b.OfficialName.slice(0, 4)) || b.OfficialName.includes(a.OfficialName.slice(0, 4))) {
                            return 0;
                        }

                        if (a.category_breakdown < b.category_breakdown) return 1;

                        if (b.laststocktakedate < a.laststocktakedate) {
                            return -1;
                        }

                        if (b.thysaylaststocktakeamt < a.thysaylaststocktakeamt) {
                            return -1;
                        }

                        if (a.category_breakdown > b.category_breakdown) return -1;
                        return 0;
                    });

                    ProductNamesLiWithInput = products_jsonString.map(product => {
                        const name = product.OfficialName;
                        const categorySign = getCategorySign(product.category_breakdown);
                        const categoryArr = product.category_breakdown.split("_");
                        const cat = categoryArr.join(" ");
                        const price = formatPrice(product.w_price_a, product.w_purchase_a);
                        const laststocktake = product.thysaylaststocktakeamt.toString();
                        var stockstring = (/^[1-9]\d{0,}\.{0,1}\d{0,}$/.test(laststocktake)) ? /(\d+)\.{0,1}\d{0,}$/.exec(laststocktake)[1] : "";
                        var secondpart = /\.\d+$/.test(laststocktake) ? /\.(\d+)$/.exec(laststocktake)[1] : "";
                        if (secondpart) {
                            stockstring = (stockstring + " p" + (product.carton * (eval("." + secondpart)))).trim();
                        }

                        return createProductLi(name, name.replaceAll(" ", "_").replaceAll("'", '').replaceAll(",", "-").replaceAll("(", "[").replaceAll(")", "]"), cat, price, categorySign, stockstring, localAppState, true);
                    });
                    ProductNamesLiWithOutInput = products_jsonString.map(product => {
                        const name = product.OfficialName;
                        const categorySign = getCategorySign(product.category_breakdown);
                        const categoryArr = product.category_breakdown.split("_");
                        const cat = categoryArr.join(" ");
                        const laststocktake = product.thysaylaststocktakeamt.toString();
                        var stockstring = (/^[1-9]\d{0,}\.{0,1}\d{0,}$/.test(laststocktake)) ? /(\d+)\.{0,1}\d{0,}$/.exec(laststocktake)[1] : "";
                        var secondpart = /\.\d+$/.test(laststocktake) ? /\.(\d+)$/.exec(laststocktake)[1] : "";
                        if (secondpart) {
                            stockstring = (stockstring + " p" + (product.carton * (eval("." + secondpart)))).trim();
                        }
                        const price = formatPrice(product.w_price_a, product.w_purchase_a);
                        return createProductLi(name, name.replaceAll(" ", "_").replaceAll("'", '').replaceAll(",", "-").replaceAll("(", "[").replaceAll(")", "]"), cat, price, categorySign, stockstring, localAppState, false);
                    });
                    break;
                }
                case "sent2_bank": {
                    suppliers_jsonString = JSON.parse(settingsObj.data.suppliers).slice(1);
                    ProductNamesLiWithInput = suppliers_jsonString.map(supplier => {
                        const name = supplier.officialname;
                        const contactName = supplier.contactname;
                        return createProductLi(name, name.replaceAll(" ", "_").replaceAll("'", '').replaceAll(",", "").replaceAll("(", "[").replaceAll(")", "]"), "supplier", "", "", "", localAppState, true, contactName, supplier.contact_numbers);
                    });
                    ProductNamesLiWithOutInput = suppliers_jsonString.map(supplier => {
                        const name = supplier.officialname;
                        const contactName = supplier.contactname;
                        return createProductLi(name, name.replaceAll(" ", "_").replaceAll("'", '').replaceAll(",", "").replaceAll("(", "[").replaceAll(")", "]"), "supplier", "", "", "", localAppState, false, contactName, supplier.contact_numbers);
                    });
                    break;
                }
            }

            products_jsonString.forEach(product => {
                const category = product.category_breakdown.split("_")[2].toLowerCase(); if (!categories[category]) {
                    categories[category] = [];
                }
                if (!categories[category][product.OfficialName]) {
                    categories[category][product.OfficialName] = [];
                }

                categories[category][product.OfficialName].push({
                    name: product.OfficialName,
                    classes: category.split(".").map(part => part.toLowerCase()).join(" ")
                });

                const financialnps = product.category_breakdown.split("_")[3];
                if (!npsValues[financialnps]) {
                    npsValues[financialnps] = [];
                }
                npsValues[financialnps].push(product);

                const speed = (product.category_breakdown.split("_")[4]) ? product.category_breakdown.split("_")[4] : 0;
                if (!runningSpeedRanges[speed]) {
                    runningSpeedRanges[speed] = [];
                }
                runningSpeedRanges[speed].push(product);
            });
            var filterDialogProducts2CategoriesStr = "";
            for (const category in categories) {
                filterDialogProducts2CategoriesStr += `<li onClick="handleFilterDialogFilterSelection(event)">
        <label for="category_${category}">${category}</label>
        <input type="checkbox" id="category_${category}" >
      </li>`;
            }
            document.querySelector("#filter-dialog-products2>#filterCategories").innerHTML = filterDialogProducts2CategoriesStr;

            hideExistingInputs();
            createList(ProductNamesLiWithOutInput, document.querySelector("#filter-dialog-products>.selectproduct"));
            createList(ProductNamesLiWithInput, document.querySelector("#productsview>#results"));
            addInputEventListeners();
        }

        function getCategorySign(categoryBreakdown) {
            let categorySign = "";
            if (/alcohol/.test(categoryBreakdown)) {
                categorySign = "üîû";
            }
            if (/beer/.test(categoryBreakdown)) {
                categorySign = "   üç∫ " + categorySign;
            }
            if (/liquar/.test(categoryBreakdown)) {
                categorySign = "  ü•É  " + categorySign;
            }
            return categorySign;
        }

        function formatPrice(saleprice, purchaseprice) {
            if (appStates[currentAppStateIndex] == "wholesale_sale" || appStates[currentAppStateIndex] == "stocktake")
                return saleprice.toString().replace(/\d{1,3}(?=(\d{3})+(?!\d))/g, '$&,');
            else
                return purchaseprice.toString().replace(/\d{1,3}(?=(\d{3})+(?!\d))/g, '$&,');
        }

        function createProductLi(name, formattedname, category, price, categorySign, thysaylaststocktakeamt, localAppState, hasinput = false, contactName = "", contactPhone = "", onLiClickEvent = "") {
            const inputType = localAppState === "wholesale_sale" ? "inputnumber" : "inputremaining";
            var inputstocktakeclass = (/^\-/g.test(thysaylaststocktakeamt)) ? "attention" : "";

            if (/^$|0/g.test(thysaylaststocktakeamt)) {
                if (/supplier|customer/g.test(category)) {
                    thysaylaststocktakeamt = "";
                } else
                    thysaylaststocktakeamt = "-<i> HAMNA </i> -";
                inputstocktakeclass = (/supplier|customer/g.test(category)) ? "" : "unavailable";
            } else {
                thysaylaststocktakeamt = `-<b> ${thysaylaststocktakeamt}</b> -`;
            }
            const inputprice = (price < 0) ? `DENI: ${price} tsh` : `${price} tsh`,
                inputId = `${inputType}_${localAppState}_${formattedname}_${hasinput}`,
                IfChildHasInputClass = (hasinput) ? "childHasInput" : "";
            if (onLiClickEvent == "")
                onLiClickEvent = (!hasinput) ? `handleTransEvent(event)` : ``;

            hasinput = (hasinput) ? `<input type="number" id="${inputId}" name="${formattedname}" placeholder="#Ô∏è‚É£ Kiasi" class="${inputType}" onclick="event.target.parentNode.dispatchEvent(new Event('focus'))" />` : '';
            var re = `<li class="product active ${inputstocktakeclass} ${IfChildHasInputClass} ${(price < 0) ? "attentionparent" : ""} ${category}" data-category="${category}" name="${formattedname}" title="${name}" onclick="${onLiClickEvent}">
            <a class="product ${category}" href="#" name="${formattedname}" title="${name}" >
              ${productNameWithContact(name, contactName, contactPhone)}`;
            if (price != 0)
                re = re + `<em>${inputprice}</em>`;
            re = re + `<span class="${inputstocktakeclass}"><span class="stockamt">${thysaylaststocktakeamt}</span><span class="classification">${categorySign}</span></span>`;
            re = re + `${hasinput}</a></li>`;

            return re;
        }

        function productNameWithContact(name, contactName, contactPhone = "") {
            return (contactName && (name != contactName)) ? `${name} -${contactName}${(contactPhone != "") ? "<br><span>" + contactPhone + "</span>" : "<span> - </span>"}` : name;
        }

        function hideExistingInputs() {
            const existingInput = document.querySelector("a > input");
            existingInput?.classList.add("hidden");
        }

        function addInputEventListeners() {
            document.querySelectorAll("#myinputbar> input").forEach(input => {
                input.addEventListener("focus", e => {
                    document.getElementById("myinputbar").classList.add("hyper");
                });
                input.addEventListener("focusout", e => {
                    document.getElementById("myinputbar").classList.remove("hyper");
                });
            });
        }
        function reLoadSettingsData() {
            setGlobal("ALDLOG", `${partOfDay}_${currentTransDateStr}_clr:`);

            if (typeof settingsObj.data.customers != "undefined") {
                customers_jsonString = JSON.parse(settingsObj.data.customers).slice(1);
                const settingsDateTime = new Date(settingsObj.products.unixTime * 1000);

                var day = settingsDateTime.getDate();
                var month = settingsDateTime.getMonth() + 1;
                var year = settingsDateTime.getFullYear();

                const hours = settingsDateTime.getHours();
                const minutes = settingsDateTime.getMinutes();
                const seconds = settingsDateTime.getSeconds();

                const formattedDate = `${day}/${month}/${year}`;
                const formattedTime = `${hours}:${minutes}:${seconds}`;

                document.querySelector(".latestupdate").innerHTML = `${formattedDate} ${formattedTime} :Data Mwisho`;

                CustomerNamesLiWithOutInput = customers_jsonString.map(customer => {
                    const name = customer.customer_name;
                    return createProductLi(name, name.replaceAll(" ", "_").replaceAll(/\\/g, " na ").replaceAll("'", '').replaceAll(",", "").replaceAll("(", "[").replaceAll(")", "]"), "customer", customer.net30dept, "", "", "CustomerFilter", false, customer.customer_name, customer.customer_numbers, "confirmCustomerPick(event)");
                });
                createList(CustomerNamesLiWithOutInput, document.querySelector("#filter-dialog-customers>.selectproduct"));
            }
        }
        function ShouldWeCheckUpdates() {
            if (typeof createScene != 'undefined') {
                /* is in tasker */
                return true;

            } else {
                var rgx = new RegExp(`${partOfDay}_${currentTransDateStr}_clr`, "g");
                return rgx.test(global("ALDLOG"));
            }

            return false;
        }

        window.onload = function () {
            try {
                if (global('ALDSTATE'))
                    currentAppStateIndex = eval(global("ALDSTATE"));


                if (global('ALDSETTING') && ShouldWeCheckUpdates()) {
                    settingsObj = JSON.parse(global('ALDSETTING'));
                    loadCachedTrans();
                    reLoadSettingsData();
                    ChangeView(currentAppStateIndex);
                } else {

                    fetchProductUpdate(false, false, reLoadSettingsData);

                }
                initializeListeners();
            } catch (e) {
                show(e.stack + "-- error trying to load", true, true);
            }
        };

        function fetchHTMUpdate() {
            var sndClient = "";

            const AppScriptPostUrl = "https://raw.githubusercontent.com/iamalbertly/AlradaHTM/main/alrada-min.html";

            fetch(AppScriptPostUrl)
                .then(response => response.text())
                .then(data => {
                    setGlobal("ALDHTM", data);
                    show("View-Update Successful!");
                })
                .catch(error => console.error('Error:', error));
        }

        function fetchProductUpdate(ShowUpdateScreen = true, JustGetDB = false, callback = undefined) {
            var sndClient = "";

            const params = new URLSearchParams(new URL(AppScriptPostUrl).search);
            if (typeof settingsObj.products != "undefined") {
                params.append('version', settingsObj.products.unixTime);
            } else
                params.append('version', 0);
            const geturl = AppScriptPostUrl + "?" + params;
            var options = {};
            if (typeof createScene == 'undefined') {
                /* not in tasker and not localhost*/
                var finalurl = 'https://cors-proxy3.p.rapidapi.com/api';
                options = {
                    method: 'POST',
                    headers: {
                        'content-type': 'application/x-www-form-urlencoded',
                        'X-RapidAPI-Key': 'ed66f1ba3fmsh2df55bb1aaf3489p155a57jsnb67785beedcf',
                        'X-RapidAPI-Host': 'cors-proxy3.p.rapidapi.com'
                    },
                    body: new URLSearchParams({ 'my-url': geturl })
                };
                /* var finalurl = 'https://raw.githubusercontent.com/iamalbertly/AlradaHTM/main/alradasettings.json';
                options = {
                     method: 'GET'
                 }; */
                sndClient = "Web-Proxy";
            }
            else { /* inside Tasker*/
                var finalurl = geturl;
                options = {
                    method: 'GET',
                    headers: {
                        'content-type': 'application/json',
                        Origin: '*'
                    }
                };
                sndClient = "Tasker";
            }
            if (ShowUpdateScreen)
                showLoadingScreen("Fetching updates...", "Tafadhali Subiri.");
            else
                show("Fetching updates...");

            fetch(finalurl, options)
                .then(response => {
                    responseClone = response.clone();
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error('ErrServer response: ' + text, false, true);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.data) {
                        settingsObj.data.alradaitemnames = data.data.alradaitemnames;
                        settingsObj.products = data.products;
                        setGlobal('ALDSETTING', JSON.stringify(settingsObj));
                    }
                    else show("nothing to update.");

                    reLoadSettingsData();
                    loadCachedTrans();

                    if (callback)
                        callback();

                    if (!JustGetDB)
                        fetchHTMUpdate();
                    show(sndClient + ": Successfully Updated Settings...");
                    goto("command||beep");
                    hideLoadingScreen();
                    createProductsView();
                    clearvalues();
                })
                .catch((error) => {
                    if (error.message.includes('Failed to fetch')) {
                        show("Tatizo la Network. Cheki internet alafu Jaribu Tena. " + error.stack, true, true);
                    } else {
                        responseClone.text()
                            .then(bodyText => {
                                if (bodyText == "#NAME?") show(" database is busy '#NAME?'");
                            });
                        show("Error! " + error.message + "\n" + error.stack);
                    }
                    if (global('ALDSETTING')) {
                        var settingsObj = JSON.parse(global('ALDSETTING'));
                        loadCachedTrans();
                        reLoadSettingsData();
                        ChangeView(currentAppStateIndex);
                    }
                    hideLoadingScreen();
                });

        }

        function sendCachedTrans(event) {
            var sndClient = "";
            try {
                var transactionType = appStates[currentAppStateIndex],
                    JsonObj_BeingProcessed = cachedTransObjectJson[transactionType],
                    json_response = JsonObj_BeingProcessed.json_response;
                if (!json_response) {
                    show("Hujafadhi chochote...");
                    return 0;
                };
                hideLoadingScreen();
                var transObjStr = cachedTransObjectString[transactionType];
                if (global(`ALDLSTTransStr${appStates[currentAppStateIndex]}`) == transObjStr) {
                    show("Hakuna Data Mpya, Hii Inajirudiya!");
                    return 0;
                }

                setGlobal(`ALDLSTTransStr${appStates[currentAppStateIndex]}`, transObjStr);

                const snapshotUnixTime = Math.floor(Date.now() / 1000);
                const data = json_response.map(entry => [`${entry.transDate} ${entry.transTime}`, staffName.slice(0, 2) + " " + entry.transMsg.replace(/\d{1,2}\/\d{1,2}\/\d{4}\s\d{1,2}:\d{1,2}\s/, ""), entry.currentUnixTime]);
                const values = JSON.stringify({ usr: staffName, data: data, time: snapshotUnixTime, cmd: "add_transaction" });

                setClip(values, "", function (x) {
                    showLoadingScreen("Tunatuma Repoti...", "<h1>‚ôªÔ∏è</h1>", "<span class='tunatumaMsg'>" + JSON.parse(cachedTransObjectString[transactionType]).finalResponseMsg.replaceAll(/(\=\s\d+\,{0,}\d+)(\s)/gm, "$1<br/>").replaceAll(/\@\d+\.{0,1}\d{0,}/gm, "").replaceAll(/(TOTAL.*)/gm, "<br/>$1") + "</span>");
                });

                const params = new URLSearchParams(new URL(AppScriptPostUrl).search);

                params.append('payload', values);
                const geturl = AppScriptPostUrl + "?" + params;
                var options = {}; var islocal = window.location;
                if ((window.location.hostname == "127.0.0.1") || (typeof createScene == 'undefined')) {
                    var finalurl = geturl;
                    options = {
                        mode: 'no-cors',
                        method: 'GET',
                        headers: {
                            'content-type': 'application/json',
                            Origin: '*'
                        }
                    };
                    sndClient = "Localhost";
                }

                else if (typeof createScene == 'undefined') {
                    /* not in tasker and not localhost*/
                    var finalurl = 'https://cors-proxy3.p.rapidapi.com/api';
                    options = {
                        method: 'POST',
                        headers: {
                            'content-type': 'application/x-www-form-urlencoded',
                            'X-RapidAPI-Key': 'b885eb794emsh79a1af1e8dff803p1c9f71jsnf78274969f09',
                            'X-RapidAPI-Host': 'cors-proxy3.p.rapidapi.com'
                        },
                        body: new URLSearchParams({ 'my-url': geturl })
                    };
                    sndClient = "Web-Proxy";
                }
                else { /* inside Tasker*/
                    var finalurl = geturl;
                    options = {
                        method: 'GET',
                        headers: {
                            'content-type': 'application/json',
                            Origin: '*'
                        }
                    };
                    sndClient = "Tasker";
                }

                fetch(finalurl, options)
                    .then(response => {
                        responseClone = response.clone();
                        if (!response.ok) {
                            return response.text().then(text => {
                                if (text == "") {

                                    cachedTransObjectString[transactionType] = "";
                                    cachedTransactionQueries[transactionType] = "";
                                    cachedTransCount[transactionType] = 0;
                                    cachedTransCashTotal[transactionType] = 0;
                                    document.getElementById("btnSend2Cache").classList.remove("disabled");
                                    document.getElementById("btnSend2Cache").disabled = false;
                                    document.querySelector("#cachedTrans>span>.part1").innerHTML = cachedTransCount[transactionType];
                                    document.querySelector("#cachedTrans>span>.part2").innerHTML = cachedTransCashTotal[transactionType];
                                } else
                                    throw new Error('ErrServer response: ' + text, false, true);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {

                        try {
                            responseClone.text()
                                .then(bodyText => {
                                    if (!/Muda wa huduma umeisha/g.test(bodyText)) {
                                        goto(`command||sendupdate_${transactionType}_${JsonObj_BeingProcessed.finalTextResponseMsg}`);
                                        clearvalues();
                                        cachedTransObjectString[transactionType] = "";
                                        cachedTransactionQueries[transactionType] = "";
                                        cachedTransCount[transactionType] = 0;
                                        cachedTransCashTotal[transactionType] = 0;
                                        document.getElementById("btnSend2Cache").classList.remove("disabled");
                                        document.getElementById("btnSend2Cache").disabled = false;
                                        document.querySelector("#cachedTrans>span>.part1").innerHTML = cachedTransCount[transactionType];
                                        document.querySelector("#cachedTrans>span>.part2").innerHTML = cachedTransCashTotal[transactionType];

                                        setGlobal(`ALDCACHE${transactionType}`, cachedTransactionQueries[transactionType]);
                                    }

                                    show('txtServer responded: ' + bodyText, false, true, false);
                                });

                            show(sndClient + ": Repoti Imetumwa...");
                            goto("command||beep");

                            createProductsView();
                            hideLoadingScreen();
                        } catch (e) {
                            document.querySelector("#cachedTrans>span>.part1").innerHTML = cachedTransCount[transactionType];
                            document.querySelector("#cachedTrans>span>.part2").innerHTML = cachedTransCashTotal[transactionType];
                            show(e.stack + "-there was an error");
                        }
                    })
                    .catch((error) => {
                        if (error.message.includes('Failed to fetch')) {
                            show("Tatizo la Network. Cheki internet alafu Jaribu Tena. " + error.stack);
                        } else {
                            responseClone.text()
                                .then(bodyText => {
                                    if (bodyText == '') show(sndClient + " sent but NotSure if Successful or not. #Cors.");
                                    else if (bodyText == "#NAME?") show(" database is busy '#NAME?'");
                                });
                        }
                    });
                cachedTransCount[transactionType] = "Tunatuma Repoti";
                cachedTransCashTotal[transactionType] = "Subiri ..";
                document.getElementById("btnSend2Cache").classList.add("disabled");
                document.getElementById("btnSend2Cache").disabled = true;
                document.querySelector("#cachedTrans>span>.part1").innerHTML = cachedTransCount[transactionType];
                document.querySelector("#cachedTrans>span>.part2").innerHTML = cachedTransCashTotal[transactionType];
                show("Tunatuma repoti...");
            }
            catch (e) {
                show(e.stack + "-an error");
            }
        }

        function handleCachedTransEvent(event) {
            if (!event || !event.target.id) return;
            var target = event.target,
                json_response = JSON.parse(cachedTransObjectString[appStates[currentAppStateIndex]]).json_response,
                id = eval(/_(\d+)/g.exec(target.id)[1]);
            if (json_response[id].transType == "sent2_bank")
                var old_mulitplier = json_response[id].priceTotal;
            else
                var old_mulitplier = (json_response[id].multiplier < 1) ? "." + (json_response[id].transCarton * json_response[id].multiplier) : json_response[id].multiplier;
            editingquery = `${json_response[id].transMsg}`;

            var ConfirmDialogContent = `<div id="myModal">
            <div class="editvalues showonlyadmin">
            <a href="#" class="notyet" id="edit_date">${json_response[id].transDate}</a>
            <a href="#" class="notyet" id="edit_shopname" >${json_response[id].transWarehouseName}</a>
            <a href="#" class="" id="edit_drinkname" onclick="document.getElementById('filter-dialog-products').classList.remove('hidden');"  placeholder="" value="${json_response[id].rawproductname}">${json_response[id].rawproductname}</a>
            <span id="edit_multipliersign">${appStateMarks[currentAppStateIndex]}</span>
            <input type="text" id="edit_multiplier"  placeholder="${old_mulitplier}" value="${old_mulitplier}" />
            </div>
            <div class="buttonholder" style="display:flex">

            <button onclick="confirmFormYes()">üöÆ ONDOA KABISA</button>`;

            if (appStates[currentAppStateIndex] == "wholesale_sale") ConfirmDialogContent += `<button onclick="confirmFormEdit('isLoan')">‚ö†Ô∏è DENI</button>`;

            ConfirmDialogContent += `<button onclick="confirmFormEdit()">üõ†Ô∏è REKEBISHA MPYA</button>
            <button onclick="confirmFormNo()">üëåüèΩ USIBADILISHE</button></div>
            </div>
            </div>`;
            confirmFormNo = function () {
                hideLoadingScreen();
            };

            confirmFormEdit = function (edit_mode = "default") {
                var mult_sign = appStateMarks[currentAppStateIndex];
                if (edit_mode == "isLoan") mult_sign = '-';

                var newquery = `${document.getElementById("edit_date").value} (${document.getElementById("edit_shopname").value})${document.getElementById("edit_drinkname").innerHTML}${mult_sign}${document.getElementById("edit_multiplier").value}`;
                var oldquery = cachedTransactionQueries[appStates[currentAppStateIndex]].replaceAll("(plus)", "+");

                tempTransQuery[appStates[currentAppStateIndex]] = oldquery.replace(editingquery, newquery).replaceAll(/\.(\d+)$/gm, "p$1").trim();

                productdetails_string = GetProductDetails(tempTransQuery[appStates[currentAppStateIndex]]);
                cachedTransObjectString[appStates[currentAppStateIndex]] = productdetails_string;
                cachedTransObjectJson[appStates[currentAppStateIndex]] = JSON.parse(productdetails_string);
                json_response = cachedTransObjectJson[appStates[currentAppStateIndex]].json_response;

                cachedTransactionQueries[appStates[currentAppStateIndex]] = cachedTransObjectJson[appStates[currentAppStateIndex]].finalQuery;
                cachedTransCashTotal[appStates[currentAppStateIndex]] = eval(cachedTransObjectJson[appStates[currentAppStateIndex]].finalResponseTotal);

                var result_display = cachedTransObjectJson[appStates[currentAppStateIndex]].finalResponseMsg;

                if (cachedTempTrans2Process[appStates[currentAppStateIndex]])
                    if (cachedTempTrans2Process[appStates[currentAppStateIndex]].length <= 0)
                        document.querySelectorAll(".disabled").forEach(el => {
                            el.disabled = false;
                            el.classList.remove("disabled");
                            el.classList.add("enabled");
                        });

                if (cachedTransactionQueries[appStates[currentAppStateIndex]])
                    if (cachedTransactionQueries[appStates[currentAppStateIndex]].length <= 0)
                        document.querySelectorAll(".hiddenpreview").forEach(el => {
                            el.classList.remove("hiddenpreview");
                            el.classList.add("shownpreview");
                        });

                document.querySelector("#cachedTrans>span>.part1").innerHTML = cachedTransCount[appStates[currentAppStateIndex]];
                document.querySelector("#cachedTrans>span>.part2").innerHTML = cachedTransCashTotal[appStates[currentAppStateIndex]].toLocaleString('en-US').replace(/\.00/g, "");


                setGlobal(`ALDCACHE${appStates[currentAppStateIndex]}`, cachedTransactionQueries[appStates[currentAppStateIndex]]);
                reCreateCacheCleanupForm();
            };

            showLoadingScreen(`üóëÔ∏è FUTA: <sub>${json_response[id].priceTotal.toLocaleString('en-US').replace(/\.00/g, "")}`, "", ConfirmDialogContent);

            confirmFormYes = function () {
                delete json_response[id];
                tempTransQuery[appStates[currentAppStateIndex]] = "";
                for (const resp in json_response) {
                    tempTransQuery[appStates[currentAppStateIndex]] += `${json_response[resp].transMsg},`;
                }
                productdetails_string = GetProductDetails(tempTransQuery[appStates[currentAppStateIndex]]);

                cachedTransObjectString[appStates[currentAppStateIndex]] = productdetails_string; cachedTransObjectJson[appStates[currentAppStateIndex]] = JSON.parse(productdetails_string);

                json_response = cachedTransObjectJson[appStates[currentAppStateIndex]].json_response;

                cachedTransactionQueries[appStates[currentAppStateIndex]] = cachedTransObjectJson[appStates[currentAppStateIndex]].finalQuery;
                cachedTransCashTotal[appStates[currentAppStateIndex]] = eval(cachedTransObjectJson[appStates[currentAppStateIndex]].finalResponseTotal);

                var result_display = cachedTransObjectJson[appStates[currentAppStateIndex]].finalResponseMsg;

                if (cachedTempTrans2Process[appStates[currentAppStateIndex]])
                    if (cachedTempTrans2Process[appStates[currentAppStateIndex]].length <= 0)
                        document.querySelectorAll(".disabled").forEach(el => {
                            el.disabled = false;
                            el.classList.remove("disabled");
                            el.classList.add("enabled");
                        });

                if (cachedTransactionQueries[appStates[currentAppStateIndex]])
                    if (cachedTransactionQueries[appStates[currentAppStateIndex]].length <= 0)
                        document.querySelectorAll(".hiddenpreview").forEach(el => {
                            el.classList.remove("hiddenpreview");
                            el.classList.add("shownpreview");
                        });

                document.querySelector("#cachedTrans>span>.part1").innerHTML = cachedTransCount[appStates[currentAppStateIndex]];
                document.querySelector("#cachedTrans>span>.part2").innerHTML = cachedTransCashTotal[appStates[currentAppStateIndex]].toLocaleString('en-US').replace(/\.00/g, "");


                setGlobal(`ALDCACHE${appStates[currentAppStateIndex]}`, cachedTransactionQueries[appStates[currentAppStateIndex]]);

                reCreateCacheCleanupForm();
            }
        }

        function showLoadingScreen(loadingTitle = "", loadingSubTitle = "", loadingMsg = "") {
            hideLoadingScreen();
            closeFilterDialog();

            /*   document.getElementById("news_display").style.pointerEvents = "none"; document.getElementById("mywebview2").style.pointerEvents = "none"; */

            document.getElementById("loading-title").innerHTML = loadingTitle; document.getElementById("loading-subtitle").innerHTML = loadingSubTitle; document.getElementById("loading-text").innerHTML = loadingMsg;
            document.getElementById("loading-screen").classList.remove("hidden");
        }
        function hideLoadingScreen() {
            document.getElementById("news_display").style.pointerEvents = "";
            document.getElementById("mywebview2").style.pointerEvents = ""; document.getElementById("loading-title").innerHTML = "";
            document.getElementById("loading-subtitle").innerHTML = "";
            document.querySelector("#loading-screen .loading-content .buttonholder").innerHTML = "";
            document.getElementById("loading-text").innerHTML = "...";
            document.getElementById("loading-screen").classList.add("hidden");
        }

        function reCreateCacheCleanupForm() {
            document.getElementById("news_display").style.pointerEvents = "";
            document.getElementById("mywebview2").style.pointerEvents = "";
            document.getElementById("loading-screen").classList.add("hidden");

            var dialogContent = `<code><ul id="entries" class="left">`;
            for (const itemcount in cachedTransObjectJson[appStates[currentAppStateIndex]].json_response) {
                var row = cachedTransObjectJson[appStates[currentAppStateIndex]].json_response[itemcount];
                if (row.transMsg == 'undefined') break;
                var displaymultiplier = /((\-\-|\+\+|#|=|\+|”ø|-|\$)\d{0,}[p]{0,1}\d+)$/.test(row.transMsg) ? /((\-\-|\+\+|#|=|\+|”ø|-|\$)\d{0,}[p]{0,1}\d+)$/g.exec(row.transMsg)[1] : 1;
                dialogContent += `<li id="confirmCachedEntry" name="confirmCachedEntry_${itemcount}" >
       <div class="flex-column" >
        <span class="flex-row"><a href="#" id="confirmCachedEntry" name="TransactionEditDate_${itemcount}" title="${row.transDate}" onClick="handleTransEvent(event)">${row.transDate}</a>
        <a href="#" id="confirmCachedEntry" type="Jina La Shop" name="TransactionEditWarehouse_${itemcount}" title="${row.transWarehouseName}" onClick="handleTransEvent(event)">(${row.transWarehouseName})</a></span>
        <div class="flex-row"><div class="flex-row">
        <a href="#" id="confirmCachedEntry" name="TransactionEditDrinkName_${itemcount}" title="${row.rawproductname}" onClick="handleTransEvent(event)">${row.rawproductname}${row.transExtraDetails}</a>
        <a href="#" id="confirmCachedEntry" name="TransactionEditUnitPrice_${itemcount}" rel="@" type="Kiasi" title="${row.unitprice}" onClick="handleTransEvent(event)">${((row.unitprice == "") || (row.unitprice == 1)) ? "" : "@" + row.unitprice}</a>
        <a href="#" id="confirmCachedEntry" name="TransactionEditMultiplier_${itemcount}" title="${displaymultiplier.match(/\d+\.{0,1}\d{0,}/g)[0]}" onClick="handleTransEvent(event)" type="" rel="${appStateMarks[currentAppStateIndex]}">${displaymultiplier}</a></div>
       <button id="confirmCachedEntry" name="TransactionDelete_${itemcount}" onClick="handleTransEvent(event)">‚ùå</button></div>
       </div></li>`;
            }
            dialogContent += `</ul></code>`;

            document.getElementById("loading-text").innerHTML = dialogContent;
            document.getElementById("loading-screen").classList.remove("hidden");
            document.querySelector("#loading-screen .loading-content .buttonholder").innerHTML = `<button onClick="hideLoadingScreen();clearvalues()" >Subiri</button><button onclick='sendCachedTrans()'>Tuma Repoti</button><button id='btnClose' onClick='hideLoadingScreen();clearvalues()'> X </button>`;
            document.getElementById("loading-title").innerHTML = `Angalia vizuri na Sahihisha ripoti,<br/><sub>kabla ya kutuma. ${JSON.parse(cachedTransObjectString[appStates[currentAppStateIndex]]).finalResponseTotal.toLocaleString('en-US').replace(/\.00/g, "")}</sub>`
        }

        function initializeListeners() { /*load events*/

            document.getElementById('filter').addEventListener('click', function () {
                document.getElementById('filter-dialog-products2').classList.remove('hidden');
            });

            document.getElementById('editTransDateSubmit').addEventListener('click', function (e) {
                isoncurrenttime = false;
                var val = document.getElementById("editTransDate").value;
                if (/^(0{0,1}[1-9]|[12][0-9]|3[01])\/([0-9]{0,2}|1[012])\/(19|20)\d\d$/.test(val)) {
                    currentTransDateStr = (val == "") ? currentTransDateStr : val;
                    document.querySelector("#showTransDate>span").innerHTML = currentTransDateStr;
                } else show("Not a Valid Date", true);
                document.getElementById("filter-dialog-transDate").classList.add("hidden");
            });

            document.getElementById('editTransDateleft').addEventListener('click', function () {

                daystakeawayfromcurrent = daystakeawayfromcurrent - 1;

            });
            document.getElementById('editTransDateRight').addEventListener('click', function () {

                daystakeawayfromcurrent = daystakeawayfromcurrent + 1;

            });

            document.getElementById("resultpad").addEventListener("click", (e) => {

                setClip(tempTransObj[appStates[currentAppStateIndex]].finalTextResponseMsg, "", function (x) {
                    show("Text copied to clipboard");
                });


                try {
                    if ((document.getElementById("result_display").innerHTML != "") && (document.getElementById("filter-dialog").classList.contains("hidden") == false)) { };
                    if (document.querySelector("a.product.pressed")) document.querySelector("a.product.pressed").parentNode.classList.remove("hovering");

                    hideLoadingScreen();
                    document.querySelectorAll(".mypopupdialog").forEach(el => { el.classList.add("hidden") });
                    document.getElementById("myinputbar").classList.remove("hyper");
                } catch (e) { show("error loadCachedTrans::" + e.stack, true); }
            });

            document.getElementById("cachedTrans").addEventListener("click", e => {
                if (!cachedTransObjectString[appStates[currentAppStateIndex]]) {
                    show("Huja fadhi chochote...");
                    return 0;
                }
                reCreateCacheCleanupForm();
            });

            document.getElementById('search').addEventListener('input', function () {
                var val = this.value;
                var filteredProducts = ProductNamesLiWithInput.filter(function (product) {
                    return product.toLowerCase().includes(val.toLowerCase());
                });
                createList(filteredProducts, document.querySelector("#productsview>#results"));
                writtenInSearch = this.value;
            });

            document.getElementById("appState").addEventListener("click", e => {

                document.getElementById("choose-mode").classList.remove("hidden");
                document.querySelectorAll("button").forEach(btn => {
                    btn.classList.remove("pressed");
                });

                return false;
            });
            document.querySelector('#inputnumber_change').addEventListener('change', e => {
                var cashcollected = eval(e.srcElement.value);
                var total = /TOTAL:\sTZS\s(\d+,{0,1}\d+,{0,1}\d+,{0,1}\d+)/gm.exec(finalResponseMsg);
                if (total == null) return;
                total = (total.length > 0) ? total[1].replaceAll(",", "") : 0;
                var change = cashcollected - total;
                var currentresults = document.getElementById("result_display").innerHTML.replace(/<br>----------<br>(.*)/gm, "");
                currentresults = currentresults + "<br/>----------<br/>PAID: " + cashcollected.toString().replace(/\d{1,3}(?=(\d{3})+(?!\d))/g, '$&,') + "<br/>----------<br/>CHANGE: " + change.toString().replace(/\d{1,3}(?=(\d{3})+(?!\d))/g, '$&,') + "<end/>";
                document.getElementById("result_display").innerHTML = currentresults;
            });

            document.getElementById("search").addEventListener("focus", (e) => {
                /*   e.srcElement.value = ""; */
            });

            document.getElementById("selectmode").addEventListener("click", e => {
                document.getElementById("choose-mode").classList.add("hidden");
                document.getElementById("querydialog").classList.remove("hidden");
                document.querySelector("#querydialog>input").focus();

            });
            document.querySelectorAll("#traditionalQueryInput,#editCustomerName,#editTransDate").forEach(el => {
                el.addEventListener('keyup', function (e) {
                    if (e.key == undefined) return -1;
                    var thekey = e.key.toString();
                    target = e.target.id;
                    if (e.key === 'Enter') {
                        if (target == "traditionalQueryInput") {
                            var query = e.target.value;
                            if ((typeof query == "undefined") || (query == "")) return 0;
                            if (appStates[currentAppStateIndex] != "stocktake") {
                                var firstpart = (/\d+\.\d+$/.test(query)) ? /(\d+)\.\d+$/.exec(query)[1] : "";
                                var secondpart = /\.\d+$/.test(query) ? /\.(\d+)$/.exec(query)[1] : "";
                                if (firstpart != "" && secondpart != "") {
                                    var rg = new RegExp("[\+\+|\-|\+|\#|”ø]" + firstpart + "." + secondpart, "g");
                                    var adding = new RegExp("([\+\+|\-|\+|\#|”ø])" + firstpart + "." + secondpart, "g").exec(query);
                                    var prd = query.replaceAll(rg, "");
                                    query = prd + adding[1] + firstpart + "," + prd + adding[1] + "." + secondpart
                                }
                            }
                            query = `(${warehouseName.toLowerCase()})${query}`;
                            date = new Date();

                            query = (currentTransDateStr.replaceAll("&nbsp;", "").trim() + ` ${(date.getHours())}:${date.getMinutes()} ` + query.replaceAll(/\.(\d+)$/gm, "p$1")).trim(); if (appStates[currentAppStateIndex] == "stocktake") {
                                tempTransQuery[appStates[currentAppStateIndex]] = tempTransQuery[appStates[currentAppStateIndex]].replaceAll(query + ",", "").concat(`,${query}`);

                            } else {
                                tempTransQuery[appStates[currentAppStateIndex]] = tempTransQuery[appStates[currentAppStateIndex]].concat((`,${query},`).replace("undefined", "").replace(/\n/, "").trim());
                            }

                            tempTransObj[appStates[currentAppStateIndex]] = JSON.parse(GetProductDetails(tempTransQuery[appStates[currentAppStateIndex]].replace(/^,/, "")));
                            tempTransQuery[appStates[currentAppStateIndex]] = tempTransObj[appStates[currentAppStateIndex]].finalQuery;
                            document.querySelector("#result_display>ul").innerHTML = tempTransObj[appStates[currentAppStateIndex]].finalResponseMsg.replaceAll("\n", "<br/>");
                            document.querySelectorAll(".disabled").forEach(el => {
                                el.disabled = false;
                                el.classList.remove("disabled");
                                el.classList.add("enabled");
                            });
                            document.getElementById("submitbuttonholder").classList.remove("hyper");
                            document.getElementById("myinputbar").classList.remove("hyper");
                            document.getElementById("querydialog").classList.add("hidden");
                            document.getElementById("warehouseName").focus();
                        }
                        else if (target == "editTransDate") {
                            document.getElementById('editTransDate').dispatchEvent(new Event('click', {
                                bubbles: false,
                                cancelable: false
                            }));
                        }
                        else if (target == "editCustomerName") {
                            var val = (e.target.value == "") ? staffName : e.target.value;
                            document.getElementById("warehouseName").innerHTML = val;
                            warehouseName = val;
                            document.getElementById("filter-dialog-customers").classList.add("hidden");
                        }
                    }
                });

            });

            document.querySelectorAll("#results.selectproduct>li>a").forEach(el => {
                el.addEventListener("click", (event) => {
                    var newval = el.name.replaceAll("_", " "),
                        newediting = editing.replace(oldval, newval).replace(/@\d+\.{0,1}\d{0,}/, ""),
                        newquery = oldquery.replace(editing, newediting),
                        newjson_transactions = JSON.parse(GetProductDetails(newquery));
                    if (family == "confirmCachedEntry") {
                        cachedTransObjectString[appStates[currentAppStateIndex]] = JSON.stringify(newjson_transactions);
                        cachedTransactionQueries[appStates[currentAppStateIndex]] = newjson_transactions.finalQuery;
                        cachedTransCashTotal[appStates[currentAppStateIndex]] = eval(newjson_transactions.finalResponseTotal);

                        if (cachedTempTrans2Process[appStates[currentAppStateIndex]])
                            if (cachedTempTrans2Process[appStates[currentAppStateIndex]].length <= 0)
                                document.querySelectorAll(".disabled").forEach(el => {
                                    el.disabled = false;
                                    el.classList.remove("disabled");
                                    el.classList.add("enabled");
                                });
                        if (cachedTransactionQueries[appStates[currentAppStateIndex]])
                            if (cachedTransactionQueries[appStates[currentAppStateIndex]].length <= 0)
                                document.querySelectorAll(".hiddenpreview").forEach(el => {
                                    el.classList.remove("hiddenpreview");
                                    el.classList.add("shownpreview");
                                });

                        document.querySelector("#cachedTrans>span>.part1").innerHTML = cachedTransCount[appStates[currentAppStateIndex]];
                        document.querySelector("#cachedTrans>span>.part2").innerHTML = cachedTransCashTotal[appStates[currentAppStateIndex]].toLocaleString('en-US').replace(/\.00/g, "");
                        setGlobal(`ALDCACHE${appStates[currentAppStateIndex]}`, cachedTransactionQueries[appStates[currentAppStateIndex]]);

                        reCreateCacheCleanupForm();
                    }
                    else if (family == "confirmTransactionEntry") {
                        tempTransObj[appStates[currentAppStateIndex]] = newjson_transactions;
                        document.querySelector("#result_display>ul").innerHTML = tempTransObj[appStates[currentAppStateIndex]].finalResponseMsg.replaceAll("\n", "<br/>");
                        document.querySelectorAll(".disabled").forEach(el => {
                            el.disabled = false;
                            el.classList.remove("disabled");
                            el.classList.add("enabled");
                        });

                        document.getElementById("submitbuttonholder").classList.remove("hyper");
                        document.getElementById("myinputbar").classList.remove("hyper");
                        tempTransQuery[appStates[currentAppStateIndex]] = tempTransObj[appStates[currentAppStateIndex]].finalQuery;
                        setGlobal(`ALDTMP${appStates[currentAppStateIndex]}`, tempTransObj[appStates[currentAppStateIndex]].finalQuery);
                    }
                    closeFilterDialog();
                });
            });

        }

        function addTransactionToCache(event) {
            if (cachedTransCashTotal[appStates[currentAppStateIndex]] == "Subiri ..") return;
            let target = event.target, currentQuery = tempTransObj[appStates[currentAppStateIndex]].finalQuery;

            if (cachedTransactionQueries[appStates[currentAppStateIndex]] == undefined) {

                cachedTransactionQueries[appStates[currentAppStateIndex]] = currentQuery;
                cachedTransCount[appStates[currentAppStateIndex]] = 1;
                cachedTransObjectJson[appStates[currentAppStateIndex]] = tempTransObj[appStates[currentAppStateIndex]];
                cachedTransObjectString[appStates[currentAppStateIndex]] = productdetails_string;
                cachedTransCashTotal[appStates[currentAppStateIndex]] = /TOTAL:\sTZS\s(\d+,{0,1}\d+,{0,1}\d+,{0,1}\d+)/gm.exec(tempTransObj[appStates[currentAppStateIndex]].finalResponseMsg);

                if (cachedTransCashTotal[appStates[currentAppStateIndex]])
                    cachedTransCashTotal[appStates[currentAppStateIndex]] = (cachedTransCashTotal[appStates[currentAppStateIndex]].length > 0) ? eval(cachedTransCashTotal[appStates[currentAppStateIndex]][1].replaceAll(",", "")) : 0;
                else cachedTransCashTotal[appStates[currentAppStateIndex]] = 0;

            } else {
                cachedTransactionQueries[appStates[currentAppStateIndex]] += ",||" + currentQuery;
                cachedTransCount[appStates[currentAppStateIndex]] = cachedTransactionQueries[appStates[currentAppStateIndex]].split("||").length;

                cachedTransObjectString[appStates[currentAppStateIndex]] = GetProductDetails(cachedTransactionQueries[appStates[currentAppStateIndex]]);

                cachedTransObjectJson[appStates[currentAppStateIndex]] = JSON.parse(cachedTransObjectString[appStates[currentAppStateIndex]]);

                var total = /TOTAL:\sTZS\s(\d+,{0,1}\d+,{0,1}\d+,{0,1}\d+)/gm.exec(cachedTransObjectJson[appStates[currentAppStateIndex]].finalResponseMsg);

                if (total != null) cachedTransCashTotal[appStates[currentAppStateIndex]] = ((total.length > 0) ? eval(total[1].replaceAll(",", "")) : 0);
            }

            document.querySelector("#cachedTrans>span>.part1").innerHTML = cachedTransCount[appStates[currentAppStateIndex]];
            document.querySelector("#cachedTrans>span>.part2").innerHTML = cachedTransCashTotal[appStates[currentAppStateIndex]];


            for (const TransType in cachedTransactionQueries) {
                var transaction = cachedTransactionQueries[TransType];
                setGlobal(`ALDCACHE${TransType}`, transaction);
            }

            document.querySelectorAll(".hiddenpreview").forEach(el => {
                el.classList.remove("hiddenpreview");
                el.classList.add("shownpreview");
            });
            clearvalues("everything");
            reCreateCacheCleanupForm();
        }

        function getRunningSpeedRange(speed) {

            if (speed <= 5) {
                return "Slow";
            } else if (speed <= 10) {
                return "Medium";
            } else {
                return "Fast";
            }
        }

        function confirmCustomerPick(event) {
            var target = event.target;
            if (target.title == "") return;
            warehouseName = target.title;
            document.getElementById("warehouseName").innerHTML = warehouseName;

            closeFilterDialog();
        }

        function handleTransEvent(event) {
            var target = event.target,
                grandparent = target.parentNode.parentNode,
                action = target.name.split("_"),
                family = target.id;
            id = eval(action[1]),
                action = action[0],
                oldval = target.title,
                type = target.type,
                sign = target.rel,
                content = "";
            if (family == "confirmCachedEntry") {
                var json_transactions = JSON.parse(cachedTransObjectString[appStates[currentAppStateIndex]]);
            }
            else if (family == "confirmTransactionEntry") {
                var json_transactions = tempTransObj[appStates[currentAppStateIndex]];
            }
            var oldquery = json_transactions.finalQuery,
                editing = `${json_transactions.json_response[id].transDate} ${json_transactions.json_response[id].transTime} ${json_transactions.json_response[id].transMsg}`;
            var dialog = document.getElementById("filter-dialog");

            switch (action) {
                case "TransactionEditDrinkName":
                    document.getElementById("filter-dialog-products").classList.remove("hidden");
                    document.getElementById("filter-dialog-products").name = target.name + "__" + editing;

                    confirmFormPick = function (e) {
                        var el = e.currentTarget;
                        var selectedproductname = el.name.replace("_", " ");
                        document.getElementsByName("TransactionEditDrinkName_0").innerHTML = selectedproductname;
                        var newval = el.name.replaceAll("_", " "),
                            newediting = editing.replace(oldval, newval).replace(/@\d+\.{0,1}\d{0,}/, ""),
                            newquery = oldquery.replace(editing, newediting),
                            newjson_transactions = JSON.parse(GetProductDetails(newquery));
                        if (family == "confirmCachedEntry") {
                            cachedTransObjectString[appStates[currentAppStateIndex]] = JSON.stringify(newjson_transactions);
                            cachedTransactionQueries[appStates[currentAppStateIndex]] = newjson_transactions.finalQuery;
                            cachedTransCashTotal[appStates[currentAppStateIndex]] = eval(newjson_transactions.finalResponseTotal);

                            if (cachedTempTrans2Process[appStates[currentAppStateIndex]])
                                if (cachedTempTrans2Process[appStates[currentAppStateIndex]].length <= 0)
                                    document.querySelectorAll(".disabled").forEach(el => {
                                        el.disabled = false;
                                        el.classList.remove("disabled");
                                        el.classList.add("enabled");
                                    });
                            if (cachedTransactionQueries[appStates[currentAppStateIndex]])
                                if (cachedTransactionQueries[appStates[currentAppStateIndex]].length <= 0)
                                    document.querySelectorAll(".hiddenpreview").forEach(el => {
                                        el.classList.remove("hiddenpreview");
                                        el.classList.add("shownpreview");
                                    });

                            document.querySelector("#cachedTrans>span>.part1").innerHTML = cachedTransCount[appStates[currentAppStateIndex]];
                            document.querySelector("#cachedTrans>span>.part2").innerHTML = cachedTransCashTotal[appStates[currentAppStateIndex]].toLocaleString('en-US').replace(/\.00/g, "");
                            setGlobal(`ALDCACHE${appStates[currentAppStateIndex]}`, cachedTransactionQueries[appStates[currentAppStateIndex]]);
                            reCreateCacheCleanupForm();
                        }
                        else if (family == "confirmTransactionEntry") {
                            tempTransObj[appStates[currentAppStateIndex]] = newjson_transactions;

                            document.querySelector("#result_display>ul").innerHTML = tempTransObj[appStates[currentAppStateIndex]].finalResponseMsg.replaceAll("\n", "<br/>");
                            document.querySelectorAll(".disabled").forEach(el => {
                                el.disabled = false;
                                el.classList.remove("disabled");
                                el.classList.add("enabled");
                            });

                            document.getElementById("submitbuttonholder").classList.remove("hyper");
                            document.getElementById("myinputbar").classList.remove("hyper");
                            tempTransQuery[appStates[currentAppStateIndex]] = tempTransObj[appStates[currentAppStateIndex]].finalQuery;
                            setGlobal(`ALDTMP${appStates[currentAppStateIndex]}`, tempTransObj[appStates[currentAppStateIndex]].finalQuery);
                        }
                        closeFilterDialog();
                    };
                    break;
                case "TransactionEditDate":
                    document.getElementById("filter-dialog-transDate").classList.remove("hidden");
                    document.getElementById("filter-dialog-transDate").name = target.name + "__" + editing;
                    confirmFormEdit = function (e) {
                        if (e.key != "Enter") return;
                        var newval = document.querySelector("#filter-dialog-transDate>div>input").value;
                        var newediting = editing.replace(sign + oldval, sign + newval);
                        var newquery = oldquery.replace(editing, newediting);
                        var newjson_transactions = JSON.parse(GetProductDetails(newquery));
                        if (family == "confirmCachedEntry") {
                            cachedTransObjectJson[appStates[currentAppStateIndex]] = newjson_transactions;
                            cachedTransObjectString[appStates[currentAppStateIndex]] = JSON.stringify(newjson_transactions);
                            cachedTransactionQueries[appStates[currentAppStateIndex]] = newjson_transactions.finalQuery;
                            cachedTransCashTotal[appStates[currentAppStateIndex]] = eval(newjson_transactions.finalResponseTotal);

                            if (cachedTempTrans2Process[appStates[currentAppStateIndex]])
                                if (cachedTempTrans2Process[appStates[currentAppStateIndex]].length <= 0)
                                    document.querySelectorAll(".disabled").forEach(el => {
                                        el.disabled = false;
                                        el.classList.remove("disabled");
                                        el.classList.add("enabled");
                                    });
                            if (cachedTransactionQueries[appStates[currentAppStateIndex]])
                                if (cachedTransactionQueries[appStates[currentAppStateIndex]].length <= 0)
                                    document.querySelectorAll(".hiddenpreview").forEach(el => {
                                        el.classList.remove("hiddenpreview");
                                        el.classList.add("shownpreview");
                                    });
                            document.querySelector("#cachedTrans>span>.part1").innerHTML = cachedTransCount[appStates[currentAppStateIndex]];
                            document.querySelector("#cachedTrans>span>.part2").innerHTML = cachedTransCashTotal[appStates[currentAppStateIndex]].toLocaleString('en-US').replace(/\.00/g, "");
                            setGlobal(`ALDCACHE${appStates[currentAppStateIndex]}`, cachedTransactionQueries[appStates[currentAppStateIndex]]);

                            closeFilterDialog();

                            reCreateCacheCleanupForm();
                        } else {
                            document.querySelector("#result_display>ul").innerHTML = newjson_transactions.finalResponseMsg.replaceAll("\n", "<br/>");
                            document.querySelectorAll(".disabled").forEach(el => {
                                el.disabled = false;
                                el.classList.remove("disabled");
                                el.classList.add("enabled");
                            });
                            closeFilterDialog();
                            document.getElementById("submitbuttonholder").classList.remove("hyper");
                            document.getElementById("myinputbar").classList.remove("hyper");
                            tempTransQuery[appStates[currentAppStateIndex]] = newjson_transactions.finalQuery;
                            setGlobal(`ALDTMP${appStates[currentAppStateIndex]}`, newjson_transactions.finalQuery);
                            tempTransObj[appStates[currentAppStateIndex]] = newjson_transactions;
                        }
                    };

                    break;
                case "TransactionEditMultiplier":
                case "TransactionEditUnitPrice":
                case "TransactionEditWarehouse":
                    content = `<h3>Ingiza ${type} (${oldval}) </h3><div><input name="" placeholder="${oldval}" type="${(action == "TransactionEditWarehouse") ? `text` : `number`}  " onkeyup="confirmFormEdit(event)"/></div>`;
                    dialog.innerHTML = content;
                    confirmFormEdit = function (e) {
                        if (e.key != "Enter") return;
                        var newval = document.querySelector("#filter-dialog>div>input").value;
                        var newediting = editing.replace(sign + oldval, sign + newval);
                        var newquery = oldquery.replace(editing, newediting);
                        var newjson_transactions = JSON.parse(GetProductDetails(newquery));
                        if (family == "confirmCachedEntry") {
                            cachedTransObjectJson[appStates[currentAppStateIndex]] = newjson_transactions;
                            cachedTransObjectString[appStates[currentAppStateIndex]] = JSON.stringify(newjson_transactions);
                            cachedTransactionQueries[appStates[currentAppStateIndex]] = newjson_transactions.finalQuery;
                            cachedTransCashTotal[appStates[currentAppStateIndex]] = eval(newjson_transactions.finalResponseTotal);

                            if (cachedTempTrans2Process[appStates[currentAppStateIndex]])
                                if (cachedTempTrans2Process[appStates[currentAppStateIndex]].length <= 0)
                                    document.querySelectorAll(".disabled").forEach(el => {
                                        el.disabled = false;
                                        el.classList.remove("disabled");
                                        el.classList.add("enabled");
                                    });
                            if (cachedTransactionQueries[appStates[currentAppStateIndex]])
                                if (cachedTransactionQueries[appStates[currentAppStateIndex]].length <= 0)
                                    document.querySelectorAll(".hiddenpreview").forEach(el => {
                                        el.classList.remove("hiddenpreview");
                                        el.classList.add("shownpreview");
                                    });
                            document.querySelector("#cachedTrans>span>.part1").innerHTML = cachedTransCount[appStates[currentAppStateIndex]];
                            document.querySelector("#cachedTrans>span>.part2").innerHTML = cachedTransCashTotal[appStates[currentAppStateIndex]].toLocaleString('en-US').replace(/\.00/g, "");
                            setGlobal(`ALDCACHE${appStates[currentAppStateIndex]}`, cachedTransactionQueries[appStates[currentAppStateIndex]]);

                            closeFilterDialog();

                            reCreateCacheCleanupForm();
                        } else {
                            document.querySelector("#result_display>ul").innerHTML = newjson_transactions.finalResponseMsg.replaceAll("\n", "<br/>");
                            document.querySelectorAll(".disabled").forEach(el => {
                                el.disabled = false;
                                el.classList.remove("disabled");
                                el.classList.add("enabled");
                            });
                            closeFilterDialog();
                            document.getElementById("submitbuttonholder").classList.remove("hyper");
                            document.getElementById("myinputbar").classList.remove("hyper");
                            tempTransQuery[appStates[currentAppStateIndex]] = newjson_transactions.finalQuery;
                            setGlobal(`ALDTMP${appStates[currentAppStateIndex]}`, newjson_transactions.finalQuery);
                            tempTransObj[appStates[currentAppStateIndex]] = newjson_transactions;
                        }
                    };
                    document.getElementById("filter-dialog").classList.remove("hidden");
                    break;
                case "TransactionDelete":
                    var newquery = oldquery.replace(editing, "").replace(/,$/, "").replace(/^,/, "");
                    var newjson_transactions = JSON.parse(GetProductDetails(newquery));
                    tempTransObj[appStates[currentAppStateIndex]] = newjson_transactions;
                    if (family == "confirmTransactionEntry") {
                        document.querySelector("#result_display>ul").innerHTML = newjson_transactions.finalResponseMsg.replaceAll("\n", "<br/>");
                        document.querySelectorAll(".disabled").forEach(el => {
                            el.disabled = false;
                            el.classList.remove("disabled");
                            el.classList.add("enabled");
                        });
                        document.getElementById("submitbuttonholder").classList.remove("hyper");
                        document.getElementById("myinputbar").classList.remove("hyper");
                        tempTransQuery[appStates[currentAppStateIndex]] = newjson_transactions.finalQuery;
                        setGlobal(`ALDTMP${appStates[currentAppStateIndex]}`, newjson_transactions.finalQuery);
                        tempTransObj[appStates[currentAppStateIndex]] = newjson_transactions;
                    }
                    else if (family = "confirmCachedEntry") {
                        cachedTransObjectString[appStates[currentAppStateIndex]] = JSON.stringify(newjson_transactions);
                        cachedTransObjectJson[appStates[currentAppStateIndex]] = newjson_transactions;
                        cachedTransactionQueries[appStates[currentAppStateIndex]] = newjson_transactions.finalQuery;
                        cachedTransCashTotal[appStates[currentAppStateIndex]] = eval(newjson_transactions.finalResponseTotal);

                        if (cachedTempTrans2Process[appStates[currentAppStateIndex]])
                            if (cachedTempTrans2Process[appStates[currentAppStateIndex]].length <= 0)
                                document.querySelectorAll(".disabled").forEach(el => {
                                    el.disabled = false;
                                    el.classList.remove("disabled");
                                    el.classList.add("enabled");
                                });
                        if (cachedTransactionQueries[appStates[currentAppStateIndex]])
                            if (cachedTransactionQueries[appStates[currentAppStateIndex]].length <= 0)
                                document.querySelectorAll(".hiddenpreview").forEach(el => {
                                    el.classList.remove("hiddenpreview");
                                    el.classList.add("shownpreview");
                                });

                        document.querySelector("#cachedTrans>span>.part1").innerHTML = cachedTransCount[appStates[currentAppStateIndex]];
                        document.querySelector("#cachedTrans>span>.part2").innerHTML = cachedTransCashTotal[appStates[currentAppStateIndex]].toLocaleString('en-US').replace(/\.00/g, "");

                        setGlobal(`ALDCACHE${appStates[currentAppStateIndex]}`, cachedTransactionQueries[appStates[currentAppStateIndex]]);
                        reCreateCacheCleanupForm();
                    }
                    break;

                default:
                    break;
            }

            event.stopPropagation();
            createProductsView();

            try { document.querySelector("#filter-dialog>div>input").focus(); } catch (e) { }

        }
        function handleFilterDialogFilterSelection(event) {
            let target = event.target;
            if (target.localName == "li") {
                target = target.firstElementChild;
            } else if (target.localName == "label") {
                target = target.previousElementSibling;
            }
            if (target.type != "checkbox") return;

            const filterType = target.id;
            const products = document.querySelectorAll("li.product");

            const matchingProducts = [];
            if (filterType.startsWith("category")) {
                const category = filterType.split("_")[1];
                for (const product of products) {

                    let checking = product.dataset.category.split(" ")[2];
                    if (checking == category) {
                        if (product.classList.contains("active")) {
                            product.classList.remove("active");
                            target.checked = false;
                            target.parentNode.classList.remove("selected");
                        } else {
                            product.classList.add("active");
                            target.parentNode.classList.add("selected");
                            target.checked = true;
                        }
                    }
                }
            } else if (filterType === "financial_nps") {
                const financialNps = eval(target.value);
                products.forEach(product => {
                    const productNps = eval(product.dataset.financialNps);
                    if (productNps >= financialNps) {
                        matchingProducts.push(product);
                    }
                });
            } else if (filterType === "filter_speed") {

                const speed = eval(target.value);
                products.forEach(product => {
                    const productSpeed = eval(product.dataset.speed);
                    if (productSpeed >= speed) {
                        matchingProducts.push(product);
                    }
                });
            }
            closeFilterDialog();
        }

        function closeFilterDialog() {
            const dialog = document.querySelectorAll(".mypopupdialog").forEach(el => {
                if (!el.classList.contains("hidden"))
                    el.classList.add("hidden");
            });
        }

        function GetProductDetails(query = "(al)Uhai 600ml @400+1", appState = "", exactdtail = "") {
            query = query.replace(/\(plus\)/gm, "+").replace(/,$/, "").replaceAll(/\|\|/gm, "").replace(/^,/, "").replace(/,$/, "").trim();

            if (typeof returntype == 'undefined') var returntype = "single";

            if (settingsObj.data.alradaitemnames == undefined) throw new Error("settingsObj.data.alradaitemnames is undefined");
            settingsObj.data.alradaitemnames = settingsObj.data.alradaitemnames.replace(/(?:\[r,p]\n|\[r,p]|\n)/g, "<br>").replace(/\sTZS/g, "");

            var data = JSON.parse(settingsObj.data.alradaitemnames);
            var headerRow = Object.keys(data[0]);
            var body = data.map(row => Object.values(row));
            var dataHeadings = [], dataBody = [];
            headerRow.forEach(function (title) {
                dataHeadings.push(title);
            });
            body.forEach(function (res) {
                dataBody.push(res);
            });
            var data = dataBody.map((arr, i) => Object.assign({}, ...dataHeadings.map((head, j) => ({ [head]: arr[j] }))));
            var asjson = JSON.stringify(data);
            var cleanasjson = asjson.replace(/(?:\r\n|\r|\n)/g, "<br>").replace(/\sTZS/g, "");

            if (typeof query !== "string") { query = new String(query); }
            var howmanyitems = query.split(new RegExp(",")).filter((n) => n);

            let response = "", itemcount = 1, total = 0, projectedProfitTotal = 0, remain = "", multiplier = "", rawproductname = "", projectedProfit = 0, responseArr = [];
            howmanyitems.some(function (product, n) {
                var priceTotal = 0, netpriceTotal = 0, transType = "",
                    unitprice = (/\@\d+/.test(product)) ? eval(product.match(/\@\d+\.{0,1}\d{0,}/)[0].replace("@", "")) : "",
                    getendvalue = /(\+{1,2}|\-{1,2}|”ø|\-|\#|\$)\d{0,}\s{0,1}[r,p]{0,1}\d+\.{0,1}\d{0,}$|[r,p]\d+\.{0,1}\d{0,}$/.test(product) ? /(\+{1,2}|\-{1,2}|”ø|\-|\#|\$)\d{0,}\s{0,1}[r,p]{0,1}\d+$|[r,p]\d+$/.exec(product)[0] : "",
                    appStateMark = /(\+\+|\-\-|\+|\-|\=|\$|\#|”ø|\$)\d{0,}p{0,1}\d+$/.test(product) ? /(\+\+|\-\-|\+|\-|\=|\$|\#|”ø|\$)\d{0,}p{0,1}\d+$/g.exec(product)[1] : "",
                    myval = getendvalue.match(/[”ø,\+,\-,\#,\$](\d+)/),
                    whole_multiplier = (/[\$,”ø,\#,\+,\-][r,p]\d+\.{0,1}\d{0,}/.test(product)) ? 0 : (/[”ø,\+,\-,\#,\$]\d{0,}p{0,1}\d+$/.test(product)) ? eval(getendvalue.match(/[”ø,\+,\-,\#,\$](\d+\.{0,1}\d{0,})/)[1]) : 1,
                    retail_multiplier = 0, transCarton = "", transExtraDetails = "";
                var getmultipliers = getendvalue.split(" ");

                getmultipliers = getmultipliers[0];
                if (/(\d+\/\d+)[(\/\d+)]{0,5}/gm.exec(product))
                    var datetext = /(\d+\/\d+)[(\/\d+)]{0,5}/gm.exec(product)[0].trim();
                else { datetext = ALRADADATE }
                if (/\d+\/\d+[\/\d+]{0,5}\s(\d+:\d+).*\(/gm.exec(product))
                    var timetext = /\d+\/\d+[\/\d+]{0,5}\s(\d+:\d+:\d+).*\(/gm.exec(product)[1].trim();
                else var timetext = "00:00:00";
                rawproductname = product.replace(/(\d+\/\d+)[(\/\d+)]{0,5}/gm, "").replace(/(\d+ +[r,p] +|^[r,p] +|^\d+ +|^\d+|[”ø,\+,\$]\d+$)/g, "").replace(/#\d{0,}[r,p]{0,1}\d+|\#\d+$|[\+,\$]\d+|[\-\-,\+\+]/, "").replace(/\#\d+/, "").replace(/@\d+\.{0,1}\d{0,}/g, "").replace(/^t +| +0 +/, "").replace(/^[r,p] +|\s[r,p]\d+\.{0,1}\d{0,}$/g, "").replace(/^.*(\(.*)/g, "$1").trim();
                rawproductname = rawproductname.replace(/^[r,p] +/g, "").replace(/\s#\d+|”øp{0,1}\d+\.{0,1}\d{0,}/, "");
                rawproductname = rawproductname.replace(/\s[r,p]\d+\.{0,1}\d{0,}|\+[r,p]\d+\.{0,1}\d{0,}v$/, "");
                rawproductname = rawproductname.replace(/=\d+\.{0,1}\d{0,}|[r,p]\d+\.{0,1}\d{0,}$/, "").replace(/^\(.*\)/, "").replace(/\+$/, "").trim();
                transExtraDetails = (/(::.*)/.test(rawproductname)) ? rawproductname.match(/(::.*)/)[0] : "";
                rawproductname = rawproductname.replace(transExtraDetails, "");

                if (transType == "" || transType == undefined)
                    transType = (/\#\d+/g.test(product.trim())) ? "stocktake" : (/\=\d|\+\+/g.test(product.trim())) ? "purchase" : /(\d\s[r,p]\s)|(\s[r,p]\s)|(^r\s)|([r,p]\d+$)/g.test(product.trim().toLowerCase())
                        ? "retail"
                        : "wholesale";
                try {
                    if (/\=\d+/g.test(product)) {
                        unitprice = 1;
                        priceTotal = /\=(\d+)/g.exec(product)[1];
                        displaymultiplier = priceTotal;
                    } else if (/\$\d+/g.test(product)) {
                        unitprice = 1;
                        priceTotal = /\$(\d+)/g.exec(product)[1];
                        displaymultiplier = priceTotal;
                    } else
                        JSON.parse(cleanasjson).some(function (item, i) {

                            if (new RegExp(rawproductname.toLowerCase()).test(item.DrinkName.toLowerCase())) {
                                transCarton = item.carton;

                                if (getendvalue.match(/\#/)) {
                                    w_remain = (/\#\d+/g.test(getendvalue)) ? eval(getendvalue.match(/\#\d+/)[0].replace("#", "")) : 0;
                                    r_remain = (!/[r,p]\d+/g.test(getendvalue)) ? "" : eval(/[r,p](\d+)/g.exec(getendvalue)[1]) / item.carton;
                                    remain = w_remain + r_remain;
                                }

                                retail_multiplier = (getendvalue.indexOf("p") == -1) ? 0 : eval(getendvalue.match(/[r,p]\d+/)[0].replace("p", ""));
                                multiplier = whole_multiplier + (retail_multiplier / item.carton);

                                if ((appStates[currentAppStateIndex] == "purchase") || (appStates[currentAppStateIndex] == "stocktake")) {
                                    var profitfromwholesale = ((item.w_price_a * whole_multiplier) - ((item.w_purchase_a * whole_multiplier)));
                                    var profitfromretail = ((item.p_price_a * retail_multiplier) - (((item.w_purchase_a / item.carton) * retail_multiplier)));
                                    projectedProfit = ((item.w_price_a * whole_multiplier) - ((item.w_purchase_a * whole_multiplier))) + profitfromretail;
                                }
                                if (unitprice == "") {
                                    if (transType == "purchase") {
                                        if (whole_multiplier)
                                            unitprice = item.w_purchase_a,
                                                priceTotal += item.w_purchase_a * whole_multiplier;
                                        if (retail_multiplier) {

                                            if (retail_multiplier = (item.carton / 2))
                                                unitprice = (item.w_purchase_a / 2) / retail_multiplier;
                                            else
                                                unitprice = Math.round((((unitprice == "") ? (item.w_purchase_a + item.p_purchasemarkup_a) : unitprice) / item.carton) * 100) / 100;

                                            priceTotal += unitprice * retail_multiplier;
                                        }
                                    }
                                    else {
                                        if (whole_multiplier || whole_multiplier == 0)
                                            unitprice = item.w_price_a,
                                                priceTotal += item.w_price_a * whole_multiplier;
                                        if (retail_multiplier) {
                                            unitprice = item.p_price_a;
                                            priceTotal += unitprice * retail_multiplier;
                                        }
                                    }
                                    product = product.replace(new RegExp(`(${getendvalue.replaceAll(/(\+)/gm, "\\$1")})`), `@${unitprice}$1`);
                                } else {
                                    if (whole_multiplier)
                                        priceTotal = unitprice * whole_multiplier;
                                    if (retail_multiplier)
                                        priceTotal += unitprice * retail_multiplier;
                                    product = product.replace(new RegExp(`(\@\d+\.{0,1}\d{0,})`), `@${unitprice}`);
                                }

                                throw BreakException;
                            }
                        });
                } catch (e) {
                    if (e !== BreakException) throw e;
                }
                var realitemcount = itemcount - 1;

                var displaymultiplier = ((whole_multiplier > 0) ? whole_multiplier : 0) + ((retail_multiplier > 0) ? `p${retail_multiplier}` : "");
                var realeditmultipliersign = (appStateMark == "=") ? "" : `${appStateMark}${displaymultiplier}`;
                total = total + parseFloat(priceTotal);

                projectedProfitTotal += parseFloat(projectedProfit);
                if (priceTotal == "") {
                    priceTotal = (priceTotal == "") ? ((/.*=\d+/.test(rawproductname)) ? rawproductname.match(/\d+$/)[0] : 0) : 0;
                }

                let transDate = datetext,
                    transTime = timetext,
                    transMsg = product.replace(`${datetext} ${timetext}`, "").trim();
                transUnitPrice = unitprice,
                    transWarehouseName = /\((.*)\)/gm.test(product) ? /\((.*)\)/gm.exec(product)[1].toLowerCase() : warehouseName.toLowerCase(),
                    transStaffID = staffName.slice(0, 2),
                    transType = (specialTransType == "") ? appState : specialTransType;
                getendvalue = (getendvalue) ? getendvalue : "";

                response = `${response}<li id="confirmTransactionEntry" name="confirmTransactionEntry_${realitemcount}" >`;
                response += `<div class="flex-row"><div class="flex-row"><small>${itemcount}.</small><a id="confirmTransactionEntry" href="#" name="TransactionEditDrinkName_${realitemcount}" title="${rawproductname}${transExtraDetails}" onClick="handleTransEvent(event)" > ${rawproductname}${transExtraDetails}</a>`;
                response += `<a id="confirmTransactionEntry" href="#" name="TransactionEditUnitPrice_${realitemcount}" rel="@" type="Kiasi" title="${unitprice}" onClick="handleTransEvent(event)"> ${((unitprice == "") || (unitprice == 1)) ? "" : "@" + unitprice}</a>`;
                if (appStateMark == "=") {
                    response += `<a id="confirmTransactionEntry" href="#" name="TransactionEditMultiplier_${realitemcount}" rel="${appStateMark}" title="${priceTotal}" onClick="handleTransEvent(event)">${realeditmultipliersign}  =${priceTotal.toLocaleString('en-US').replace(/\.00/g, "").trim()} </a>`;
                }
                else if (appStateMark != "$")
                    response += `<a id="confirmTransactionEntry" href="#" name="TransactionEditMultiplier_${realitemcount}" rel="${appStateMark}" title="${displaymultiplier}" onClick="handleTransEvent(event)">${realeditmultipliersign}  =${priceTotal.toLocaleString('en-US').replace(/\.00/g, "").trim()} </a>`;
                else
                    response += `<a id="confirmTransactionEntry" href="#" name="TransactionEditMultiplier_${realitemcount}" rel="${appStateMark}" title="${displaymultiplier}" onClick="handleTransEvent(event)">${realeditmultipliersign}</a>`;
                response += `<small><a id="confirmTransactionEntry" href="#" name="TransactionEditWarehouse_${realitemcount}" title="${transWarehouseName}" type="Jina La Shop" onClick="handleTransEvent(event)">&nbsp;${(transWarehouseName != staffName) ? "(" + transWarehouseName + ")" : "&nbsp;"}</a></small></div>`;
                response += `<div class="buttonholder flex-row"><button id="confirmTransactionEntry" name="TransactionDelete_${realitemcount}" onClick="handleTransEvent(event)">‚ùå</button></div></div></li>`;

                const currentUnixTime = Math.floor(new Date(currentTransDateStr_Official) / 1000);

                responseArr.push({ transDate, transTime, currentUnixTime, transWarehouseName, transMsg, transExtraDetails, getendvalue, rawproductname, transUnitPrice, transStaffID, transType, rawproductname, remain, multiplier, transCarton, unitprice, priceTotal, netpriceTotal });
                itemcount++;
                unitprice = "";

                try {
                    var sele = 'li.product[name=\"' + rawproductname.replaceAll(" ", "_") + '\"]';
                    try {
                        document.querySelector(sele).classList.add("processed");
                        if (appStates[currentAppStateIndex] == "stocktake") {
                            var child = document.querySelector(sele).lastChild;
                            child.classList.add("hidden");
                        }
                    } catch (e) { }
                } catch (e) { }
            });

            finalResponseMsg = `${response}\n<li class="total">TOTAL: ` + total.toLocaleString('en-US', {
                style: 'currency',
                currency: 'tzs'
            }).replace(/\.00/g, "") + " " + ((projectedProfitTotal == "") ? `\r\n` : ` <small>&nbsp;(prf: ${projectedProfitTotal.toLocaleString('en-US').replace(/\.00/g, "")})</small>  </li>\n`);

            var newquery = "";
            var dom = new DOMParser().parseFromString(finalResponseMsg, "text/html");
            var finalTextResponseMsg = dom.body.textContent.replaceAll("‚ùå", `\n`).trim() || "";

            for (const val in responseArr) {

                newquery += `,${responseArr[val].transDate} ${responseArr[val].transTime} ${responseArr[val].transMsg}`;
            }
            newquery = newquery.replace(/^,/, "");
            return JSON.stringify({ json_response: responseArr, finalTextResponseMsg: finalTextResponseMsg, finalResponseMsg: finalResponseMsg, finalResponseTotal: total, finalQuery: newquery });
        }

        function clearvalues(scope = "") {
            if (typeof tempTransQuery[appStates[currentAppStateIndex]] == "undefined") tempTransQuery[appStates[currentAppStateIndex]] = "";
            document.getElementById("search").value = "";
            if (tempTransObj[appStates[currentAppStateIndex]])
                if ((productdetails_string == "") && (typeof tempTransObj[appStates[currentAppStateIndex]].finalResponseMsg != "undefined")) {
                    document.querySelector("#result_display>ul").innerHTML = tempTransObj[appStates[currentAppStateIndex]].finalResponseMsg.replaceAll("\n", "<br/>");;
                    document.querySelectorAll(".enabled").forEach(el => {
                        el.disabled = false;
                        el.classList.remove("enabled");
                        el.classList.add("disabled");
                    });
                } else if (scope == "everything") {
                    document.querySelector("#result_display>ul").innerHTML = "";
                    productdetails_string = "", tempTransObj[appStates[currentAppStateIndex]] = {};
                    setGlobal(`ALDTMP${appStates[currentAppStateIndex]}`, "");
                    tempTransQuery[appStates[currentAppStateIndex]] = "";
                }
            document.getElementById("warehouseName").innerHTML = staffName;
            document.querySelectorAll("#results>li.product.active").forEach(product => {
                product.classList.remove("processed");
            });

            query = "",
                warehouseName = staffName,
                sign_mult = "",
                sign_wholesale_remain = "",
                sign_retail_remain = "",
                newlink = "",
                prefix = "", iswholesale_purchaseText = "", ismult_text = "", iswholesale_purchase = false, isstock = false;
            document.querySelector("a.submitbutton").href = "";
            document.querySelector("a.submitbutton").classList.remove('btn-color-wholesale_sale');

            closeFilterDialog();
        }

        document.getElementById("warehouseName").innerHTML = warehouseName;
        /* disable clicks on link */
        document.querySelector("a").addEventListener("click", (e) => {
            e.preventDefault();
        });

        try {
            var ALRADADATE = day + " / " + month;
        } catch (e) { }

    }
    catch (e) {
        show("Main Err: " + e.stack, true, true);
    }
</script>