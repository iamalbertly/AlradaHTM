<style>
    * {
        vertical-align: baseline;
    }

    body {
        height: 100%;
        margin: 0;
        padding: 0;
        width: 99.708%;
        overflow: hidden;
    }

    small,
    #cachedTrans>span {
        font-size: xx-small;
        align-self: center;
    }

    .tunatumaMsg>*>*>.buttonholder {
        display: none;
    }

    li#confirmCachedEntry>div,
    li#confirmTransactionEntry>div {
        width: 90%;
        justify-content: space-between;
    }

    li#confirmCachedEntry>div>div {
        justify-content: space-between;
    }

    li#confirmCachedEntry>div>div>button {
        position: absolute;
        right: 0px;
        height: 20px;
        width: 30px;
        min-height: unset;
    }

    #loading-text>code>ul>li {
        overflow-x: auto;
        margin-right: 20px;
    }

    li#confirmCachedEntry>div>div>div>a,
    li#confirmTransactionEntry>span>a {
        text-wrap: nowrap;
        text-decoration: none;
        padding-right: 5px;
        width: 100%;
        background: none;
    }

    li#confirmCachedEntry>div>div>div>a {
        color: white;
    }

    span {
        font-weight: bolder;
    }

    li {
        margin-bottom: 1px
    }

    button {
        font-size: 11px;
        min-height: 100%;
        width: -webkit-fill-available;
    }

    body {
        height: 100%;
        margin: 0;
        padding: 0;
        width: 99.708%
    }

    sub {
        font-weight: 100;
        letter-spacing: 1px;
        text-decoration-line: none;
    }

    h2 {
        margin-block-start: 19px;
        margin-top: 0
    }

    #filter-dialog>div>li {
        border-bottom: 1px solid #a7a7a7;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        padding-left: 5px;
        padding-right: 5px
    }

    .flex-row,
    li {
        display: flex;
        flex-direction: row;
        margin-bottom: 5px
    }

    .half-row {
        display: flex;
        flex: 0 0 50% !important
    }

    .flex-column {
        display: flex;
        flex-direction: column
    }

    #results>li>a {
        font-size: 3vw;
        justify-content: center;
        margin: 0;
        width: 100%
    }

    a {
        text-decoration: none;
        border: none;
        display: flex;
        padding: 2px;
        color: inherit;
    }

    #appStates {
        border-top: 1px solid #000
    }

    #mywebview.wholesale_sale>* button>span,
    #productsview.wholesale_sale>* li>a>span {
        background-color: #00c853
    }

    #mywebview.wholesale_sale>#news_display>* .highlight-border {
        border-color: #00c853 !important
    }

    #mywebview.wholesale_purchase_delivered>* button>span,
    #productsview.wholesale_purchase_delivered>* li>a>span {
        background-color: #a200ff;
        color: #fff
    }

    #mywebview.wholesale_purchase_delivered>#news_display>* .highlight-border {
        border-color: #a200ff !important
    }

    #mywebview.wholesale_purchase>* button>span,
    #productsview.wholesale_purchase>* li>a>span {
        background-color: #ffc400;
        color: #000
    }

    #mywebview.wholesale_purchase>#news_display>* .highlight-border {
        border-color: #ffc400 !important
    }

    #mywebview.sent2_bank>div>* button>span,
    #productsview.sent2_bank>* li>a>span {
        background-color: #d50000
    }

    #mywebview.sent2_bank>#news_display>* .highlight-border {
        border-color: #d50000 !important
    }

    #mywebview.stocktake>div>* button>span,
    #productsview.stocktake>* li>a>span {
        background-color: #e1e1e1;
        color: #000
    }

    #mywebview.stocktake>#news_display>* .highlight-border {
        border-color: #e1e1e1 !important
    }

    #results>li>a {
        flex-flow: column;
        padding: 0 1%;
        place-content: space-between;
        text-decoration: none;
        white-space: nowrap
    }

    #results>li>a>span {
        align-self: stretch;
        background-color: #483d8b;
        color: #fffff0;
        font-size: small;
        margin-bottom: 0;
        pointer-events: none
    }

    #myinputbar input:focus,
    #results>li>a:hover,
    #results>li>a.pressed,
    #results>li>a:active,
    .processed,
    #filter-dialog>div>li.selected {
        background-color: #FAF9CB;
        border: 2px solid #a4a4a4;
        border-color: #000;
        opacity: 1 !important;
        padding-top: 0
    }

    #productsview>* li>a>input {
        display: none
    }

    #productsview>* li>a:hover>input,
    #productsview>* li>a:active>input,
    #productsview>* li>a.pressed>input {
        display: flex
    }

    li.product.hovering {
        margin: 0;
        order: -1;
        position: sticky;
        min-width: 60%;
        opacity: 1;
        top: 0px;
        z-index: 99;
    }

    li.product.alcohol {
        border: 2px solid red
    }

    .btn {
        align-items: center;
        background-color: var(--background-color);
        border: 1px solid var(--border-color);
        box-shadow: 0 .2rem .4rem #0006 0 -.3rem .6rem #0003 inset;
        color: var(--color);
        font-family: inherit;
        font-weight: 900;
        justify-content: center;
        padding: .6rem;
        position: relative;
        transition: box-shadow 64ms ease-out;
        --background-color: #d8d8d8;
        --border-color: #c7c7c7;
        --color: #000
    }

    .btn:after {
        background-color: #fff;
        content: "";
        filter: blur(0.15rem);
        height: 12.5%;
        left: 12.5%;
        position: absolute;
        top: .15rem;
        transition: opacity 64ms ease-out;
        width: 75%
    }

    .btn:active {
        box-shadow: 0 0 0 #0006 0 .4rem 1rem #0000004d inset
    }

    .btn:active:after {
        opacity: 0
    }

    .btn:hover {
        border: 1px solid #000;
    }

    .btn-color-wholesale_sale {
        --background-color: #00c853;
        --border-color: #00a243;
        --color: #fff
    }

    .btn-color-wholesale_sale:active {
        --color: #ececec
    }

    .btn-color-wholesale_purchase {
        --background-color: #ffc400;
        --border-color: #d9a700;
        --color: #3e2723
    }

    .btn-color-wholesale_purchase:active {
        --color: #261815
    }

    .btn-color-sent2_bank {
        --background-color: #d50000;
        --border-color: #af0000;
        --color: #fff
    }

    .btn-color-sent2_bank:active {
        --color: #ececec
    }

    .btn-color-wholesale_purchase_delivered {
        --background-color: #483d8b;
        --border-color: #544b89;
        --color: #fff
    }

    .btn-color-wholesale_purchase_delivered:active {
        --color: #ececec
    }

    .pressed,
    button:active {
        border-color: #817;
        box-shadow: inset 0 0 5px #a9a;
        color: #817;
        text-decoration: overline
    }

    #numberpadfunctions {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        width: 60px
    }

    #istax {
        color: #8b0000;
        display: none;
        font-weight: bolder
    }

    #submitbuttonholder>a {
        height: 61px
    }

    #submitbuttonholder>div {
        display: flex;
        flex-flow: row
    }

    #myinputbar {
        background: #fffaf0;
        justify-content: space-between;
        padding: 0 2px 0;
        position: sticky;
        top: 0;
        min-height: 35px;
    }

    #myinputbar>div {
        display: contents
    }

    #myinputbar>div>div {
        display: inline-flex;
        justify-content: flex-end
    }

    #myinputbar input {
        -moz-box-shadow: 0 -1px .1px 3px #0000003d inset;
        -webkit-box-shadow: 0 -1px .1px 3px #0000003d inset;
        border-left: none;
        border-right: none;
        border-top: none;
        box-shadow: 0 -1px .1px 3px #0000003d inset;
        font-weight: bolder;
        text-align: center;
        width: 100%
    }

    #myinputbar>div>input:active {
        background: bottom;
        border: 2px solid #000;
        border-color: #8b4513
    }

    #myinputbar * span {
        background: #f0f8ff;
        border: 1px solid #000;
        border-color: #deb887;
        font-size: 3VW;
        max-width: 20%;
        padding-left: 2px;
        padding-right: 2px;
        white-space: nowrap;
    }

    #search {
        width: 280% !important
    }

    #feedbackpack>button {
        height: 100%
    }

    .hidden,
    .disabled,
    .hiddenpreview,
    #feedbackpad {
        display: none !important;
        height: 0;
        visibility: hidden;
        width: 0
    }

    #resultpad {
        background: #f5f5f5;
        display: block;
        min-height: 120px;
        margin: 0;
        margin-top: 3px;
        overflow-x: clip;
        overflow-y: auto;
        padding: 2px;
        z-index: 0;
        position: relative;
    }

    #entries {
        text-align: left;
    }

    #result_display {
        font-family: monospace;
        height: 100%;
        padding-left: 3px;
        text-align: left;
        width: 100%
    }

    div#result_display>ul {
        padding-left: 0;
        align-items: baseline;
    }

    div#result_display>ul>li.total {
        position: sticky;
        bottom: 0;
        border-top: 1px solid #efefef;
        background-color: whitesmoke;
        width: 70%;
        font-weight: bold;
    }

    div#result_display>ul>li>span {
        min-width: 245px;
        align-items: baseline;
        font-weight: 100;
    }

    div#result_display>ul>li>div>button {
        border: none;
        background-color: transparent;
        margin-left: 10px;
    }

    div#result_display>ul>li>span>a {
        border-bottom: 1px solid burlywood;
        margin: 3px;
        border-top: 0px;
        background-color: transparent;
        text-decoration: solid;
        padding-top: none;
        font-weight: 100;
    }

    #mywebview2 {
        bottom: 0;
        height: 97%;
        margin: 0;
        padding: 0;
        width: 100%
    }

    .loading-content {
        z-index: 90;
    }

    #productsview {
        border: 1px solid #000;
        overflow-x: HIDDEN;
        overflow-y: auto;
        height: -webkit-fill-available;
        position: relative;
        z-index: 10;
    }

    #mysubmitbar,
    li.product>span {
        display: flex;
        place-content: space-between
    }

    #submitbuttonholder {
        width: -webkit-fill-available
    }

    #submitbuttonholder.hyper {
        bottom: 46%;
        left: 0;
        position: fixed;
        width: 98%
    }

    #myinputbar.hyper {
        max-height: 21px;
        min-width: 100%;
        position: relative;
    }

    #mywebview3>div>.righthalf>a.btn {
        height: 40%;
        padding: 1%
    }

    #results {
        display: flex;
        flex-wrap: wrap;
        top: 0;
        left: 0;
        padding: 0;
        margin: 0;
        list-style-type: none;
        overflow-x: clip;
        overflow-y: auto;
        position: sticky;
        max-height: 325px;
    }

    #results li {
        border: .2px solid #ccc;
        display: flex;
        flex: 1 0 auto;
        flex-basis: auto;
        flex-grow: 1;
        margin: 3px;
        margin-bottom: 6px;
    }

    @media (min-width: 100px) {
        #results li {
            flex-basis: calc(50% - 10px)
        }

        #results>li>a {
            font-size: 5vw;
            letter-spacing: 2px
        }

        #results>li>a>span {
            margin-top: 2px
        }
    }

    @media (min-width: 500px) {
        #results li {
            flex-basis: calc(33.33% - 10px)
        }

        #results>li>a {
            font-size: 3vw
        }
    }

    @media (min-width: 700px) {
        #results li {
            flex-basis: calc(25% - 10px)
        }
    }

    @media (min-width: 900px) {
        #results li {
            flex-basis: calc(20% - 10px)
        }
    }

    #filter-dialog,
    #processmsg-dialog,
    .mypopupdialog {
        background-color: #fff;
        border: 1px solid #ccc;
        box-shadow: 0 2px 5px #0003;
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        left: 50%;
        padding: 20px;
        position: fixed;
        top: 50%;
        transform: translate(-50%, -50%);
        width: fit-content;
        z-index: 90;
    }

    .mypopupdialog>* {
        display: flex;
        flex-direction: column;
        padding: 5px;
        padding-top: 10px;
    }

    .mypopupdialog>*>li>a {
        border: none;
        text-decoration: none;
    }

    .mypopupdialog>.buttonholder {
        display: flex;
        margin-top: 10px
    }

    .mypopupdialog>button {
        margin: 3px;
        position: absolute;
        right: 10px;
        top: 10px
    }

    #filter-categories {
        list-style: none;
        padding: 0
    }

    #filter-categories li {
        margin-bottom: 5px
    }

    #filter-categories input[type="checkbox"] {
        margin-left: 5px
    }

    li.product {
        display: none !important;
        width: fit-content;
        opacity: .55;
    }

    li.product.active {
        display: block !important
    }

    #mywebview3 {
        border: 2px solid #000;
        bottom: 0;
        display: flex;
        height: 22px;
        position: fixed;
        width: 99.4%
    }

    #cachedTrans {
        align-items: center;
        flex-basis: max-content;
        max-height: 20px
    }

    #cachedTrans>span {
        border-bottom: 1px solid #000;
        width: 100%
    }

    .notbutton,
    .notbutton>* {
        background-color: transparent !important;
        border: none
    }

    .loading-content {
        background-color: #000c;
        border-radius: 10px;
        color: #fff;
        display: flex;
        flex-direction: column;
        height: 60%;
        justify-content: space-around;
        left: 50%;
        padding: 10px;
        position: fixed;
        text-align: center;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 65%
    }

    #loading-text>code>ul {
        margin-left: 0;
        margin-top: 0;
        padding-left: 0;
        text-align: left;
    }

    #btnClose,
    #close-dialog {
        height: 20px;
        position: fixed;
        right: 1px;
        top: 1px;
        width: 20px;
        max-height: 25px;
        min-height: unset;
    }

    #cachedTrans>div>span.part1 {
        background: none;
        border-bottom: none;
        border-left: 1px solid #000;
        border-radius: 4px;
        border-right: 1px solid #000;
        border-top: none;
        font-size: revert;
        margin-left: 10px;
        padding-left: 4px;
        padding-right: 4px;
        width: max-content
    }

    #myModal {
        margin: auto;
        padding: 0;
        width: 80%;
    }

    #myModal>.editvalues {
        flex-direction: row;
        display: flex;
        position: relative;
        max-height: 25px;
        flex-wrap: wrap;
        padding-bottom: 20px;
        text-align: -webkit-left;
        justify-content: space-between;
    }

    #myModal>.editvalues>* {
        text-wrap: nowrap;
        margin: -3px;
        margin-left: 5px;
        margin-right: 5px;
        margin-top: 3px;
        text-align: center;
        background-color: white;
        color: black;
        width: max-content;
        padding-left: 4px;
        padding-right: 4px;
        font-stretch: ultra-condensed;
    }

    #myModal>.editvalues>.notyet {
        background-color: transparent;
        color: white;
        border: none;
    }

    #edit_multiplier {
        max-width: 60px;
    }

    #myModal>.editvalues>input.disabledfont {
        color: white;
    }

    #myModal>.buttonholder {
        margin-top: 10px;
    }

    .selectproduct {
        border: 1px solid gray;
        height: 200px;
        overflow-y: auto;
        flex-flow: wrap;
    }

    .selectproduct>li>a>input {
        display: none;
    }
</style>
<meta name="viewport" content="width=device-width, initial-scale=1">

<head>
    <link rel="shortcut icon" href="#">
</head>
<div id="mywebview" class="wholesale_sale" style="min-height:100%;display:block;">
    <div id="news_display"
        style="display: flex; flex-direction: row; text-wrap: nowrap; justify-content: space-between;height:40px">
        <button
            style="display: -webkit-inline-box;-webkit-box-align: center;width: fit-content;display: flex;background: center;align-items: center;">📆&nbsp;
            <div id="date" onclick="getShopDate()"></span>
                <script>var date = new Date(); var mydate = date.getDate() + "/" + eval(date.getMonth() + 1) + "/" + eval(date.getFullYear()); document.getElementById("date").innerHTML = mydate; </script>
            </div>
        </button>
        <div id="appStates" class="flex-column" style="width: 100%;"><button id="appState"
                class="highlight-border"><span>💰</span>MAUZO &nbsp; </button></div><button
            style="display: -webkit-inline-box;-webkit-box-align: center;width: 65px;display: flex;background: center;align-items: center;margin-top: .9px;"
            onclick="getwarehouseName()" id="warehouseName"></button>
    </div>
    <div id="mywebview2" class="flex-column">
        <div id="resultpad" class="flex-column">
            <div id="result_display">
                <ul></ul>
            </div>
        </div>
        <div id="myinputbar" class="flex-row"><input class="" type="text" id="search"
                placeholder="🔍 Tafuta Kinwaji" /><input disabled class="disabled highlight-border" type="number"
                id="inputnumber_change" placeholder="Lipa" value="" /><button id="filter" onclick="showFilterDialog()"
                class="functionpad">🎚️</button><button disabled id="btnSend2Cache"
                onClick="chooseToAddTransactionToCache(event)" class="functionpad disabled">➡️</button><button
                id="cachedTrans" class="flex-row notbutton">
                <div style="margin-top:-40px;min-width: 100px;">
                    <p class="hiddenpreview" STYLE="color: yellow;background-color: black!important;">BADO REPOTI <sub
                            style="white-space: nowrap;">👇🏽 HAIJATUMWA ! 👇🏽</sub></p><span
                        class="part2 highlight-border"
                        style="border:none;background: none;font-size: revert;">-</span><span
                        class="part1 highlight-border">-</span>
                </div>
            </button></div>
        <div id="productsview" class="wholesale_sale">
            <ul id="results"></ul>
        </div>
        <div class="flex-column">
            <div id="mysubmitbar" class="flex-row hidden">
                <div id="numberpadfunctions"><button id="istax" class="functionpad">T</button></div>
                <div id="submitbuttonholder"><a id="submitbutton" href='/#+'
                        style="flex-direction: column-reverse;justify-content: space-around;text-underline-position: under;"
                        class="submitbutton togglewholesale_sale btn"><label><span>💰</span>MAUZO
                            &nbsp;</label><label>Peleka</label></a></div>
            </div>
        </div>
    </div>
</div>
<div id="loading-screen" class="hidden">
    <div class="loading-content">
        <H2 id="loading-title" class="sr-only">Tafadhali Subiri</H2>
        <div class="spinner-border" role="status"><small id="loading-subtitle"></small></div>
        <div id="loading-text" class="loading-text"
            style="border-bottom: 1px solid whitesmoke;overflow-y: auto;height: min-content;max-height: 185px;">...
        </div>
        <div class="buttonholder" style="display:flex;flex-direction:row;margin-top:15px"></div>
    </div>
</div>
<div id="choose-mode" class="hidden mypopupdialog">
    <h2 id="selectmode">Select Mode</h2>
    <ul>
        <li><a href="#" onclick="changeMode('0')"><span>💰</span>MAUZO &nbsp;</a></li>
        <li><a href="#" onclick="changeMode('2')"><span>➕</span>UPOKEZI &nbsp;</a></li>
        <li><a href="#" onclick="changeMode('1')"><span>🤌🏽</span>MALIPO &nbsp;</a></li>
        <li><a href="#" onclick="changeMode('3')"><span>#️⃣</span>STOCK &nbsp;</a></li>
        <li class="hidden"><a href="#" onclick="changeMode('4')"><span>💱</span>MANUNUZI &nbsp;</a></li>
    </ul>
</div><input id="clipboard" class="hidden" value="Alrada" style="max-height:0px" placeholder="" title="clipboard" />
<div id="filter-dialog" class="hidden mypopupdialog"></div>
<div id="querydialog" class="hidden mypopupdialog" style="width:95%"><input id="query" title="query" placeholder=""
        type="text" style="width:100%" /></div>
<div id="processmsg-dialog" class="hidden mypopupdialog"></div>

<script>
    try {
        show("staff: " + staffName);
    }
    catch (e) { }

    if (typeof createScene === "function") { /* in tasker*/

    } else {
        function setGlobal(variableName = "", value = "") {

            const existingValue = localStorage.getItem(variableName);
            if (existingValue !== null) {
                if (existingValue !== value) {
                    localStorage.setItem(variableName, value);
                }
            } else {
                localStorage.setItem(variableName, value);
            }
        }

        function global(variableName = "", par2 = "") {
            var storedValue = localStorage.getItem(variableName);
            return (storedValue != null) ? storedValue : null;
        }
        function setClip(par1 = "", par2 = "") { }
        function flashLong(par1 = "", par2 = "") { }

    }


    function changeMode(index = "") {
        var oldstate = appStates[currentAppStateIndex];
        if (index == "") {
            currentAppStateIndex++;
        } else currentAppStateIndex = eval(index);

        var appStates_btn = document.querySelector("#appStates");
        appStates_btn.classList.remove(`btn-color-${oldstate}}`);

        document.querySelector("#productsview").className = "";

        var local_appstate = appStates[currentAppStateIndex];
        switch (local_appstate) {
            case "wholesale_sale":
                status_display = "<span>💰</span> MAUZO  &nbsp;";
                break;
            case "sent2_bank":
                status_display = "<span>🤌🏽</span> MALIPO  &nbsp;";
                break;
            case "wholesale_purchase_delivered":
                status_display = "<span>➕</span> UPOKEZI  &nbsp;";
                break;
            case "wholesale_purchase":
                status_display = "<span>💱</span> MANUNUZI  &nbsp;";
                break;
            case "stocktake":
                status_display = "<span>#️⃣</span> STOCK  &nbsp;";
                break;
            default:

        }
        document.querySelector("#mywebview").classList.value = "";
        document.querySelector("#mywebview").classList.add(local_appstate);
        document.querySelector("#productsview").classList.add(local_appstate);
        appStates_btn.classList.add("btn-color-" + local_appstate);
        document.querySelector("#appState").innerHTML = status_display;

        document.querySelector("#submitbutton").innerHTML = status_display + "<label>Peleka</label>";

        document.querySelector("#cachedTrans>div>.part1").innerHTML = ((!cachedTransCount[appStates[currentAppStateIndex]]) ? 0 : cachedTransCount[appStates[currentAppStateIndex]]);
        document.querySelector("#cachedTrans>div>.part2").innerHTML = ((!cachedTransCashTotal[appStates[currentAppStateIndex]]) ? 0 : cachedTransCashTotal[appStates[currentAppStateIndex]].toLocaleString('en-US').replace(/\.00/g, ""));
        clearvalues();
        createProductsView();
        closeFilterDialog();
    }

    const month = date.getMonth(),
        day = date.getDate(),
        hour = (date.getUTCHours() + 3),
        minute = date.getMinutes();

    let partOfDay;

    if (hour >= 5 && hour < 12) {
        partOfDay = "Asubuhi";
    } else if (hour >= 12 && hour < 18) {
        partOfDay = "Mchana";
    } else if (hour >= 18 && hour < 21) {
        partOfDay = "Jioni";
    } else {
        partOfDay = "Saa za Kufunga";
    }

    if (!String.prototype.replaceAll) {
        String.prototype.replaceAll = function (search, replacement) {
            return this.replace(new RegExp(search, 'g'), replacement);
        };
    }
    function wait(ms) {
        var start = new Date().getTime();
        var end = start;
        while (end < start + ms) {
            end = new Date().getTime();
        }
    }

    function show(msg, timer = false, clip = true, flash = true) {
        try {
            if (clip) setClip("show():" + msg, false);
            if (flash) flashLong(msg);
        } catch (e) { }
        if (timer) wait(5000);
        console.log("log: " + msg);
    }
    function goto(location) {
        /* if in tasker*/
        if (typeof createScene !== 'undefined') {
            window.location.href = location;
        } else {
            console.log("goto: " + location);
        }
    }

    const appStates = ['wholesale_sale', 'sent2_bank', 'wholesale_purchase_delivered', 'stocktake'];
    const appStateMarks = ['ӿ', '$', '++', '#'];
    let specialTransType = "", extraTransDetails = "",
        BreakException = {},
        isMultTextArray = {},
        products_jsonString = {},
        suppliers_jsonString = {},
        productsJsonString = undefined;
    currentAppStateIndex = 0,
        names = [],
        categories = {},
        ald_lstreply = "",
        writtenInSearch = "",
        editingquery = "",
        warehouseName = 'HQ',
        staffName = (typeof staffName == "undefined") ? "Al" : staffName;
    queryLog = "",
        responseClone = "",
        confirmAddReportToCache = function () { },
        confirmSendReportRightAway = function () { },
        confirmFormYes = function () { },
        confirmFormNo = function () { },
        confirmFormEdit = function () { },
        finalResponseMsg = "",
        newlink = "", inputnum = "", iswholesale_purchaseText = "", prefix = "";
    var currentFocusedProduct = "", oldFocusedProduct = "",
        cachedTransObjectString = [],
        cachedTransObjectJson = [],
        cachedTransCount = [],
        cachedTransCashTotal = [],
        cachedTempTrans2Process = [],
        cachedTransactionQueries = [],
        results = document.getElementById('results');
    function getwarehouseName() {
        warehouseName = prompt("Ingiza Jina la shop", "HQ");
        if (warehouseName != null) {
            document.getElementById("warehouseName").innerHTML = warehouseName;
        } else warehouseName = "HQ";
    }
    function getShopDate() {
        mydate = prompt("Ingiza Tarehe MFANO: 31/1/2025", document.getElementById("date").innerHTML.replaceAll("&nbsp;", ""));
        if (mydate != null) {
            document.getElementById("date").innerHTML = mydate;
        } else mydate = document.getElementById("date").innerHTML;
    }
    try {
        if (settingsObj != undefined) {
            loadCachedTrans();
            createProductsView();
        }
        else {
            if (global('ALDSETTING')) {
                var settingsObj = JSON.parse(global('ALDSETTING'));
                loadCachedTrans();
                createProductsView();
            }
            else
                fetch('https://raw.githubusercontent.com/iamalbertly/AlradaHTM/main/alradasettings.json')
                    .then(response => {
                        responseClone = response.clone();
                        if (!response.ok) {
                            responseClone.text()
                                .then(function (bodyText) {
                                    show("recieved the following: " + bodyText)
                                });
                            return response.text().then(text => {
                                throw new Error('Server response: ' + text, true, true);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        settingsObj = data;
                        setGlobal('ALDSETTING', JSON.stringify(settingsObj));
                        loadCachedTrans();
                        createProductsView();
                    })
                    .catch((error) => { });
        }

        if (global('ALRADAUSER'))
            staffName = global('ALRADAUSER');
        ald_lstreply = global('ALDLSTREPLY');

        staffName = (staffName == "") ? "XX" : staffName;
    } catch (e) {
        show("error laoding defaults: " + e.stack, true);
        ald_lstreply = ".* ,mauzo yako yana kadiriya ..... ...... ..... ..... ..... .... ...... ........";
    }

    function loadCachedTrans() {
        try {
            try {
                for (const TransType in appStates) {
                    if (global(`ALDCACHE${appStates[TransType]}`)) {
                        cachedTransactionQueries[appStates[TransType]] = global(`ALDCACHE${appStates[TransType]}`);
                        cachedTransCount[appStates[TransType]] = cachedTransactionQueries[appStates[TransType]].split("||").length;
                        queryLog = cachedTransactionQueries[appStates[TransType]];

                        cachedTransObjectString[appStates[TransType]] = GetProductDetails(queryLog);
                        cachedTransObjectJson[appStates[currentAppStateIndex]] = JSON.parse(cachedTransObjectString[appStates[TransType]]);

                        var total = /TOTAL:\sTZS\s(\d+,{0,1}\d+,{0,1}\d+,{0,1}\d+)/gm.exec(cachedTransObjectJson[appStates[currentAppStateIndex]].finalResponseMsg);

                        if (total != null) cachedTransCashTotal[appStates[TransType]] = eval((total.length > 0) ? eval(total[1].replaceAll(",", "")) : 0);
                    } else {
                        cachedTransCount[appStates[TransType]] = 0;
                        cachedTransCashTotal[appStates[TransType]] = 0;
                    }
                }

                document.querySelector("#cachedTrans>div>.part1").innerHTML = cachedTransCount[appStates[0]];
                document.querySelector("#cachedTrans>div>.part2").innerHTML = cachedTransCashTotal[appStates[0]];
                document.querySelectorAll(".hiddenpreview").forEach(el => {
                    el.classList.remove("hiddenpreview");
                    el.classList.add("shownpreview");
                });

            } catch (e) { show(`Error Loading CachedTrans loadCachedTrans(): ${e.stack}`) }
        } catch (e) { show("error loadCachedTrans::" + e.stack, true); }
        clearvalues();
    }

    function createList(products = names, prefix = "") {
        try {
            results.innerHTML = "";
            products.forEach(productLink => {
                results.innerHTML += productLink;
            });

            document.querySelectorAll("input").forEach(el => {
                el.addEventListener("click", () => el.value = "");
            });

            document.querySelectorAll("a.product").forEach(el => {
                el.addEventListener("click", (e) => {
                    document.querySelector("#myinputbar").classList.remove("hyper");
                });
                el.addEventListener("focus", (e) => {
                    var nm = e.srcElement.getAttribute("name");
                    if (nm != oldFocusedProduct && document.querySelector(`li.product[name='${oldFocusedProduct}']`)) {
                        document.querySelector(`li.product[name='${oldFocusedProduct}']`).classList.remove("hovering");
                    }

                    currentFocusedProduct = document.querySelector(`li.product[name='${nm}']`);
                    if (currentFocusedProduct) {
                        if (document.querySelector("li.product.hovering")) document.querySelector("li.product.hovering").classList.remove("hovering");
                        document.querySelector("#myinputbar").classList.remove("hyper");
                        closeFilterDialog();
                        currentFocusedProduct.classList.add("hovering");
                        document.querySelector("li.product[name='" + nm + "']>a>input").select();
                    }
                    currentFocusedProduct = nm;
                    oldFocusedProduct = nm;
                    document.querySelectorAll('a').forEach(el => {
                        el.classList.remove('pressed');
                    });
                    e.srcElement.classList.add('pressed');

                    document.querySelector("#myinputbar").classList.add("hyper");

                    const clickedvalue = e.srcElement.getAttribute('name');
                    const local_appstate = appStates[currentAppStateIndex];
                    const input = document.querySelector(".product.pressed > input:not(.hidden)");
                    isMultTextArray[clickedvalue] = input ? input.value : "";

                    const num = isMultTextArray[clickedvalue] || "1";
                    const newlink = clickedvalue + appStateMarks[currentAppStateIndex] + num;
                    document.getElementById("submitbutton").innerHTML = newlink;
                    document.getElementById("submitbutton").href = "/" + newlink;

                    input.focus();
                });
            });

            document.querySelectorAll(".product > input").forEach(input => {
                input.classList.remove("pressed");
                input.addEventListener('keyup', function (e) {
                    var thekey = e.key.toString();
                    var clickedvalue = e.srcElement.getAttribute("name");
                    if (e.key === 'Enter') {

                        document.getElementById("submitbutton").click();
                        document.getElementById("warehouseName").focus();
                    }
                });
            });
        } catch (e) {
            show(e.stack + " -- error creating list");
        }
    }

    function createProductsView() {
        const localAppState = appStates[currentAppStateIndex];
        if (!settingsObj) return;
        switch (localAppState) {
            case "wholesale_sale":
            case "wholesale_purchase":
            case "wholesale_purchase_delivered":
            case "stocktake": {
                products_jsonString = JSON.parse(settingsObj.settings.alradaitemnames).slice(1);

                products_jsonString.sort((a, b) => {
                    /* If b is "Pesa", put a before b */
                    if (/Pesa/g.test(b.OfficialName)) return -1;

                    /* If a is "Pesa", put b before a */
                    if (/Crate Peke|Fungu la Chupa|Pesa/g.test(a.OfficialName)) return 1;

                    /* Group closely matching OfficialNames together */
                    if (a.OfficialName.includes(b.OfficialName) || b.OfficialName.includes(a.OfficialName)) {
                        return 0;
                    }

                    if (a.category_breakdown < b.category_breakdown) return 1;
                    if (a.category_breakdown > b.category_breakdown) return -1;

                    if (b.laststocktakedate - a.laststocktakedate) {
                        return b.laststocktakedate - a.laststocktakedate;
                    }

                    if (b.theysaylaststocktakeamt - a.theysaylaststocktakeamt) {
                        return b.theysaylaststocktakeamt - a.theysaylaststocktakeamt;
                    }

                    return 0;
                });

                names = products_jsonString.map(product => {
                    const name = product.OfficialName;
                    const categorySign = getCategorySign(product.category_breakdown);
                    const categoryArr = product.category_breakdown.split("_");
                    const cat = categoryArr.join(" ");
                    const price = formatPrice(product.w_price_a, product.w_purchase_a);
                    return createProductLi(name, name.replaceAll(" ", "_").replaceAll("'", ''), cat, price, categorySign, localAppState);
                });
                break;
            }
            case "sent2_bank": {
                suppliers_jsonString = JSON.parse(settingsObj.settings.suppliers).slice(1);
                names = suppliers_jsonString.map(supplier => {
                    const name = supplier.officialname;
                    const contactName = supplier.contactname;
                    return createProductLi(name, name.replaceAll(" ", "_").replaceAll("'", ''), "", "", "", localAppState, contactName);
                });
                break;
            }
        }

        hideExistingInputs();
        createList(names, prefix);
        addInputEventListeners();
    }

    function getCategorySign(categoryBreakdown) {
        let categorySign = "";
        if (/alcohol/.test(categoryBreakdown)) {
            categorySign = "🔞";
        }
        if (/beer/.test(categoryBreakdown)) {
            categorySign = "   🍺 " + categorySign;
        }
        if (/liquar/.test(categoryBreakdown)) {
            categorySign = "  🥃  " + categorySign;
        }
        return categorySign;
    }

    function formatPrice(saleprice, purchaseprice) {
        if (appStates[currentAppStateIndex] == "wholesale_sale" || appStates[currentAppStateIndex] == "stocktake")
            return saleprice.toString().replace(/\d{1,3}(?=(\d{3})+(?!\d))/g, '$&,');
        else
            return purchaseprice.toString().replace(/\d{1,3}(?=(\d{3})+(?!\d))/g, '$&,');
    }

    function createProductLi(name, formattedname, category, price, categorySign, localAppState, contactName = "") {
        const inputType = localAppState === "wholesale_sale" ? "inputnumber" : "inputremaining";
        const inputTag = localAppState === "sent2_bank" ? contactName : price + " tsh";
        const inputId = `input${inputType}_${localAppState}_${formattedname}`;
        return `<li class="product active ${category}" data-category="${category}" name="${formattedname}">
            <a class="product ${category}" href="#" name="${formattedname}">
              ${productNameWithContact(name, contactName)}
              <span>${inputTag}<span class="classification">${categorySign}</span></span>
              <input type="number" id="${inputId}" name="${formattedname}" placeholder="#️⃣ Kiasi" value="" class="${inputType}" onClick="event.target.parentNode.dispatchEvent(new Event('focus'))" />
            </a>
          </li>`;
    }

    function productNameWithContact(name, contactName) {
        return contactName ? `${name} -${contactName}` : name;
    }

    function hideExistingInputs() {
        const existingInput = document.querySelector("a > input");
        existingInput?.classList.add("hidden");
    }

    function addInputEventListeners() {
        document.querySelectorAll("#myinputbar> input").forEach(input => {
            input.addEventListener("focus", e => {
                document.querySelector("#myinputbar").classList.add("hyper");
            });
            input.addEventListener("focusout", e => {
                document.querySelector("#myinputbar").classList.remove("hyper");
            });
        });
    }

    window.onload = function () {
        try {
            initializeListeners();
            createProductsView();
        } catch (e) {
            show(e.stack + "-- error trying to load");
        }
    };

    function sendCachedTrans(event) {
        var status = "";
        try {
            cachedTransCount[transactionType] = "Tunatuma Repoti";
            cachedTransCashTotal[transactionType] = "Subiri ..";
            document.querySelector("#btnSend2Cache").classList.add("disabled");
            document.querySelector("#btnSend2Cache").disabled = true;
            document.querySelector("#cachedTrans>div>.part1").innerHTML = cachedTransCount[transactionType];
            document.querySelector("#cachedTrans>div>.part2").innerHTML = cachedTransCashTotal[transactionType];

            if (window.location.href.indexOf("http://127.0.0.1:3000/") == -1) {
                status = global(`ALDSNDSTATUS${transactionType}`);
                if (status == "sending") {
                    show("Bado Repoti ya Mwisho Haijakamilika kwenda");
                    return;
                }
            }

            var transactionType = appStates[currentAppStateIndex];
            if (cachedTransactionQueries[transactionType] == 0) return;
            hideLoadingScreen();
            if (!JSON.parse(cachedTransObjectString[transactionType]).json_response) {
                show("Hujafadhi chochote...");
                return 0;
            };

            var json_response = JSON.parse(cachedTransObjectString[transactionType]).json_response;

            const timestampMilliseconds = (new Date()).getTime();
            const data = json_response.map(entry => [entry.transDate, staffName.slice(0, 2) + " " + entry.transMsg.replace(/\d{1,2}\/\d{1,2}\/\d{4}\s\d{1,2}:\d{1,2}\s/, ""), entry.transWarehouseName]);
            const values = JSON.stringify({ usr: staffName, data: data, time: timestampMilliseconds, cmd: "add_transaction" });
            if (window.location.href.indexOf("http://127.0.0.1:3000/") == -1) {
                setGlobal(`ALDSNDSTATUS${transactionType}`, 'sending');
            }
            const clipboard = document.querySelector("#clipboard");
            try {
                clipboard.value = values;
                clipboard.focus();
                navigator.clipboard.writeText(clipboard.value).then(function (x) {
                    showLoadingScreen("Tunatuma Repoti...", "<h1>♻️</h1>", "<span class='tunatumaMsg'>" + JSON.parse(cachedTransObjectString[transactionType]).finalResponseMsg.replaceAll(/(\=\s\d+\,{0,}\d+)(\s)/gm, "$1<br/>").replaceAll(/\@\d+\.{0,1}\d{0,}/gm, "").replaceAll(/(TOTAL.*)/gm, "<br/>$1") + "</span>");
                });
            } catch (e) {
                clipboard.focus();
                navigator.clipboard.writeText(clipboard.value).then(function (x) {
                    showLoadingScreen("Tunatuma Repoti...", "<h1>♻️</h1>", "<span class='tunatumaMsg'>" + JSON.parse(cachedTransObjectString[transactionType]).finalResponseMsg.replaceAll(/(\=\s\d+\,{0,}\d+)(\s)/gm, "$1<br/>").replaceAll(/\@\d+\.{0,1}\d{0,}/gm, "").replaceAll(/(TOTAL.*)/gm, "<br/>$1") + "</span>");
                });
            }
            const posturl = "https://script.google.com/macros/s/AKfycbwSjP9ufSbzleeYo14tM7tG_7so9MNie71F36J4MSJCzK2vT07efTeP_kKSSlE_56gX/exec";
            const params = new URLSearchParams(new URL(posturl).search);

            params.append('payload', values);
            const geturl = posturl + "?" + params;
            var options = {};
            if (typeof createScene == 'undefined') {
         /* not in tasker*/
                var finalurl = 'https://cors-proxy3.p.rapidapi.com/api';
                options = {
                    method: 'POST',
                    headers: {
                        'content-type': 'application/x-www-form-urlencoded',
                        'X-RapidAPI-Key': 'b885eb794emsh79a1af1e8dff803p1c9f71jsnf78274969f09',
                        'X-RapidAPI-Host': 'cors-proxy3.p.rapidapi.com'
                    },
                    body: new URLSearchParams({ 'my-url': geturl })
                };
            }
            else { /* inside Tasker*/
                var finalurl = geturl;
                options = {
                    method: 'GET',
                    headers: {
                        'content-type': 'application/json',
                        Origin: '*'
                    }
                };
                show("Server is sending Report...");
            }

            fetch(finalurl, options)
                .then(response => {
                    responseClone = response.clone();
                    if (!response.ok) {
                        return response.text().then(text => {
                            document.querySelector("#cachedTrans>div>.part1").innerHTML = cachedTransCount[transactionType];
                            document.querySelector("#cachedTrans>div>.part2").innerHTML = cachedTransCashTotal[transactionType];
                            throw new Error('ErrServer response: ' + text, false, true);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    clearvalues();
                    cachedTransObjectString[transactionType] = "";
                    cachedTransactionQueries[transactionType] = "";
                    cachedTransCount[transactionType] = 0;
                    cachedTransCashTotal[transactionType] = 0;
                    try {
                        document.querySelector("#btnSend2Cache").classList.remove("disabled");
                        document.querySelector("#btnSend2Cache").disabled = false;
                        document.querySelector("#cachedTrans>div>.part1").innerHTML = cachedTransCount[transactionType];
                        document.querySelector("#cachedTrans>div>.part2").innerHTML = cachedTransCashTotal[transactionType];
                    } catch (e) { }
                    setGlobal(`ALDCACHE${transactionType}`, cachedTransactionQueries[transactionType]); setGlobal(`ALDSNDSTATUS${transactionType}`, 'ready');
                    try {
                        responseClone.text()
                            .then(bodyText => {
                                show('txtServer responded: ' + bodyText, false, true, false);
                            });
                    } catch (e) {
                        document.querySelector("#cachedTrans>div>.part1").innerHTML = cachedTransCount[transactionType];
                        document.querySelector("#cachedTrans>div>.part2").innerHTML = cachedTransCashTotal[transactionType];
                        show(e.stack + "-there was an error");
                    }
                    show("Repoti Imetumwa...");
                    goto("command||beep");
                    createProductsView();

                })
                .catch((error) => {
                    if (error.message.includes('Failed to fetch')) {
                        if (window.location.href.indexOf("http://127.0.0.1:3000/") == -1) {
                            setGlobal(`ALDSNDSTATUS${transactionType}`, 'sending_failed');
                        }
                        show("Tatizo la Network. Cheki internet alafu Jaribu Tena. " + error.stack);
                    } else {
                        responseClone.text()
                            .then(bodyText => {
                                show('Server responded: ' + bodyText, false, true, false);
                            });
                    }
                });

            setTimeout(function () {
                hideLoadingScreen();

            }, 4000);
        }
        catch (e) {
            show(e.stack + "-an error");
        }
    }

    function handleCachedTransEvent(event) {
        if (!event || !event.target.id) return;
        var target = event.target,
            json_response = JSON.parse(cachedTransObjectString[appStates[currentAppStateIndex]]).json_response,
            id = eval(/_(\d+)/g.exec(target.id)[1]);
        if (json_response[id].transType == "sent2_bank")
            var old_mulitplier = json_response[id].priceTotal;
        else
            var old_mulitplier = (json_response[id].multiplier < 1) ? "." + (json_response[id].transCarton * json_response[id].multiplier) : json_response[id].multiplier;
        editingquery = `${json_response[id].transMsg}`;

        var ConfirmDialogContent = `<div id="myModal">
    <div class="editvalues showonlyadmin">
    <a href="#" class="notyet" id="edit_date">${json_response[id].transDate}</a>
    <a href="#" class="notyet" id="edit_shopname" >${json_response[id].transWarehouseName}</a>
    <a href="#" class="" id="edit_drinkname" onclick="reCreateProductSelectDialog()"  placeholder="" value="${json_response[id].rawproductname}">${json_response[id].rawproductname}</a>
    <span id="edit_multipliersign">${appStateMarks[currentAppStateIndex]}</span>
    <input type="text" id="edit_multiplier"  placeholder="${old_mulitplier}" value="${old_mulitplier}" />
        </div>
    <div class="buttonholder" style="display:flex">

    <button onclick="confirmFormYes()">🚮 ONDOA KABISA</button>`;

        if (appStates[currentAppStateIndex] == "wholesale_sale") ConfirmDialogContent += `<button onclick="confirmFormEdit('isLoan')">⚠️ DENI</button>`;

        ConfirmDialogContent += `<button onclick="confirmFormEdit()">🛠️ REKEBISHA MPYA</button>
    <button onclick="confirmFormNo()">👌🏽 USIBADILISHE</button></div>
  </div>
</div>`;
        confirmFormNo = function () {
            hideLoadingScreen();
        };

        confirmFormEdit = function (edit_mode = "default") {
            var mult_sign = appStateMarks[currentAppStateIndex];
            if (edit_mode == "isLoan") mult_sign = '-';

            var newquery = `${document.querySelector("#edit_date").value} (${document.querySelector("#edit_shopname").value})${document.querySelector("#edit_drinkname").innerHTML}${mult_sign}${document.querySelector("#edit_multiplier").value}`;
            var oldquery = cachedTransactionQueries[appStates[currentAppStateIndex]].replaceAll("(plus)", "+");

            queryLog = oldquery.replace(editingquery, newquery).replaceAll(/\.(\d+)$/gm, "p$1").trim();

            productdetails_string = GetProductDetails(queryLog);
            cachedTransObjectString[appStates[currentAppStateIndex]] = productdetails_string;
            cachedTransObjectJson[appStates[currentAppStateIndex]] = JSON.parse(productdetails_string);
            json_response = cachedTransObjectJson[appStates[currentAppStateIndex]].json_response;
            cachedTransactionQueries[appStates[currentAppStateIndex]] = cachedTransObjectJson[appStates[currentAppStateIndex]].finalQuery;
            cachedTransCashTotal[appStates[currentAppStateIndex]] = eval(cachedTransObjectJson[appStates[currentAppStateIndex]].finalResponseTotal);

            var result_display = cachedTransObjectJson[appStates[currentAppStateIndex]].finalResponseMsg;

            if (cachedTempTrans2Process[appStates[currentAppStateIndex]])
                if (cachedTempTrans2Process[appStates[currentAppStateIndex]].length <= 0)
                    document.querySelectorAll(".disabled").forEach(el => {
                        el.disabled = false;
                        el.classList.remove("disabled");
                        el.classList.add("enabled");
                    });

            if (cachedTransactionQueries[appStates[currentAppStateIndex]])
                if (cachedTransactionQueries[appStates[currentAppStateIndex]].length <= 0)
                    document.querySelectorAll(".hiddenpreview").forEach(el => {
                        el.classList.remove("hiddenpreview");
                        el.classList.add("shownpreview");
                    });

            document.querySelector("#cachedTrans>div>.part1").innerHTML = cachedTransCount[appStates[currentAppStateIndex]];
            document.querySelector("#cachedTrans>div>.part2").innerHTML = cachedTransCashTotal[appStates[currentAppStateIndex]].toLocaleString('en-US').replace(/\.00/g, "");


            setGlobal(`ALDCACHE${appStates[currentAppStateIndex]}`, cachedTransactionQueries[appStates[currentAppStateIndex]]);


            reCreateCacheCleanupForm();
        };

        showLoadingScreen(`🗑️ FUTA: <sub>${json_response[id].priceTotal.toLocaleString('en-US').replace(/\.00/g, "")}`, "", ConfirmDialogContent);

        confirmFormYes = function () {
            delete json_response[id];
            queryLog = "";
            for (const resp in json_response) {
                queryLog += `${json_response[resp].transMsg},`;
            }
            productdetails_string = GetProductDetails(queryLog);

            cachedTransObjectString[appStates[currentAppStateIndex]] = productdetails_string; cachedTransObjectJson[appStates[currentAppStateIndex]] = JSON.parse(productdetails_string);

            json_response = cachedTransObjectJson[appStates[currentAppStateIndex]].json_response;

            cachedTransactionQueries[appStates[currentAppStateIndex]] = cachedTransObjectJson[appStates[currentAppStateIndex]].finalQuery;
            cachedTransCashTotal[appStates[currentAppStateIndex]] = eval(cachedTransObjectJson[appStates[currentAppStateIndex]].finalResponseTotal);

            var result_display = cachedTransObjectJson[appStates[currentAppStateIndex]].finalResponseMsg;

            if (cachedTempTrans2Process[appStates[currentAppStateIndex]])
                if (cachedTempTrans2Process[appStates[currentAppStateIndex]].length <= 0)
                    document.querySelectorAll(".disabled").forEach(el => {
                        el.disabled = false;
                        el.classList.remove("disabled");
                        el.classList.add("enabled");
                    });

            if (cachedTransactionQueries[appStates[currentAppStateIndex]])
                if (cachedTransactionQueries[appStates[currentAppStateIndex]].length <= 0)
                    document.querySelectorAll(".hiddenpreview").forEach(el => {
                        el.classList.remove("hiddenpreview");
                        el.classList.add("shownpreview");
                    });

            document.querySelector("#cachedTrans>div>.part1").innerHTML = cachedTransCount[appStates[currentAppStateIndex]];
            document.querySelector("#cachedTrans>div>.part2").innerHTML = cachedTransCashTotal[appStates[currentAppStateIndex]].toLocaleString('en-US').replace(/\.00/g, "");


            setGlobal(`ALDCACHE${appStates[currentAppStateIndex]}`, cachedTransactionQueries[appStates[currentAppStateIndex]]);

            reCreateCacheCleanupForm();
        }
    }

    function reCreateProductSelectDialog(filter = "") {

        var dialogContent = `<h2 style="margin-bottom:10px">Chagua Product</h2><ul id="results" class="products selectproduct">`;
        for (const i in names) {
            dialogContent += names[i];
        }
        document.querySelector("#filter-dialog").innerHTML = dialogContent;
        document.querySelector("#filter-dialog").classList.remove("hidden");
        document.querySelectorAll("#results.selectproduct>li>a").forEach(el => {
            el.addEventListener("click", () => {
                var selectedproductname = el.name.replace("_", " ");
                document.querySelector("#edit_drinkname").innerHTML = selectedproductname;
                document.querySelector("#filter-dialog").classList.add("hidden");
            });
        });

    }

    function showLoadingScreen(loadingTitle, loadingSubTitle, loadingMsg) {
        hideLoadingScreen();
        document.getElementById("news_display").style.pointerEvents = "none"; document.getElementById("mywebview2").style.pointerEvents = "none";

        document.getElementById("loading-title").innerHTML = loadingTitle; document.getElementById("loading-subtitle").innerHTML = loadingSubTitle; document.getElementById("loading-text").innerHTML = loadingMsg;

        document.getElementById("loading-screen").classList.remove("hidden");
    }
    function hideLoadingScreen() {
        document.getElementById("news_display").style.pointerEvents = "";
        document.getElementById("mywebview2").style.pointerEvents = ""; document.getElementById("loading-title").innerHTML = "";
        document.getElementById("loading-subtitle").innerHTML = "";
        document.querySelector("#loading-screen .loading-content .buttonholder").innerHTML = "";
        document.getElementById("loading-text").innerHTML = "...";
        document.getElementById("loading-screen").classList.add("hidden");
    }


    function reCreateCacheCleanupForm() {
        document.getElementById("news_display").style.pointerEvents = "";
        document.getElementById("mywebview2").style.pointerEvents = "";
        document.getElementById("loading-screen").classList.add("hidden");


        var dialogContent = `<code><ul id="entries">`;
        for (const itemcount in cachedTransObjectJson[appStates[currentAppStateIndex]].json_response) {
            var row = cachedTransObjectJson[appStates[currentAppStateIndex]].json_response[itemcount];
            var displaymultiplier = /((\-\-|\+\+|#|=|\+|ӿ|-|\$)\d{0,}[p]{0,1}\d+)$/g.exec(row.transMsg)[1];
            dialogContent += `<li id="confirmCachedEntry" name="confirmCachedEntry_${itemcount}" >
       <div class="flex-column" >
        <span class="flex-row"><a href="#" id="confirmCachedEntry" name="TransactionEditDate_${itemcount}" title="${row.transDate}" onClick="handleTransEvent(event)">${row.transDate}</a>
        <a href="#" id="confirmCachedEntry" type="Jina La Shop" name="TransactionEditWarehouse_${itemcount}" title="${row.transWarehouseName}" onClick="handleTransEvent(event)">(${row.transWarehouseName})</a></span>
        <div class="flex-row"><div class="flex-row">
        <a href="#" id="confirmCachedEntry" name="TransactionEditDrinkName_${itemcount}" title="${row.rawproductname}" onClick="handleTransEvent(event)">${row.rawproductname}</a>
        <a href="#" id="confirmCachedEntry" name="TransactionEditUnitPrice_${itemcount}" rel="@" type="Kiasi" title="${row.unitprice}" onClick="handleTransEvent(event)">@${row.unitprice}</a>
        <a href="#" id="confirmCachedEntry" name="TransactionEditMultiplier_${itemcount}" title="${displaymultiplier.match(/\d+\.{0,1}\d{0,}/g)[0]}" onClick="handleTransEvent(event)" type="" rel="${appStateMarks[currentAppStateIndex]}">${displaymultiplier}=${row.priceTotal}</a></div>
       <button id="confirmCachedEntry" name="TransactionDelete_${itemcount}" onClick="handleTransEvent(event)">❌</button></div>
       </div></li>`;
        }
        dialogContent += `</ul></code>`;

        document.getElementById("loading-text").innerHTML = dialogContent;
        document.getElementById("loading-screen").classList.remove("hidden");
        document.querySelector("#loading-screen .loading-content .buttonholder").innerHTML = `<button onClick="hideLoadingScreen();clearvalues()" >Subiri</button><button onclick='sendCachedTrans()'>Tuma Repoti</button><button id='btnClose' onClick='hideLoadingScreen();clearvalues()'> X </button>`;
        document.getElementById("loading-title").innerHTML = `Angalia vizuri na Sahihisha ripoti,<br/><sub>kabla ya kutuma. ${JSON.parse(cachedTransObjectString[appStates[currentAppStateIndex]]).finalResponseTotal.toLocaleString('en-US').replace(/\.00/g, "")}</sub>`
    }

    function initializeListeners() {
        document.querySelector("#resultpad").addEventListener("click", (e) => {
            try {
                if ((document.querySelector("#result_display").innerHTML != "") && (document.querySelector("#filter-dialog").classList.contains("hidden") == false)) { }
                if (document.querySelector("a.product.pressed")) document.querySelector("a.product.pressed").parentNode.classList.remove("hovering");


                hideLoadingScreen();
                document.querySelector("#myinputbar").classList.remove("hyper");
            } catch (e) { show("error loadCachedTrans::" + e.stack, true); }
        });

        document.querySelector("#cachedTrans").addEventListener("click", e => {
            if (!cachedTransObjectString[appStates[currentAppStateIndex]]) {
                show("Huja fadhi chochote...");
                return 0;
            }

            reCreateCacheCleanupForm();

        });


        document.querySelector("a.submitbutton").addEventListener("click", e => {
            e.preventDefault();
            try { document.querySelector("a.product.pressed").parentNode.classList.remove("hovering"); } catch (e) { }

            if (currentFocusedProduct)
                try {

                    if (currentFocusedProduct == "MATUMIZI_MENGINE") {
                        var originalFocusedProduct = currentFocusedProduct;
                        extraTransDetails = prompt("Elezeya Malipo::", "");
                        if (extraTransDetails == null || extraTransDetails == "") {
                            throw new Error('Lazima Uingize Aina Ya Malipo ');
                        }
                        else { currentFocusedProduct = `${currentFocusedProduct}::${extraTransDetails.trim()}`; }
                        var query = currentFocusedProduct + "=" + document.querySelector(`a[name="${originalFocusedProduct}"]>input`).value;
                    } else
                        var query = currentFocusedProduct.replaceAll("_", " ") + appStateMarks[currentAppStateIndex] + document.querySelector(`a[name="${currentFocusedProduct}"]>input`).value;


                    if (!/\d+$/.test(query)) {
                        if ((appStates[currentAppStateIndex] == "stocktake"))
                            query += "0";
                        else {
                            if (/Kony|vant|Valu|Hanson/.test(query))
                                query += ".1";
                            else
                                query += "1";
                        }
                    }
                    if (appStates[currentAppStateIndex] != "stocktake") {
                        var firstpart = (/\d+\.\d+$/.test(query)) ? /(\d+)\.\d+$/.exec(query)[1] : "";
                        var secondpart = /\.\d+$/.test(query) ? /\.(\d+)$/.exec(query)[1] : "";
                        if (firstpart != "" && secondpart != "") {
                            var rg = new RegExp("[\+\+|\-|\+|\#|ӿ]" + firstpart + "." + secondpart, "g");
                            var adding = new RegExp("([\+\+|\-|\+|\#|ӿ])" + firstpart + "." + secondpart, "g").exec(query);
                            var prd = query.replaceAll(rg, "");
                            query = prd + adding[1] + firstpart + "," + prd + adding[1] + "." + secondpart
                        }
                    }
                    query = `(${warehouseName.toLowerCase()})${query}`;
                    date = new Date();

                    query = (mydate.replaceAll("&nbsp;", "").trim() + ` ${(date.getHours())}:${date.getMinutes()} ` + query.replaceAll(/\.(\d+)$/gm, "p$1")).trim(); if (appStates[currentAppStateIndex] == "stocktake") {
                        queryLog = queryLog.replaceAll(query + ",", "").concat(`,${query}`);

                    } else {
                        queryLog = queryLog.concat((`,${query},`).replace("undefined", "").replace(/\n/, "").trim());
                    }

                    productdetails_string = GetProductDetails(queryLog.replace(/^,/, ""));
                    productdetails_json = JSON.parse(productdetails_string);
                    queryLog = productdetails_json.finalQuery;
                    document.querySelector("#result_display>ul").innerHTML = productdetails_json.finalResponseMsg.replaceAll("\n", "<br/>");
                    document.querySelectorAll(".disabled").forEach(el => {
                        el.disabled = false;
                        el.classList.remove("disabled");
                        el.classList.add("enabled")
                    });
                    document.querySelector("#submitbuttonholder").classList.remove("hyper");
                    document.querySelector("#myinputbar").classList.remove("hyper");

                    if (appStates[currentAppStateIndex] == "stocktake") {
                        var el = "li.product[name='" + e.srcElement.pathname.replace("/", "") + "']";
                        document.querySelector(el).classList.add("hidden");
                    }
                    document.getElementById("warehouseName").focus();
                } catch (e) {
                    show(e.stack + " -there was an error" + e);
                }
        });

        document.getElementById('search').addEventListener('input', function () {
            var val = this.value;
            var filteredProducts = names.filter(function (product) {
                return product.toLowerCase().includes(val.toLowerCase());
            });
            createList(filteredProducts, prefix);
            writtenInSearch = this.value;
        });

        document.querySelector("#appState").addEventListener("click", e => {
            clearvalues();
            document.querySelector("#choose-mode").classList.remove("hidden");

            document.querySelectorAll("button").forEach(btn => {
                btn.classList.remove("pressed")
            });

            return false;
        });
        document.querySelector('#inputnumber_change').addEventListener('change', e => {
            var cashcollected = eval(e.srcElement.value);
            var total = /TOTAL:\sTZS\s(\d+,{0,1}\d+,{0,1}\d+,{0,1}\d+)/gm.exec(finalResponseMsg);
            if (total == null) return;
            total = (total.length > 0) ? total[1].replaceAll(",", "") : 0;
            var change = cashcollected - total;
            var currentresults = document.querySelector("#result_display").innerHTML.replace(/<br>----------<br>(.*)/gm, "");
            currentresults = currentresults + "<br/>----------<br/>PAID: " + cashcollected.toString().replace(/\d{1,3}(?=(\d{3})+(?!\d))/g, '$&,') + "<br/>----------<br/>CHANGE: " + change.toString().replace(/\d{1,3}(?=(\d{3})+(?!\d))/g, '$&,') + "<end/>";
            document.querySelector("#result_display").innerHTML = currentresults;
        });


        document.querySelector("#search").addEventListener("focus", (e) => {
            e.srcElement.value = "";
        });

        document.querySelector("#selectmode").addEventListener("click", e => {
            document.querySelector("#choose-mode").classList.add("hidden");
            document.querySelector("#querydialog").classList.remove("hidden");

            document.querySelector("#querydialog>input").focus();

        }); document.querySelector("#querydialog>input").addEventListener('keyup', function (e) {
            var thekey = e.key.toString();
            if (e.key === 'Enter') {

                var query = document.querySelector("#query").value;
                if (query == "") return 0;
                if (appStates[currentAppStateIndex] != "stocktake") {
                    var firstpart = (/\d+\.\d+$/.test(query)) ? /(\d+)\.\d+$/.exec(query)[1] : "";
                    var secondpart = /\.\d+$/.test(query) ? /\.(\d+)$/.exec(query)[1] : "";
                    if (firstpart != "" && secondpart != "") {
                        var rg = new RegExp("[\+\+|\-|\+|\#|ӿ]" + firstpart + "." + secondpart, "g");
                        var adding = new RegExp("([\+\+|\-|\+|\#|ӿ])" + firstpart + "." + secondpart, "g").exec(query);
                        var prd = query.replaceAll(rg, "");
                        query = prd + adding[1] + firstpart + "," + prd + adding[1] + "." + secondpart
                    }
                }
                query = `(${warehouseName.toLowerCase()})${query}`;
                date = new Date();

                query = (mydate.replaceAll("&nbsp;", "").trim() + ` ${(date.getHours())}:${date.getMinutes()} ` + query.replaceAll(/\.(\d+)$/gm, "p$1")).trim(); if (appStates[currentAppStateIndex] == "stocktake") {
                    queryLog = queryLog.replaceAll(query + ",", "").concat(`,${query}`);

                } else {
                    queryLog = queryLog.concat((`,${query},`).replace("undefined", "").replace(/\n/, "").trim());
                }

                productdetails_json = JSON.parse(GetProductDetails(queryLog.replace(/^,/, "")));
                queryLog = productdetails_json.finalQuery;
                document.querySelector("#result_display>ul").innerHTML = productdetails_json.finalResponseMsg.replaceAll("\n", "<br/>");
                document.querySelectorAll(".disabled").forEach(el => {
                    el.disabled = false;
                    el.classList.remove("disabled");
                    el.classList.add("enabled")
                });
                document.querySelector("#submitbuttonholder").classList.remove("hyper");
                document.querySelector("#myinputbar").classList.remove("hyper");

                document.querySelector("#querydialog").classList.add("hidden");

                document.getElementById("warehouseName").focus();

            }

        });
    }

    function chooseToAddTransactionToCache(event) {

        addTransactionToCache(event);

        reCreateCacheCleanupForm();


    }



    function addTransactionToCache(event) {
        if (cachedTransCashTotal[appStates[currentAppStateIndex]] == "Subiri ..") return;
        let target = event.target, currentQuery = productdetails_json.finalQuery;

        if (appStates[currentAppStateIndex] == "stocktake") {

            var isclosing = prompt(`Bonyeza ' OKAY ' KAMA NI StockTake yakuFUNGA (CLOSE) MAHESABU ya\n${mydate}\nBonyeza ' CANCEL ' kama ni yakuFUNGUA (OPEN) MAHESABU ${mydate}!`, mydate);
            if (isclosing == null) {
                var newdatetext = mydate.trim();
                currentQuery = currentQuery.replaceAll(/(\d+\/\d+[\/\d+]{0,5})/gm, `${newdatetext}`);
            }
            else if (isclosing.trim().toLocaleLowerCase().match(/\d{1,2}\/\d{1,2}\/.*/gm)) {
                var newdatetext = isclosing;
                currentQuery = currentQuery.replaceAll(/(\d+\/\d+[\/\d+]{0,5})/gm, `${newdatetext}`)

            }
            else if (isclosing.toLowerCase() == "ndio") {
                if (/(\d+\/\d+)[(\/\d+)]{0,5}/gm.exec(currentQuery))
                    var datetext = /(\d+\/\d+)[(\/\d+)]{0,5}/gm.exec(currentQuery)[0].trim();

                var dd = eval(/(\d+)\/\d+[(\/\d+)]{0,5}/gm.exec(datetext)[1]) + 1;
                currentQuery = currentQuery.replaceAll(/\d+(\/\d+[(\/\d+)]{0,5})/gm, `${dd}$1`);

            }
        }

        if (cachedTransactionQueries[appStates[currentAppStateIndex]] == undefined) {

            cachedTransactionQueries[appStates[currentAppStateIndex]] = currentQuery;
            cachedTransCount[appStates[currentAppStateIndex]] = 1;
            cachedTransObjectJson[appStates[currentAppStateIndex]] = productdetails_json;
            cachedTransObjectString[appStates[currentAppStateIndex]] = productdetails_string;
            cachedTransCashTotal[appStates[currentAppStateIndex]] = /TOTAL:\sTZS\s(\d+,{0,1}\d+,{0,1}\d+,{0,1}\d+)/gm.exec(productdetails_json.finalResponseMsg);

            if (cachedTransCashTotal[appStates[currentAppStateIndex]])
                cachedTransCashTotal[appStates[currentAppStateIndex]] = (cachedTransCashTotal[appStates[currentAppStateIndex]].length > 0) ? eval(cachedTransCashTotal[appStates[currentAppStateIndex]][1].replaceAll(",", "")) : 0;
            else cachedTransCashTotal[appStates[currentAppStateIndex]] = 0;

        } else {
            cachedTransactionQueries[appStates[currentAppStateIndex]] += ",||" + currentQuery;
            cachedTransCount[appStates[currentAppStateIndex]] = cachedTransactionQueries[appStates[currentAppStateIndex]].split("||").length;

            cachedTransObjectString[appStates[currentAppStateIndex]] = GetProductDetails(cachedTransactionQueries[appStates[currentAppStateIndex]]);

            cachedTransObjectJson[appStates[currentAppStateIndex]] = JSON.parse(cachedTransObjectString[appStates[currentAppStateIndex]]);

            var total = /TOTAL:\sTZS\s(\d+,{0,1}\d+,{0,1}\d+,{0,1}\d+)/gm.exec(cachedTransObjectJson[appStates[currentAppStateIndex]].finalResponseMsg);

            if (total != null) cachedTransCashTotal[appStates[currentAppStateIndex]] = ((total.length > 0) ? eval(total[1].replaceAll(",", "")) : 0);
        }

        document.querySelector("#cachedTrans>div>.part1").innerHTML = cachedTransCount[appStates[currentAppStateIndex]];
        document.querySelector("#cachedTrans>div>.part2").innerHTML = cachedTransCashTotal[appStates[currentAppStateIndex]];


        for (const TransType in cachedTransactionQueries) {
            var transaction = cachedTransactionQueries[TransType];
            setGlobal(`ALDCACHE${TransType}`, transaction)
        }


        document.querySelectorAll(".hiddenpreview").forEach(el => {
            el.classList.remove("hiddenpreview");
            el.classList.add("shownpreview");
        });
        clearvalues();


    }

    function createFilterDialogContent() {
        const npsValues = {};
        const runningSpeedRanges = {};
        products_jsonString.forEach(product => {
            const category = product.category_breakdown.split("_")[2].toLowerCase(); if (!categories[category]) {
                categories[category] = [];
            }
            if (!categories[category][product.OfficialName]) {
                categories[category][product.OfficialName] = [];
            }

            categories[category][product.OfficialName].push({
                name: product.OfficialName,
                classes: category.split(".").map(part => part.toLowerCase()).join(" ")
            });

            const financialnps = product.category_breakdown.split("_")[3];
            if (!npsValues[financialnps]) {
                npsValues[financialnps] = [];
            }
            npsValues[financialnps].push(product);

            const speed = (product.category_breakdown.split("_")[4]) ? product.category_breakdown.split("_")[4] : 0;
            if (!runningSpeedRanges[speed]) {
                runningSpeedRanges[speed] = [];
            }
            runningSpeedRanges[speed].push(product);
        });

        const dialogContent = document.createElement("div");
        dialogContent.innerHTML = `
    <h3>Vichujio:Aina ya kinywaji</h3>
        <ul>`;
        for (const category in categories) {
            dialogContent.innerHTML += `
      <li onClick="handleFilterDialogFilterSelection(event)">
        <label for="${category}">${category}</label>
        <input type="checkbox" id="category_${category}" >
      </li>`;
        }
        dialogContent.innerHTML += `
      </ul>
        <h4>VipaoMbele NPS</h4>
  <input type="range" min="0" max="10" id="financial_nps" value="0">
      `;
        dialogContent.innerHTML += `
      <h4>Kasi ya kukimbia</h4>
  <input type="range" id="speed" min="0" max="5"> </div>
     `;
        dialogContent.innerHTML += `
    `;

        dialogContent.innerHTML += `<button id="close-dialog" onClick="closeFilterDialog()"> X </button>`;
        return dialogContent;
    }


    function getRunningSpeedRange(speed) {

        if (speed <= 5) {
            return "Slow";
        } else if (speed <= 10) {
            return "Medium";
        } else {
            return "Fast";
        }
    }

    function showFilterDialog() {
        const dialog = document.getElementById("filter-dialog");
        if (dialog.children.length === 0) {
            dialog.appendChild(createFilterDialogContent());

            document.querySelectorAll("li.product.active").forEach(product => {
                product.classList.remove("active");
            });
        }
        dialog.classList.remove("hidden");
    }

    function handleTransEvent(event) {
        var target = event.target,
            action = target.name.split("_"),
            family = target.id;
        id = eval(action[1]),
            action = action[0],
            oldval = target.title,
            type = target.type,
            sign = target.rel,
            dialog = document.querySelector("#filter-dialog"),
            content = "";
        if (family == "confirmCachedEntry") {
            var json_transactions = JSON.parse(cachedTransObjectString[appStates[currentAppStateIndex]]);
        }
        else if (family == "confirmTransactionEntry") {
            var json_transactions = productdetails_json;
        }
        var oldquery = json_transactions.finalQuery,
            editing = `${json_transactions.json_response[id].transMsg}`;

        switch (action) {
            case "TransactionEditDrinkName":
                content = `<h2 style="margin-bottom:10px">Chagua Product</h2><ul id="results" class="products selectproduct">`;
                for (const i in names) {
                    content += names[i];
                }
                dialog.innerHTML = content;
                document.querySelectorAll("#results.selectproduct>li>a").forEach(el => {
                    el.addEventListener("click", () => {
                        var newval = el.name.replaceAll("_", " "),
                            newediting = editing.replace(oldval, newval).replace(/@\d+\.{0,1}\d{0,}/, ""),
                            newquery = oldquery.replace(editing, newediting),
                            newjson_transactions = JSON.parse(GetProductDetails(newquery));
                        if (family == "confirmCachedEntry") {
                            cachedTransObjectString[appStates[currentAppStateIndex]] = JSON.stringify(newjson_transactions);
                            cachedTransactionQueries[appStates[currentAppStateIndex]] = newjson_transactions.finalQuery;
                            cachedTransCashTotal[appStates[currentAppStateIndex]] = eval(newjson_transactions.finalResponseTotal);

                            if (cachedTempTrans2Process[appStates[currentAppStateIndex]])
                                if (cachedTempTrans2Process[appStates[currentAppStateIndex]].length <= 0)
                                    document.querySelectorAll(".disabled").forEach(el => {
                                        el.disabled = false;
                                        el.classList.remove("disabled");
                                        el.classList.add("enabled");
                                    });
                            if (cachedTransactionQueries[appStates[currentAppStateIndex]])
                                if (cachedTransactionQueries[appStates[currentAppStateIndex]].length <= 0)
                                    document.querySelectorAll(".hiddenpreview").forEach(el => {
                                        el.classList.remove("hiddenpreview");
                                        el.classList.add("shownpreview");
                                    });

                            document.querySelector("#cachedTrans>div>.part1").innerHTML = cachedTransCount[appStates[currentAppStateIndex]];
                            document.querySelector("#cachedTrans>div>.part2").innerHTML = cachedTransCashTotal[appStates[currentAppStateIndex]].toLocaleString('en-US').replace(/\.00/g, "");


                            setGlobal(`ALDCACHE${appStates[currentAppStateIndex]}`, cachedTransactionQueries[appStates[currentAppStateIndex]]);

                            reCreateCacheCleanupForm();
                        }
                        else if (family == "confirmTransactionEntry") {
                            productdetails_json = newjson_transactions;
                            document.querySelector("#result_display>ul").innerHTML = productdetails_json.finalResponseMsg.replaceAll("\n", "<br/>");
                            document.querySelectorAll(".disabled").forEach(el => {
                                el.disabled = false;
                                el.classList.remove("disabled");
                                el.classList.add("enabled");
                            });

                            document.querySelector("#submitbuttonholder").classList.remove("hyper");
                            document.querySelector("#myinputbar").classList.remove("hyper");
                            queryLog = productdetails_json.finalQuery;
                        }
                        closeFilterDialog();
                    });
                });
                showFilterDialog();
                break;
            case "TransactionEditMultiplier":
            case "TransactionEditUnitPrice":
            case "TransactionEditWarehouse":
                content = `<h3>Ingiza ${type} (${oldval}) </h3><div><input name="" placeholder="${oldval}" type="${(action == "TransactionEditWarehouse") ? `text` : `number`}  " onkeyup="confirmFormEdit(event)"/></div>`;
                dialog.innerHTML = content;
                confirmFormEdit = function (e) {
                    if (e.key != "Enter") return;

                    var newval = document.querySelector("#filter-dialog>div>input").value;
                    var newediting = editing.replace(sign + oldval, sign + newval);
                    var newquery = oldquery.replace(editing, newediting);
                    var newjson_transactions = JSON.parse(GetProductDetails(newquery));
                    if (family == "confirmCachedEntry") {
                        cachedTransObjectJson[appStates[currentAppStateIndex]] = newjson_transactions;
                        cachedTransObjectString[appStates[currentAppStateIndex]] = JSON.stringify(newjson_transactions);
                        cachedTransactionQueries[appStates[currentAppStateIndex]] = newjson_transactions.finalQuery;
                        cachedTransCashTotal[appStates[currentAppStateIndex]] = eval(newjson_transactions.finalResponseTotal);

                        if (cachedTempTrans2Process[appStates[currentAppStateIndex]])
                            if (cachedTempTrans2Process[appStates[currentAppStateIndex]].length <= 0)
                                document.querySelectorAll(".disabled").forEach(el => {
                                    el.disabled = false;
                                    el.classList.remove("disabled");
                                    el.classList.add("enabled");
                                });
                        if (cachedTransactionQueries[appStates[currentAppStateIndex]])
                            if (cachedTransactionQueries[appStates[currentAppStateIndex]].length <= 0)
                                document.querySelectorAll(".hiddenpreview").forEach(el => {
                                    el.classList.remove("hiddenpreview");
                                    el.classList.add("shownpreview");
                                });

                        document.querySelector("#cachedTrans>div>.part1").innerHTML = cachedTransCount[appStates[currentAppStateIndex]];
                        document.querySelector("#cachedTrans>div>.part2").innerHTML = cachedTransCashTotal[appStates[currentAppStateIndex]].toLocaleString('en-US').replace(/\.00/g, "");


                        setGlobal(`ALDCACHE${appStates[currentAppStateIndex]}`, cachedTransactionQueries[appStates[currentAppStateIndex]]);

                        closeFilterDialog();

                        reCreateCacheCleanupForm();
                    } else {
                        document.querySelector("#result_display>ul").innerHTML = newjson_transactions.finalResponseMsg.replaceAll("\n", "<br/>");
                        document.querySelectorAll(".disabled").forEach(el => {
                            el.disabled = false;
                            el.classList.remove("disabled");
                            el.classList.add("enabled");
                        });
                        closeFilterDialog();

                        document.querySelector("#submitbuttonholder").classList.remove("hyper");
                        document.querySelector("#myinputbar").classList.remove("hyper");
                        queryLog = newjson_transactions.finalQuery;
                    }
                };
                showFilterDialog();
                break;
            case "TransactionDelete":
                var newquery = oldquery.replace(editing, "").replace(/,$/, "").replace(/^,/, "");
                var newjson_transactions = JSON.parse(GetProductDetails(newquery));
                productdetails_json = newjson_transactions;
                if (family == "confirmTransactionEntry") {
                    document.querySelector("#result_display>ul").innerHTML = newjson_transactions.finalResponseMsg.replaceAll("\n", "<br/>");
                    document.querySelectorAll(".disabled").forEach(el => {
                        el.disabled = false;
                        el.classList.remove("disabled");
                        el.classList.add("enabled")
                    });
                    document.querySelector("#submitbuttonholder").classList.remove("hyper");
                    document.querySelector("#myinputbar").classList.remove("hyper");
                    queryLog = newjson_transactions.finalQuery;
                }
                else if (family = "confirmCachedEntry") {
                    cachedTransObjectString[appStates[currentAppStateIndex]] = JSON.stringify(newjson_transactions);
                    cachedTransObjectJson[appStates[currentAppStateIndex]] = newjson_transactions;
                    cachedTransactionQueries[appStates[currentAppStateIndex]] = newjson_transactions.finalQuery;
                    cachedTransCashTotal[appStates[currentAppStateIndex]] = eval(newjson_transactions.finalResponseTotal);

                    if (cachedTempTrans2Process[appStates[currentAppStateIndex]])
                        if (cachedTempTrans2Process[appStates[currentAppStateIndex]].length <= 0)
                            document.querySelectorAll(".disabled").forEach(el => {
                                el.disabled = false;
                                el.classList.remove("disabled");
                                el.classList.add("enabled");
                            });
                    if (cachedTransactionQueries[appStates[currentAppStateIndex]])
                        if (cachedTransactionQueries[appStates[currentAppStateIndex]].length <= 0)
                            document.querySelectorAll(".hiddenpreview").forEach(el => {
                                el.classList.remove("hiddenpreview");
                                el.classList.add("shownpreview");
                            });

                    document.querySelector("#cachedTrans>div>.part1").innerHTML = cachedTransCount[appStates[currentAppStateIndex]];
                    document.querySelector("#cachedTrans>div>.part2").innerHTML = cachedTransCashTotal[appStates[currentAppStateIndex]].toLocaleString('en-US').replace(/\.00/g, "");


                    setGlobal(`ALDCACHE${appStates[currentAppStateIndex]}`, cachedTransactionQueries[appStates[currentAppStateIndex]]);

                    reCreateCacheCleanupForm();
                }
                break;

            default:
                break;
        }
        createProductsView();

        try { document.querySelector("#filter-dialog>div>input").focus(); } catch (e) { }

    }
    function handleFilterDialogFilterSelection(event) {
        let target = event.target;
        if (target.localName == "li") {
            target = target.firstElementChild;
        } else if (target.localName == "label") {
            target = target.previousElementSibling;
        }
        if (target.type != "checkbox") return;

        const filterType = target.id;
        const products = document.querySelectorAll("li.product");

        const matchingProducts = [];
        if (filterType.startsWith("category")) {

            const category = filterType.split("_")[1];
            for (const product of products) {

                let checking = product.dataset.category.split(" ")[2];
                if (checking == category) {
                    if (product.classList.contains("active")) {
                        product.classList.remove("active");
                        target.checked = false;
                        target.parentNode.classList.remove("selected");
                    } else {
                        product.classList.add("active");
                        target.parentNode.classList.add("selected");
                        target.checked = true;
                    }
                }
            }
        } else if (filterType === "financial_nps") {
            const financialNps = eval(target.value);
            products.forEach(product => {
                const productNps = eval(product.dataset.financialNps);
                if (productNps >= financialNps) {
                    matchingProducts.push(product);
                }
            });
        } else if (filterType === "speed") {

            const speed = eval(target.value);
            products.forEach(product => {
                const productSpeed = eval(product.dataset.speed);
                if (productSpeed >= speed) {
                    matchingProducts.push(product);
                }
            });
        }
        closeFilterDialog();
    }

    function closeFilterDialog() {
        const dialog = document.querySelectorAll(".mypopupdialog").forEach(el => {
            if (!el.classList.contains("hidden"))
                el.classList.add("hidden");
        });
    }

    function GetProductDetails(query = "(hq)Uhai 600ml @400+1", exactdtail = "") {
        var response = "", itemcount = 1, projectedProfitTotal = 0;
        query = query.replace(/\(plus\)/gm, "+").replace(/,$/, "").replaceAll(/\|\|/gm, "").replace(/^,/, "").trim();

        if (typeof returntype == 'undefined') var returntype = "single";
        let rowmsg = "";

        if (settingsObj.settings.alradaitemnames == undefined) throw new Error("settingsObj.settings.alradaitemnames is undefined");
        settingsObj.settings.alradaitemnames = settingsObj.settings.alradaitemnames.replace(/(?:\[r,p]\n|\[r,p]|\n)/g, "<br>").replace(/\sTZS/g, "");

        var data = JSON.parse(settingsObj.settings.alradaitemnames);
        var headerRow = Object.keys(data[0]);
        var body = data.map(row => Object.values(row));


        var dataHeadings = [], dataBody = [];
        headerRow.forEach(function (title) {
            dataHeadings.push(title);
        });
        body.forEach(function (res) {
            dataBody.push(res);
        });
        var data = dataBody.map((arr, i) => Object.assign({}, ...dataHeadings.map((head, j) => ({ [head]: arr[j] }))));
        var asjson = JSON.stringify(data);
        var cleanasjson = asjson.replace(/(?:\r\n|\r|\n)/g, "<br>").replace(/\sTZS/g, "");

        if (typeof query !== "string") { query = new String(query); }
        var howmanyitems = query.split(new RegExp("(\\s\\&\\s)|,\\s|,|\\sn\\s")).filter((n) => n);

        let total = 0, remain = "", wholesale_remain = "", retail_remain = "", multiplier = "", rawproductname = "", projectedProfit = 0, responseArr = [];

        howmanyitems.some(function (product, n) {

            var priceTotal = 0, netpriceTotal = 0, pricetype = "",
                unitprice = (/\@\d+/.test(product)) ? eval(product.match(/\@\d+\.{0,1}\d{0,}/)[0].replace("@", "")) : "",
                getendvalue = /(\+{1,2}|\-{1,2}|ӿ|\-|\#)\d{0,}\s{0,1}[r,p]{0,1}\d+\.{0,1}\d{0,}$|[r,p]\d+\.{0,1}\d{0,}$/.test(product) ? /(\+{1,2}|\-{1,2}|ӿ|\-|\#)\d{0,}\s{0,1}[r,p]{0,1}\d+$|[r,p]\d+$/.exec(product)[0] : "",
                myval = getendvalue.match(/[ӿ,\+,\-,\#](\d+)/),
                whole_multiplier = (/[ӿ,\#,\+,\-][r,p]\d+\.{0,1}\d{0,}/.test(product)) ? 0 : (/[ӿ,\+,\-,\#]\d{0,}p{0,1}\d+$/.test(product)) ? eval(getendvalue.match(/[ӿ,\+,\-,\#](\d+\.{0,1}\d{0,})/)[1]) : 1,
                retail_multiplier = 0, transCarton = "";
            var getmultipliers = getendvalue.split(" ");

            getmultipliers = getmultipliers[0];
            if (/(\d+\/\d+)[(\/\d+)]{0,5}/gm.exec(product))
                var datetext = /(\d+\/\d+)[(\/\d+)]{0,5}/gm.exec(product)[0].trim();
            else { datetext = ALRADADATE }
            if (/\d+\/\d+[\/\d+]{0,5}\s(.*)\(/gm.exec(product))
                var timetext = /\d+\/\d+[\/\d+]{0,5}\s(.*)\(/gm.exec(product)[1].trim();
            else var timetext = "00:00";
            rawproductname = product.replace(/(\d+\/\d+)[(\/\d+)]{0,5}/gm, "").replace(/(\d+ +[r,p] +|^[r,p] +|^\d+ +|^\d+|[ӿ,\+,\$]\d+$)/g, "").replace(/#\d{0,}[r,p]{0,1}\d+|\#\d+$|[\+,\$]\d+|[\-\-,\+\+]/, "").replace(/\#\d+/, "").replace(/@\d+\.{0,1}\d{0,}/g, "").replace(/^t +| +0 +/, "").replace(/^[r,p] +|\s[r,p]\d+\.{0,1}\d{0,}$/g, "").replace(/^.*(\(.*)/g, "$1").trim();
            rawproductname = rawproductname.replace(/^[r,p] +/g, "").replace(/\s#\d+|ӿp{0,1}\d+\.{0,1}\d{0,}/, "");
            rawproductname = rawproductname.replace(/\s[r,p]\d+\.{0,1}\d{0,}|\+[r,p]\d+\.{0,1}\d{0,}v$/, "");
            rawproductname = rawproductname.replace(/=\d+\.{0,1}\d{0,}|[r,p]\d+\.{0,1}\d{0,}$/, "").replace(/^\(.*\)/, "").replace(/\+$/, "").trim();

            if (!/\$\d+$/.test(product)) {
                if (pricetype == "" || pricetype == undefined)
                    pricetype = (/\=\d|\+\+/g.test(product.trim())) ? "purchase" : /(\d\s[r,p]\s)|(\s[r,p]\s)|(^r\s)|([r,p]\d+$)/g.test(product.trim().toLowerCase())
                        ? "retail"
                        : "wholesale";
                try {
                    if (/\=\d+/g.test(product)) {
                        unitprice = 1;
                        priceTotal = eval(/\=(\d+)/g.exec(product)[1]),
                            displaymultiplier = priceTotal;
                    }
                    else
                        JSON.parse(cleanasjson).some(function (item, i) {

                            if (new RegExp(rawproductname.toLowerCase()).test(item.DrinkName.toLowerCase())) {
                                transCarton = item.carton;

                                if (getendvalue.match(/\#/)) {
                                    w_remain = (/\#\d+/g.test(getendvalue)) ? eval(getendvalue.match(/\#\d+/)[0].replace("#", "")) : 0;
                                    r_remain = (!/[r,p]\d+/g.test(getendvalue)) ? "" : eval(/[r,p](\d+)/g.exec(getendvalue)[1]) / item.carton;
                                    remain = w_remain + r_remain;
                                }

                                retail_multiplier = (getendvalue.indexOf("p") == -1) ? 0 : eval(getendvalue.match(/[r,p]\d+/)[0].replace("p", ""));
                                multiplier = whole_multiplier + (retail_multiplier / item.carton);

                                if ((appStates[currentAppStateIndex] == "wholesale_purchase_delivered") || (appStates[currentAppStateIndex] == "stocktake")) {
                                    var profitfromwholesale = ((item.w_price_a * whole_multiplier) - ((item.w_purchase_a * whole_multiplier)));
                                    var profitfromretail = ((item.p_price_a * retail_multiplier) - (((item.w_purchase_a / item.carton) * retail_multiplier)));
                                    projectedProfit = ((item.w_price_a * whole_multiplier) - ((item.w_purchase_a * whole_multiplier))) + profitfromretail;
                                }
                                if (unitprice == "") {
                                    if (pricetype == "purchase") {
                                        if (whole_multiplier)
                                            unitprice = item.w_purchase_a,
                                                priceTotal += item.w_purchase_a * whole_multiplier;
                                        if (retail_multiplier)
                                            unitprice = Math.round((((unitprice == "") ? (item.w_purchase_a + item.p_purchasemarkup_a) : unitprice) / item.carton) * 100) / 100,
                                                priceTotal += unitprice * retail_multiplier;

                                    }
                                    else {
                                        if (whole_multiplier || whole_multiplier == 0)
                                            unitprice = item.w_price_a,
                                                priceTotal += item.w_price_a * whole_multiplier;

                                        if (retail_multiplier)
                                            unitprice = ((unitprice == "") ? item.w_price_a : unitprice) / item.carton,
                                                priceTotal += unitprice * retail_multiplier;
                                    }
                                    product = product.replace(new RegExp(`(${getendvalue.replaceAll(/(\+)/gm, "\\$1")})`), `@${unitprice}$1`);
                                } else {
                                    if (whole_multiplier)
                                        priceTotal = unitprice * whole_multiplier;
                                    if (retail_multiplier)
                                        priceTotal += unitprice * retail_multiplier;
                                    product = product.replace(new RegExp(`(\@\d+\.{0,1}\d{0,})`), `@${unitprice}`);
                                }

                                throw BreakException;
                            }
                        });
                } catch (e) {
                    if (e !== BreakException) throw e;
                }
                var realitemcount = itemcount - 1;

                var realeditmultipliersign = (displaymultiplier == undefined) ? "=" : displaymultiplier;
                var displaymultiplier = ((whole_multiplier > 0) ? whole_multiplier : 0) + ((retail_multiplier > 0) ? `p${retail_multiplier}` : "");

                rowmsg = rowmsg + datetext + "::" + product.replace(/^\d+/g, '').trim() + "::" + multiplier + "÷÷";

                total = total + parseFloat(priceTotal);

                projectedProfitTotal += parseFloat(projectedProfit);
                if (priceTotal == "") {
                    priceTotal = (priceTotal == "") ? ((/.*=\d+/.test(rawproductname)) ? rawproductname.match(/\d+$/)[0] : 0) : 0;
                }

                let transDate = `${datetext} ${timetext}`,
                    transMsg = product;
                transUnitPrice = unitprice,
                    transWarehouseName = /\((.*)\)/gm.test(product) ? /\((.*)\)/gm.exec(product)[1].toLowerCase() : warehouseName.toLowerCase(),
                    transStaffID = staffName.slice(0, 2),
                    transType = (specialTransType == "") ? appStates[currentAppStateIndex] : specialTransType;
                getendvalue = (getendvalue) ? getendvalue : "";


                response = `${response} <li id="confirmTransactionEntry" name="confirmTransactionEntry_${realitemcount}" >`;
                response += `<div class="flex-row"><div class="flex-row"><small>${itemcount}.</small><a id="confirmTransactionEntry" href="#" name="TransactionEditDrinkName_${realitemcount}" title="${rawproductname}" onClick="handleTransEvent(event)" > ${rawproductname} </a>`;
                response += `<a id="confirmTransactionEntry" href="#" name="TransactionEditUnitPrice_${realitemcount}" rel="@" type="Kiasi" title="${unitprice}" onClick="handleTransEvent(event)"> @${unitprice}</a>`;
                response += `<a id="confirmTransactionEntry" href="#" name="TransactionEditMultiplier_${realitemcount}" rel="${appStateMarks[currentAppStateIndex]}" title="${displaymultiplier}" onClick="handleTransEvent(event)">${appStateMarks[currentAppStateIndex]}${displaymultiplier} = ${priceTotal.toLocaleString('en-US').replace(/\.00/g, "").trim()} </a>`;
                response += `<small><a id="confirmTransactionEntry" href="#" name="TransactionEditWarehouse_${realitemcount}" title="${transWarehouseName}" type="Jina La Shop" onClick="handleTransEvent(event)">&nbsp;${(transWarehouseName != "hq") ? transWarehouseName : "&nbsp;"}</a></small></div>`;
                response += `<div class="buttonholder flex-row"><button id="confirmTransactionEntry" name="TransactionDelete_${realitemcount}" onClick="handleTransEvent(event)">❌</button></div></div></li>`;

                responseArr.push({ transDate, transWarehouseName, transMsg, getendvalue, rawproductname, transUnitPrice, transStaffID, transType, rawproductname, remain, multiplier, transCarton, unitprice, priceTotal, netpriceTotal });
                itemcount++;
                unitprice = "";

            }
            if ((responseArr.length == 0) || (/\$\d+$/.test(product))) {
                remain = (/\#\d+/.test(product)) ? parseFloat(product.match(/\#\d+/)[0].replace("#", "")) : 0;
                unitprice = 1;
                var rx = new RegExp("\\" + appStateMarks[currentAppStateIndex] + "\\d+");

                multiplier = (rx.test(product)) ? parseFloat(product.match(rx)[0].replace(appStateMarks[currentAppStateIndex], "")) : 1;
                priceTotal = (/\=\d+/.test(product)) ? parseFloat(product.match(/\=\d+/)[0].replace("=", "")) * -1 : multiplier * unitprice;
                netpriceTotal = 0;

                total = total + priceTotal;
                response = (response + ((rawproductname == "") ? rawproductname : rawproductname) + ((unitprice > 0 && unitprice != "" && unitprice != 1) ? "@" + unitprice : "") + " | " + priceTotal.toLocaleString('en-US').replace(/\.00/g, "")).trim() + "\n";
                date = new Date();
                let transDate = `${datetext} ${timetext}`,
                    transMsg = product;
                transUnitPrice = unitprice,
                    transStaffID = staffName.slice(0, 2),
                    transType = (specialTransType == "") ? appStates[currentAppStateIndex] : specialTransType,
                    transWarehouseName = /\((.*)\)/gm.test(product) ? /\((.*)\)/gm.exec(product)[1].toLowerCase() : warehouseName.toLowerCase(),
                    transCarton = 0;
                getendvalue = (getendvalue) ? getendvalue : "";
                responseArr.push({ transDate, transWarehouseName, transMsg, rawproductname, getendvalue, transUnitPrice, transStaffID, transType, transWarehouseName, remain, multiplier, transCarton, unitprice, priceTotal, netpriceTotal });
            }

            try {
                var sele = 'li.product[name=\"' + rawproductname.replaceAll(" ", "_") + '\"]';
                document.querySelector(sele).classList.add("processed");
            } catch (e) { }
        });

        finalResponseMsg = `${response}\n<li class="total">TOTAL: ` + total.toLocaleString('en-US', {
            style: 'currency',
            currency: 'tzs'
        }).replace(/\.00/g, "") + " " + ((projectedProfitTotal == "") ? "\n" : ` <small>&nbsp;(prf: ${projectedProfitTotal.toLocaleString('en-US').replace(/\.00/g, "")})</small>  </li>\n`);

        var newquery = "";
        for (const val in responseArr) {
            newquery += `,${responseArr[val].transMsg}`;
        }
        newquery = newquery.replace(/^,/, "");
        return JSON.stringify({ json_response: responseArr, finalResponseMsg: finalResponseMsg, finalResponseTotal: total, finalQuery: newquery });
    }

    function clearvalues() {
        document.title = "Alrada Duka";
        document.querySelector("#search").value = "";
        document.querySelector("#result_display>ul").innerHTML = "";
        document.querySelectorAll(".enabled").forEach(el => {
            el.disabled = false;
            el.classList.remove("enabled");
            el.classList.add("disabled");
        });
        document.querySelector("#warehouseName").innerHTML = "HQ";
        document.querySelectorAll("#results>li.product.active").forEach(product => {
            product.classList.remove("processed");
        });

        productdetails_string = "",
            productdetails_json = [],
            query = "", queryLog = "",
            href = "undefined+",
            sign_mult = "",
            sign_wholesale_remain = "",
            sign_retail_remain = "",
            newlink = "",
            prefix = "", iswholesale_purchaseText = "", ismult_text = "", iswholesale_purchase = false, isstock = false;
        document.querySelector("a.submitbutton").href = "";
        document.querySelector("a.submitbutton").innerHTML = "PELEKA";
        document.querySelector("a.submitbutton").classList.remove('btn-color-wholesale_sale');

        closeFilterDialog();
    }


    document.querySelector("#warehouseName").innerHTML = warehouseName;
    /* disable clicks on link */
    document.querySelector("a").addEventListener("click", (e) => {
        e.preventDefault();
    });

    try {
        var ALRADADATE = day + " / " + month;
    } catch (e) { }
</script>